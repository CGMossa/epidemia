---
title: "Implementation"
output:
  bookdown::html_document2:
    theme: flatly
    number_sections: true
link-citations: yes
bibliography: ../inst/REFERENCES.bib
pkgdown:
  as_is: true
---

<style>
.contents .page-header {
    display: none;
} 
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



<div class = "article_container">

#  Overview {#sec:overview}

Here we give a high-level overview of the workflow required for defining and fitting a model with 
**epidemia**. The primary model fitting function is `epim()`. This takes a model description and 
additional arguments relating to the fitting algorithm, and proceeds to fit the model using a 
precompiled Stan program. This allows model fitting to begin immediately as opposed to requiring compilation each time 
`epim()` is called. 

This is similar to the workflow for fitting Bayesian regression models 
with **rstanarm**. A key difference, however, is that the models fit by **epidemia** are much more 
complex, and are therefore inherently more difficult to specify. **epidemia** aims to simplify this process 
by modularising the model definition into three distinct parts: transmission, 
infections and observations. These components of the model are defined with the functions `epirt()`, `epiinf()` and 
`epiobs()` respectively.

We begin by describing `epim()` in more detail, and then proceed to discuss the three modeling functions. 
**epidemia** contains an example dataset `EuropeCovid` which contains, among other things, data 
on daily death counts from Covid19 in 11 European Countries from February through May 2020. This is 
used as a running example throughout this article.

```{r load-packages, message=FALSE}
library(dplyr)
library(epidemia)
library(rstanarm)
data("EuropeCovid")
```

# Model Fitting

`epim()` is the only model fitting function in **epidemia**. It has arguments `rt`, `inf`, and `obs` which 
expect a description of the transmission model, infection model and all observational models respectively. 
Together, these fully define the joint distribution of data and parameters. Each of these model components are 
described in terms of variables that are expected to live in a single dataframe, `data`. This dataframe 
must be compatible with the model components, in the sense that it includes all variables defined in these 
models. The `data` argument is described in more detail in Section \@ref(sec:data). All arguments for 
`epim()` are described in Table \@ref(tab:epim-args).

```{r epim-args, echo=FALSE}
arguments <- c(
    "`rt`",
    "`inf`",
    "`obs`",
    "`data`",
    "`algorithm`",
    "`group_subset`",
    "`prior_PD`",
    "..."
)

description <- c(
    paste0("An object of class `\"epirt\"`, resulting from a call to `epirt()`. This defines the model for ",
    "reproduction numbers $R$."),
    paste0("An object of class `\"epiinf\"`, resulting from a call to `epiinf()`. This entirely defines ",
    "the model for infections $i_t$.)"),
    paste0("Either an object of class `\"epiobs\"`, or a list of such objects. ",
       "Each element of the list defined a model for an observed variable."),
    paste0("A dataframe with all data required for fitting the model. This includes all observation ",
    "variables and covariates specified in the models for the reproduction number and ascertainment rates."),
    paste0("One of `\"sampling\"`, `\"meanfield\"` or `\"fullrank\"`. This determines the rstan sampling ",
    "function to use for fitting the model. `\"sampling\"` corresponds to an adaptive HMC sampler, while ",
    "`\"meanfield\"` and `\"fullrank\"` are both Variational Bayes algorithms."),
    "If specified, a character vector naming a subset of regions to include in the model.",
    paste0("Same as in `rstan::stan_glm`. If `TRUE`, samples all parameters from their prior distributions. This is ",
    "useful for prior predictive checks. Defaults to `FALSE`."),
    paste0("Additional arguments to pass to the `rstan` function used to fit the model. If ", 
           "`algorithm = \"sampling\"`, then this function is `rstan::sampling`. Otherwise `rstan::vb is used`.", 
           "Please see the documentation for these functions.")
)
df <- data.frame(Argument = arguments, Description = description)
knitr::kable(df, caption = "Formal arguments for `epim()`", booktabs=TRUE)
```

In general, the adaptive Hamiltonian Monte Carlo sampler provided by `rstan` should be used for final 
inference. This can be used by specifying `algorithm = "sampling`. Nonetheless, fitting these models 
using HMC is often computationally demanding, and variational Bayes can be used for quickly iterating 
models. This can be done, for example, by setting `algorithm = "fullrank"`.

# Transmission

`epirt()` defines the model for reproduction numbers over time, as described in 
Section X. The `formula` can include fixed effects, random effects and autocorrelation 
terms. The left hand side takes the form `R(group, date)`, where `group` and 
`date` refer to variables representing the region and date respectively. This 
is syntactic sugar to make explicit that we are modeling the time-varying reproduction 
numbers. The right-hand-side consists of a series of terms separated by the 
`+` operator. Variables that are partially pooled can be distinguished by the `|` operator.

A viable model for our example is the following.
```{r epirt-example}
rt <- epirt(
  R(country, date) ~ (1 + lockdown | country) + schools_universities + public_events,
  link = scaled_logit(7)
)
```
The first term on the right hand side of the formula is the syntax expected for 
partially pooled terms. Here, this is interpreted as giving each country its 
own $R_0$ and effect of `lockdown`, and these parameters share a common prior. 
The effect size for `schools_universities` and `public_events` are fully pooled; 
i.e. the effect of these NPIs is assumed the same across all countries.

The interpretation of partially pooled terms is the same in `**epidemia**` as they 
are in `**rstanarm**`. We recommed reading the `**rstanarm**` vignette [Hierarchical Partial Pooling for Repeated Binary Trials
](https://mc-stan.org/rstanarm/articles/pooling.html) and the `**lme4**` vignette 
[Fitting Linear Mixed-Effects Models using **lme4**](https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf) to 
gain greater intuition over partial pooling/random effects in R formulas.

Here, we have not explicitly set the prior distributions for terms in the formula,
but this can be doen using the `prior`, `prior_intercept` and `prior_covariance` arguments.


```{r epirt-args, echo=FALSE}
arguments <- c(
    "`formula`", 
    "`link`", 
    "`center`", 
    "`prior`", 
    "`prior_intercept`", 
    "`prior_covariance`")

description <- c(
    paste0(
    "An object of class `\"formula\"` which determines the linear predictor $\\eta$ for $R$. ", 
    "The left hand side must take the form `R(group_col, date_col)`, where `group_col` and `date_col` are ",
    "column names in the data frame passed as the `data` argument to `epirt()`. `group_col` must be ",
    "a factor vector indicating group membership (i.e. country, state, age cohort), and `date_col` must ",
    "be a vector of class `\"Date\"`. This is syntactic sugar for the reproduction number in the given group at the give date."),
    "The link function $g$. Can be `\"log\"`, `\"identity\"` or a call to `scaled_logit()`. Defaults to `log`.",
    paste0("If `TRUE`, covariates in `formula` are centered to have mean zero. All priors should then be ",
    "interpreted as priors on the centered covariates."),
    paste0("Same as in `rstanarm::stan_glm`.  Defines the prior on $\\beta$. ",
    "**rstanarm** provided [priors](http://mc-stan.org/rstanarm/reference/priors.html), a `shifted_gamma` can be used. **Note** ",
"if `autoscale=TRUE` in the call to the prior function, then automatic rescaling takes place."),
    "Same as in `rstanarm::stan_glm`. Prior for the regression intercept $\\beta_0$ (if it exists).",
    paste0("Same as in `rstanarm::stan_glmer`. Defines the prior on the covariance matrix ",
    "$\\Sigma$. Only use if the `formula` has one or more terms  of the form `(x | y)`, ",
    "in which case there are parameters to partially pool, i.e. $b$ has positive length.")
)

df <- data.frame(Argument = arguments, Description = description)
knitr::kable(df, caption = "Formal arguments for `epirt()`", booktabs=TRUE)
```

# Infections

The infection process is defined by `epiinf()`. This gives the generation distribution

```{r epiinf-args, echo=FALSE}
arguments <- c(
    "`seed_days`",
    "`gen`",
    "`prior_tau`",
    "`latent`",
    "`family`",
    "`prior_aux`",
    "`pop_adjust`",
    "`susceptibles`"
)

description <- c(
    "An integer giving the number of seed days $v + 1$. Defaults to 6L.",
    paste0("A numeric vector giving the probability mass function $g_k$ of the generation distribution. ",
    "Must be a simplex vector, i.e. nonnegative and summing to 1."),
    paste0("Prior distribution for the hyperparameter $\\tau$, which is the mean of the prior ",
    "distribution for infection seeding. Defaults to `**rstanarm**::exponential(0.03)`."),
    "If `TRUE`, treat infections as latent parameters using the extensions described in Section XXX. ",
    "Specifies the family for $p(i'_t, d)$. Only used if `latent = TRUE`, and currently restricted to `log-normal`.",
    "Prior on the coefficient of variation $d$.",
    "If `TRUE`, applies a population adjustment to the infection process $i_t$. Defaults to `FALSE`.",
    paste0("A character vector giving the name of the column in the dataframe passed as the `data` argument of `epim`, that ",
    "corresponds to the susceptible population over time. Only used if `pop_adjust=TRUE`.")
)

df <- data.frame(Argument = arguments, Description = description)
knitr::kable(df, caption = "Formal arguments for `epiinf()`", booktabs=TRUE)
```

# Observations

```{r epiobs-args, echo = FALSE}
arguments <- c(
    "`formula`",
    "`i2o`",
    "`family`",
    "`link`",
    "`center`, `prior`, `prior_intercept`",
    "`prior_aux`",
    "`...`"
)

description <- c(
    paste0("An object of class `\"formula\"` which determines the linear predictor for the ",
    "ascertainment rate for a particular observation vector. The left hand side must take ",
    "the form `obs_col(group_col, date_col)`, which is syntactic sugar for the observation ",
    "in a given country on a given date. `obs_col` refers to the column of observations in ",
    "the dataframe passed as the `data` argument to `epim()` which is to be modeled. `group_col` ",
    "and `date_col` must be the same as those used in the call to `epirt()`."),
    paste0("A numeric (simplex) vector defining the probability mass function $\\pi_k$ of the ",
    "time distribution from infection to observation."),
    paste0("A string representing the family of the sampling distribution $p(y_t,\\phi)$. Can be ",
    "one of `\"poisson\"`, `\"neg_binom\"`, `\"quasi_poisson\"`, `\"normal\"` or `\"log_normal\"`."),
    paste0("A string representing the link function used to transform the linear predictor. Can be ",
    "one of `\"logit\"`, `\"probit\"`, `\"cauchit\"`, `\"cloglog\"`, `\"identity\"`. Defaults to `\"logit\"`."),
    "same as in `epirt()`, described above.",
    paste0("The prior distribution for the auxiliary parameter $\\phi$, if it exists. ",
    "Only used if family is `\"neg_binom\"` (reciprocal dispersion), `\"quasi_poisson\"` (dispersion), ",
    "`\"normal\"` (standard deviation) or `\"log_normal\"` (sigma parameter)."),
    "Additional arguments for `model.frame`."
)
df <- data.frame(Argument = arguments, Description = description)
knitr::kable(df, caption = "Formal arguments for `epiobs()`", booktabs=TRUE)
```


# Data {#sec:data}

Recall that the `data` argument to `epim()` must contain all variables used in the transmission, infection and 
observational models. For our example, 
this looks like 
```{r covid-data}
data <- EuropeCovid$data
data
```
The `columns` country and `date` define the region and time period corresponding to each of the remaining 
variables. `epim()` assumes that the first seeding day (i.e. the start of the epidemic) in each region 
is the first date found in the dataframe. The last date is the final date at which the epidemic is 
simulated for the group. It is up to the user to appropriately choose these dates. For our example,
the first and last dates for each group can be seen as follows.
```{r covid-data-dates}
summarise(data, start = min(date), end = max(date))
```
We chose the start date as 30 days prior to observing 10 cumulative deaths in each country.



</div class = "article_container">
