---
title: "Flexible Epidemic Modeling with epidemia"
output:
  bookdown::html_document2:
    theme: cerulean
link-citations: yes
pkgdown:
  as_is: true
fig_width: 9 
fig_height: 6
bibliography: ../inst/REFERENCES.bib
vignette: |
  %\VignetteIndexEntry{Introduction to epidemia} 
  %\VignetteEngine{knitr::rmarkdown} 
  \usepackage[utf8]{inputenc}
---

<style type="text/css">
body{ /* Normal */
font-size: 16px;
}
td { /* Table */
font-size: 14px;
}
h1.title {
font-size: 38px;
color: Black;
}
h1 { /* Header 1 */
font-size: 28px;
color: Black;
}
h2 { /* Header 2 */
font-size: 22px;
color: DarkBlue;
}
h3 { /* Header 3 */
font-size: 18px;
color: DarkBlue;
}
}
h3 { /* Header 4 */
font-size: 16px;
color: DarkBlue;
}
h4 { /* Header 4 */
font-size: 16px;
color: DarkBlue;
}
code.r{ /* Code block */
font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
font-size: 14px;
}
</style>

**Note:** *This vignette is a work in progress, and will be regularly updated.*

**epidemia** is an R-package for fitting Bayesian epidemic models in the style of @Flaxman2020. Here we detail these models and give users enough information to start fitting them independently.

The document is organized as follows. Section \@ref(example-usage) provides basic examples with minimal description, so that users can quickly get a feel for the package. Section \@ref(model-overview) gives a formal framework for the models within the scope of the package. Understanding this framework is essential for making the most of the flexibility offered by **epidemia**. Section \@ref(r-implementation) discusses the details of `epim`; the primary model fitting function in the package. `epim` is designed to be flexible, and therefore has a number of arguments. This can be intimidating, so we describe these arguments in a lot of detail. Finally Section \@ref(a-more-complete-example) highlights some of the more useful features of the package.

**epidemia** contains an example dataset `EuropeCovid`, which contains data on the daily deaths from Covid-19 recorded in 11 European countries. This will be used as a running example throughout the vignette.

```{r message=FALSE}
library(epidemia)
data("EuropeCovid")
options(mc.cores = parallel::detectCores())
```

The line `options(mc.cores = parallel::detectCores())` is important if MCMC sampling is used, as it allows different chains to be run in parallel, rather than sequentially.


# Example Usage
Here we provide code snippets showing basic usage of **epidemia**. Below considers fitting a model to the Italian data, and demonstrates usage of various arguments to `epim`.
```{r computeItaly, cache=TRUE}
# collect arguments for 'epim'
args <- EuropeCovid
args$algorithm <- "sampling"
args$sampling_args <- list(iter=1e3,control=list(adapt_delta=0.95,max_treedepth=15),seed=12345)
args$group_subset <- c("Italy")
args$formula <- R(country,date) ~  1 + lockdown
args$prior <- rstanarm::normal(location=0,scale=.5)
args$prior_intercept <- rstanarm::normal(location=0,scale=2)
fit <- do.call("epim", args)

```
```{r plotItaly, fig.height=9, fig.align="center"}
library(gridExtra)
grid.arrange(plot_obs(fit, type="deaths"), plot_infections(fit), plot_rt(fit),nrow=3)
```

Often we would like to model more than one population. Here is an example of using multiple populations, where the regression for the time-varying reproduction number includes a country-specific intercept. This could also be extended to group specific slopes; for example by using `(1 + lockdown | country)` in place of `(1 | country)` in `args$formula` below.

```{r computeIU, cache=TRUE}
# collect arguments for 'epim'
args$group_subset <- c("Italy", "United_Kingdom")
args$formula <- R(country,date) ~  0 + (1|country) + lockdown
args$prior_covariance <- rstanarm::decov(scale=0.1) 
fit <- do.call("epim", args)
```
```{r plotIU,results='hold',fig.align="center", fig.width=12}
plot_obs(fit, type = "deaths")
plot_rt(fit)
```

# Model Overview

@Flaxman2020 introduced a hierarchical Bayesian approach for epidemic modeling, and applied it to assessing the effect of non-pharmaceutical interventions on the covid-19 pandemic in 11 European countries. **epidemia** is designed to fit models which are largely extensions of this approach. There are however important differences which will be emphasized as we go along. The model is first described as it applies to a single population. Extensions to multiple populations are considered in the subsequent section.

## A Single Population

Let $t_0$ be an integer representing the first date at which we start modelling the epidemc, and let $T$ be the number of consecutive days over which to simulate the epidemic.

The basic idea behind the model is that the observed quantities (daily deaths, incidence rates etc.) are a function of the latent infections in the population over time. These infections are in turn a function of the *time-varying reproduction number* $R_t$. This number may be explained by a number of covariates; for example non-pharmaceutical interventions, or changes in mobility over time.

The remainder of this section is organized as follows. First, the model for the sequence of time-varying reproduction numbers is described. Infections are then modeled in terms of this sequence. Finally, the observed data is modeled as a function of these latent infections. 

### Latent Time-Varying Reproduction Number 

Let $R_{0},\ldots,R_{T}$ be a non-negative time series representing the *unadjusted* time-varying reproduction number over the period considered. Intuitively, $R_t$ is a measure of the intensity of infectious interactions occurring in the population at time $t_0 + t$. The term *unadjusted* is used to make explicit that $R_t$ is not interpreted as the rate of infection at a given point in time. This would require an adjustment for the size of the susceptible population. This adjustment is made later in the model for infections. $R_t$ is modeled as
\begin{equation}
R_t = 2A f\left(X_t^{'}\beta + W_t \right),
(\#eq:rt)
\end{equation}
where $A$ is a constant, $X_t$ is a $p$-dimensional set of regressors, and $f$ is the standard logistic function. Note that \@ref(eq:rt) implies that $R_t$ cannot be greater than $2A$. Therefore $A$ must be chosen carefully to ensure a plausible upper-bound for the series.

In the most general case, $W_t$ is the sum of independent random walks whose increments may occur at different time indices. Therefore 
\begin{equation}
W_t := \sum_{k=1}^{K} W^{(k)}_{t'_k},
\end{equation}
and each $t'_k = t'_k(t)$ may transform the time index. As an example, to model a weekly random walk $t'_k(t)$ would be the week corresponding to date $t_0+t$. The individual walks each satisfy
\begin{equation}
    W_{t'}^{(k)} = W_{t'-1}^{(k)} + \epsilon^{(k)}_{t'},
\end{equation}
where $\epsilon^{(k)}_{t'} \sim N(0, \sigma_k^2)$. Each $\sigma_k$ is given and independent half normal prior, such that $\sigma_k = |X|$ where $X \sim N(0, \sigma^0_k)$ for a given hyperparameter $\sigma^0_k > 0$.

The parameters $\beta$ are assigned a prior distribution. This is flexible, and leverages the framework offered by **rstanarm**. Multiple different prior families are available. Prior specifications are described in more detail in Section \@ref(prior-arguments).

Recall that the time series $R_t$ is latent and unobserved. The quantities we do observe are linked to it through its effect on the underlying infections in the population, which we now describe.

### Latent Infections

The evolution of infected individuals over time is modeled using a discrete renewal process. New infections today are taken to be a function of previous infections, a generation distribution, and the series $R_t$ described above.

Let $I_t$ be the (unobserved) cumulative infections that have occured at or before $t_0+t$. Since $t_0$ is taken to be the first day at which infections occur, it must be the case that $I_{-1} = 0$. For the remainder of this article, we let $\Delta I_t := I_t - I_{t-1}$ be the number of new infections at a given period.

Infections during the first $n_0>0$ days are seeded such that
$$
\Delta I_t \sim \text{Exponential}(\tau^{-1}),
$$
for all $0\leq t<n_0$. The parameter $\tau$ is given an exponential prior with a rate hyperparameter $\lambda_0>0$.

We are left to model the infections after the seeding period. Recall that this will be a function of both previous infections and a generation distribution. The generation distribution is unknown. Therefore as in @Flaxman2020, we assume that is is the same as the serial interval of the disease. The serial interval can be represented by a distribution $s := (s_1,s_2,\ldots)$ over the time from disease onset to a secondary onset. The effect of previous infections and the serial interval on new infections is captured entirely through a discrete convolution function
$$
c_t := \sum_{i=0}^{t}\Delta I_i s_{t-i}.
$$
Modeling new infections required knowing the size $P$ of the susceptible population. This is used to adjust new infections for the number of susceptible individual remaining in the population. The model assumes that no reinfection can occur, so that infected individuals are permanently removed from the susceptible population.

New infections are modeled by
\begin{equation}
\Delta I_t = (P - I_{t-1})\left( 1 -\exp\left(-\frac{R_tc_t}{P}\right)\right),
(\#eq:inf)
\end{equation}
for all $t \geq n_0$. This satisfies intuitive properties. If $R_t = 0$ or if nobody is susceptible, there are no new infections. Fixing $c_t > 0$ and letting $R_t \to \infty$ implies that $I_t \to P$, i.e. everyone that is susceptible is infected today.

The reader may notice that \@ref(eq:inf) differs from the update used in @Flaxman2020. This new update has the advantage of ensuring that cumulative infections never exceed the total population size. Its use can be justified as the solution of an ODE $I(t)$ satisfying 

$$
I'(t) =  \left(\frac{P-I(t)}{P} \right)R_{\lfloor t \rfloor}c_{\lfloor t \rfloor}.
$$
Given initial condition $I(t-1)=I_{t-1}$, the exact solution to this ODE at time $t$ is simply $I_t$ as defined through \@ref(eq:inf).

### Observations

Data is observed from $L$ observation processes $Y_t^{(1)} \ldots Y_{t}^{(L)}$, with the subscript $t$ ranging between $1$ and $T$. These processes do not need to be fully observed; i.e. data may be missing for a subset of time periods. The typical example of such data would be daily death (as used in @Flaxman2020) or case incidence data. However, you are not limited to this. In general,

* $Y_t^{(l)}$ should represent the count of a particular type of 'event' at time $t$. 
* This event is assumed to occur at most once per member of the population; an example would be hospitalization data. This assumption excludes the processes from representing cumulative observations - which would require a more complex dependence structure than presented here.
* The processes should be roughly conditionally independent given the underlying infection process.

Extensions to more general types of data will be considered in future versions of the package.

Although the multivariate normal is an obvious candidate for the distribution of $Y^{(l)}_t$, in practice there can be data issues leading to many observations being reported on one day, and fewer on others. To avoid being too influenced by this, the random variables $Y^{(l)}_t$ are assumed independent and negative binomial with mean $y_{t}^{(l)}$ and variance
$$
y_t^{(l)} + \frac{{\left(y_t^{(l)}\right)}^2}{\phi_l},
$$
where $\phi_l$ is a dispersion parameter distributed $\phi_l \sim \mathcal{N}^+(0,\sigma^2_{\phi_l})$ for some hyperparameter $\sigma^2_{\phi_l} > 0$. The expected value $y_{t}^{(l)}$ is then modeled as a function of

* $I_{0}, \ldots, I_{t-1}$, the previous infections,
* $\pi^{(l)} = (\pi^{(l)}_1, \pi^{(l)}_2, \ldots)$, a discrete distribution on $\mathbb{Z}^+$ representing the time distribution from an infection event to an observation event,
* and a proportion $\alpha_l$, assumed to be a time constant quantity representing the rate of infections which will eventually record as an observation of type $l$.

To give intuition on the above quantities, suppose for now that the $l$^th^ observation process recorded daily death counts. Then $\pi^{(l)}_{t}$ is the probability, conditional on a death being recorded today, that this individual was infected exactly ${t}$ days prior. $\alpha_{l}$ is then the mean infection fatality ratio (IFR) for the given population.

The functional form for $y_{t}^{(l)}$ is then simply
$$
y_{t}^{(l)} := \alpha_l \sum_{\tau=0}^{t-1} (I_{\tau} - I_{\tau-1})\pi^{(l)}_{t-\tau}.
$$
The distribution $\pi^{(l)}$ is *treated as known*, however in future versions of epidemia we may allow it to be learnt. One possibility in this direction would be to view $\pi^{(l)}$ as a discretization of a continuous parametric distribution. The parameters could be given priors and learnt. The Gamma distribution is a suitable candidate for this.

The proportion $\alpha_l$ is treated as unknown, and given a normal prior truncated to the unit interval. To be precise
\begin{equation}
\alpha_l \sim \mathcal{N}_{[0,1]}(\mu_l, \sigma^2_{\alpha_l}),
(\#eq:alpha)
\end{equation}
for given hyperparameters $\mu_l$ and $\sigma^2_{\alpha_l}$. In future versions of epidemia, these proportions may instead be assigned Beta priors.

## Multiple Populations

Extending to multiple populations is done by allowing some parameters to be pooled, while keeping others group specific. Suppose now that there are $M$ non-overlapping populations with differing start dates $t^{(m)}_0$ and epidemic lengths $T_m$.

We begin by discussing the model parameters outside of \@ref(eq:rt). We replace \@ref(eq:alpha) with
$$
\alpha_{l,m} \sim \mathcal{N}_{[0,1]}(\mu_{l,m}, \sigma^2_{\alpha_l}),
$$
so that \@ref(eq:alpha) is replicated for each group, except that each observation type has a shared hyperparameter $\sigma^2_{\alpha_l}$. The dispersion parameters $\phi_l$ are on the other hand pooled, and $\pi^{(l)}$ are assumed the same for each group.

The remaining parameters relate to the parameterisation of the time-varying reproduction numbers. Collect these into a vector $R$ with total length $T' := \sum_{m=1}^M T_m$, and consider the parameterization of $R$ in terms of covariates given in \@ref(eq:rt). This approach allows flexible pooling of parameters through $\beta$, while still permitting between group variation using the group-effects $b$. 

# R Implementation

**epidemia** is designed to fit the models described in Section \@ref(model-overview). In particular, it uses R's formula interface to parameterize the time-varying reproduction number in terms of a number of covariates (see \@ref(eq:rt)). The implementation of this shares many similarities with the `stan_glmer` function in **rstanarm** and the **glmer** function in **lme4**.

## Model fitting using `epim`

As mentioned in the introduction, the primary model fitting function in **epidemia** is `epim`. We now describe this function in depth. Section \@ref(function-arguments) details the formal arguments to `epim`, and links them where possible to the mathematical notation used in Section \@ref(model-overview).

### Function Arguments

Table \@ref(tab:epimArgs) lists the formal arguments to `epim`.

```{r epimArgs, echo=F}
df <- data.frame(Arguments = c("formula", 
                               "data",
                               "obs",
                               "pops",
                               "si",
                               "seed_days",
                               "algorithm",
                               "group_subset",
                               "center",
                               "prior",
                               "prior_intercept",
                               "prior_covariance",
                               "r0",
                               "prior_phi",
                               "prior_tau",
                               "prior_PD",
                               "sampling_args"),
                 Description = c("Specifies the model \\@ref(eq:rt) for the unadjusted time-varying reproduction number. See [glmer](https://www.rdocumentation.org/packages/lme4/versions/1.1-23/topics/glmer) for more details.",
                                 "The data used in the model specified by 'formula'. Each term in `formula` must have a corresponding column in `data`. See [glmer](https://www.rdocumentation.org/packages/lme4/versions/1.1-23/topics/glmer) for more details.",
                                 "All available observations and hyperparamters for the observation model (Section \\@ref(observations)). Each element of `obs` represents its own type of observation. More on this below.",
                                 "Population of each modeled group. The first column represents the group and the second giving the corresponding population.",
                                 "A vector representing the serial interval of the disease. This should be a simplex vector - i.e. all elements are non-negative and sum to one. The $n$^th^ element gives the probability an individual infects another $n$ days after disease onset.",
                                 "Number of days $N_0$ for which to seed infections at the start of the epidemic. Defaults to 6L",
                                 "The algorithm used to fit the model. Must be one of 'sampling', 'meanfield' or 'fullrank', which correspond to `rstan` sampling methods. See [sampling](https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html) and [vb](https://mc-stan.org/rstan/reference/stanmodel-method-vb.html).",
                                 "An optional vector specifying a subset of groups to model. Elements should correspond to the group levels specified through the `data` argument.",
                                 "If `TRUE` then all covariates in \\@ref(eq:rt) are centered (shifted to have mean zero). **WARNING**: *the priors are then interpreted as priors on the centered covariates*. Defaults to `FALSE`.",
                                 " The prior distribution on $\\beta$, excluding any possible intercept.",
                                 "Prior on the intercept if one has been specified in the model implied by `formula`.",
                                 "Prior on the covariance matrix of the group-specific parameters $b$. Only used if the formula has at least one 'random-effects' term, i.e. `(a|b)`.",
                                 "Set the constant $A$, introduced in \\@ref(eq:rt). This will determine the maximum possible unadjusted $R_t$ (to be clear, not neccessarily $A$). Defaults to 3.28.",
                                 "Prior on the vector $(\\phi_1, \\ldots, \\phi_L)$, the parameter controling variability of the observations around their mean values.",
                                 "Prior on $\\tau$, the parameter controling the variability in the seeded cases.",
                                 "Flag whether to sample from the prior distribution. Same as [stan_lm](https://mc-stan.org/rstanarm/reference/stan_lm.html). Defaults to `FALSE`.",
                                 "An (optional) named list of parameters to pass to the rstan function used for model fitting. See [sampling](https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html) and [vb](https://mc-stan.org/rstan/reference/stanmodel-method-vb.html) for details of possible arguments."),
                 Class = c("formula",
                          "data.frame",
                          "list",
                          "data.frame",
                          "numeric",
                          "integer",
                          "character",
                          "character",
                          "logical",
                          "list",
                          "list",
                          "list",
                          "numeric",
                          "list",
                          "list",
                          "logical",
                          "list"))
knitr::kable(df, caption = "Formal arguments for the epim function", booktabs=TRUE)
```

Most of the arguments listed in Table \@ref(tab:epimArgs) are self-explanatory. However the first three and also the prior arguments require further explanation. We tackle each of these in turn.

#### `formula` Argument
This specifies the model for the *unadjusted* time-varying reproduction number, given by \@ref(eq:rt). The LHS takes the form `R(group,date)`. This is just syntactic sugar to make explicit that the model is for the reproduction number for a given population and date.

The right hand side can include both pooled and unpooled coefficients. For more details on interpreting different formulas, please see [here](https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf). 

We briefly give an intepretation for specific models in the context of the Europe data. First note that terms in the formula must correspond to column names in `data`, which are
```{r dataColnames}
colnames(EuropeCovid$data)
```
Suppose for simplicity that the value of all covariates at the start date of each group is zero, so that the intercept can be interpreted as determining the starting reproduction number $R_0$ of the disease (this is indeed the case for the Europe example). Then

* `R(country, date) ~ 0 + lockdown` This is a no-intercept model. The effect is to set an exact $R_0$ which is *the same for all countries*. This potentially changes at dates for which `lockdown` become non-zero (i.e. after the intervention come into place). The starting value is precisely $A$ defined in \@ref(eq:rt). 

* `R(country, date) ~ 1 + lockdown` The intercept is the same for all countries. This implies a common distribution for $R_0$, which is set by `prior_intercept`.

* `R(country, date) ~ (1 | country) + lockdown` A country-specific intercept allows the distribution of $R_0$ to depend on the country. The prior on these is controlled by both `prior_intercept` and `prior_covariance`.

#### `data` argument

This argument provides any data specified by the formula. It must contain at least two columns which give the modeled populations and simulation dates. In the Europe example, the columns `country` and `date` serve this purpose. The `country` column must be coercible to class `factor`, and the levels of this column determine the possible populations to model. 
```{r}
data <- EuropeCovid$data
levels(data$country)
```
If specified, only the populations given in the `group_subset` argument are modeled. Otherwise, all levels are used.

The `dates` column must be coercible to a 'Date' vector. Dates must be consecutive for each modeled group. The first date is taken to be the start date $t^{(m)}_0$ of the epidemic in that population, and the final date is taken to be $t^{(m)} + T$. 
```{r}
agg <- function(x,f) aggregate(x$date, by=list(x$country), FUN=f)
setNames(cbind(agg(data, min),
               agg(data, max)[,2]),
         c("country", "start", "date"))
```
Following @Flaxman2020, the start dates shown above are thirty days prior to the first date for which more than 10 cumulative deaths were observed in the given country. They are *not learnt by the model*, rather they are assumed and specified by the user.

#### `obs` argument

A list of lists giving available observations from the $L$ observation processes introduced in Section \@ref(observations), and hyperparameters for the observation model. These hyperparameters are $\{\mu_{l,m}\}$ and $\{\sigma_{\alpha_l}\}$. The $l$^th^ element of `obs` must itself be a named list containing the following three elements.

* **odata**: A three column dataframe representing observations from the $l$^th^ observation process. The first column represents group membership and must be coercible to class factor. The second column indicates the observation date and must be coercible to class Date. The third column contain the actual data.

* **rates**: A named list specifying the prior for the proportion of infected individuals recorded as an observation. For example if recording deaths this would be some estimate of each groups infection fatality ratio (IFR). The priors are assumed normal. Contains:

    * **means**: A two column dataframe giving the hyperparameters $\mu_{l,m}$, i.e. the estimated mean proportion of infected individuals recorded as an observation. First column represents the group, while the second the corresponding proportion.

    * **scale**: The standard deviation $\sigma_{\alpha_l}$ around the mean values. Default is 0.1.

* **pvec**: The probability vector $\pi_l$ described in Section \@ref(observations).

The `EuropeCovid` data contains an example of the `obs` argument. It uses only one type of observation, death data, and so $L=1$ in this case, and of course `EuropeCovid$obs`must has length one.
```{r}
deaths <- EuropeCovid$obs$deaths
```

We can inspect the observed deaths as follows.
```{r odata}
head(deaths$odata)
```

It is also instructive to look at `$rates` component.
```{r rates}
deaths$rates
```
This shows the assumed values for the hyperparameters $\alpha_{l,m}$ and $\sigma_{\alpha_l}$ described above. Note the differing prior expected value of the IFR between groups. This is partially a result of differing age demographics.

Finally, we visualise the distribution of time from disease onset to death.
```{r pvec, fig.align="center"}
barplot(deaths$pvec, names.arg=1:101)
```
Following @Flaxman2020, this is a discretization of the distribution of $\text{Gamma}(1.35,3.77) + \text{Gamma}(4.94,3.60)$, where the notation $\text{Gamma}(\alpha, \theta)$ refers to a Gamma random variable with shape $\alpha$ and scale $\theta$.

#### Prior arguments

Prior distributions should be specified for the parameters in \@ref(eq:rt), and for additional model parameters. 

*Please note that the current default priors may not be appropriate, and should not be relied upon. In future versions of the package, we hope to set good default priors.*

The priors for $\beta$ (see \@ref(eq:rt)) are set using the `prior` and `prior_intercept` arguments. These will only have an effect if the formula specifies covariates and an intercept respectively. These function  similarly to the same arguments in[`stan_lm`](https://mc-stan.org/rstanarm/reference/stan_lm.html). To understand which families can be used please refer to [rstanarm's priors](https://mc-stan.org/rstanarm/reference/priors.html). 

There is one caveat: which is that we offer additional priors. Currently there is just one, `shifted_gamma`, which can only be used for the `prior` argument. The addition of this prior is motivated by the priors used in @Flaxman2020. This essentially allows for 
\begin{equation}
\beta_i \sim \text{Gamma}(\alpha,\theta) - \eta,
\end{equation}
where $\alpha$ and $\theta$ are shape and scale parameters, and $\eta$ is a shift to allow for priors with support below zero.

Consider a single 'random-effects' term in the formula. A good example would be `(1 + lockdown | country)`. For each group the intercepts and slopes are treated as zero-mean multivariate normal with unknown covariance matrix $\Sigma$. For our example term, fix one level implied by the factor `country`, say `"Italy"`. For this group, there are two coefficients - a random intercept for Italy, and a random slope. Therefore $\Sigma$ has dimension $2 \times 2$. Coefficients for different groups are treated as independent. 

**epidemia** borrows from **rstanarm** and uses the [`decov`](rstanarm priors) prior for $\Sigma$. This decomposes $\Sigma$ into a variance vector and a correlation matrix. An LKJ prior is used on the correlation matrix, while the variance is decomposed into the product of a simplex vector and the trace of $\Sigma$. The simplex vector is given a symmetric Dirichlet prior, which the trace is once again decomposed as $tr(\Sigma) = J \kappa$, where $J$ is the order of $\Sigma$. Finally $\kappa$ is assigned a scale-invariant prior - specifically a Gamma distribution with give shape and scale hyperparameters. For more information on this, please see [rstanarm priors](http://mc-stan.org/rstanarm/reference/priors.html) and this [vignette](http://mc-stan.org/rstanarm/articles/glmer.html).

When the left hand side of the formula has only one term (for example `(1 | country)`), this prior on the covariance simplifies considerably. $\Sigma$ simply reduces to $\kappa$, which has a gamma prior.

# A More Complete Example

Here we demonstrate how to specify different prior distributions in practice, using the Europe data restricted to Germany and the United Kingdom as an example. In particular, we demonstrate the utility of the `prior_PD` flag for sampling from the prior predictive distribution. This allows you to easily visualise the prior assumptions on the reproduction number. Various methods that can be used on fitted models (`epimodel`) are demonstrated.
```{r}
args$group_subset <- c("Germany", "United_Kingdom")
```
Similar to @Flaxman2020, we specify the following model.
```{r}
args$formula <- R(country,date) ~ (1 | country) + schools_universities + self_isolating_if_ill + public_events + lockdown + social_distancing_encouraged
```

This model allows a separate initial reproduction number for each country, and includes 6 different non-pharamceutical interventions (NPIs) to explain the changes to the number over time.

## Prior Specification

Here we focus on specifying the `prior` argument. This controls the prior distribution of the coefficients in the regression. Any of the rstanarm priors can be used. We have also added a `shifted_gamma` prior to replicate the prior in @Flaxman2020.

To quickly visualise the effect of the prior distribution we can used the `prior_PD` flag to `epim`. If `TRUE` epim will sample all parameters from their prior distribution. We specify the prior for the intercept as follows.

```{r}
args$prior_intercept <- rstanarm::normal(location=0, scale = 0.5)
```

```{r normalPrior, results="hide", cache=TRUE, message=FALSE, warning=FALSE, fig.align="center"}
args$prior <- rstanarm::normal(scale = 0.5)
args$algorithm <- "sampling"
args$sampling_args <- list(iter=200,control=list(adapt_delta=0.95,max_treedepth=15))
args$prior_PD <- TRUE
fit <- do.call("epim", args)
plot_rt(fit, levels = c(20,40,60,80,95), adjusted=F)
```

And example of using a shifted gamma prior...

```{r gammaPrior, results="hide", cache=TRUE, message=FALSE, warning=FALSE, fig.align="center"}
args$prior <- shifted_gamma(shape=1/6, scale=1, shift = -log(1.05)/6)
fit <- do.call("epim", args)
plot_rt(fit, levels = c(20,40,60,80,95), adjusted=F)
```

The above plots give a good indication of the implications of different prior families.

## Methods for `epimodels`

Fitting the model to the data...
```{r fittedRun, results="hide", cache=TRUE, message=FALSE, warning=FALSE}
args$prior_PD = FALSE
fit <- do.call("epim", args)
```

Printing the object gives a brief summary of estimated coefficients and standard errors. This is very similar to the print method for [`stanreg`](http://mc-stan.org/rstanarm/reference/stanreg-objects.html) objects.

```{r, eval=FALSE}
print(fit, digits = 2)
```

You can retrieve the prior distributions used easily with the following.
```{r}
prior_summary(fit)
```

Often it will be useful to obtain the MCMC draws for the raw parameters. This can be done using `as.matrix`, `as.array`, or `as.data.frame`. Here is an example of using `as.matrix`.

```{r}
draws <- as.matrix(fit)
draws[1:4,1:4]
```

# References
