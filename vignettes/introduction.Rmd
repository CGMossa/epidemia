
---
title: "Introduction to epidemia"
output:
  pdf_document: default
  html_document:
    fig_height: 4
    fig_width: 10
    pandoc_args: --webtex
bibliography: ../inst/REFERENCES.bib
vignette: |
  %\VignetteIndexEntry{Introduction to epidemia} %\VignetteEngine{knitr::rmarkdown} \usepackage[utf8]{inputenc}
---

This vignette is very much a work in progress, and will be regularly updated. It aims to demonstrate basis usage of the **epidemia** package. The main work is done in the `epim` function. Before continuing, please read the documentation for a more detailed description of this function.

## Model Overview

The models that can be fit using the epidemia package are extensions of the model introduced in @Flaxman2020. 


### A Single Population

We begin by describing the model as it applies to a single population. Extensions to multiple populations are described in the next section. Let $(t_0, \ldots, t_n)$ be a time index, representing the period over which to simulate the epidemic. The index $t_0$ is taken to be the first date at which infections are observed in the population.


Data is observed from $L$ different observation processes $Y_{1,t}, \ldots, Y_{L,t}$. Each process represents a different type of observation; i.e. daily death data (as in @Flaxman2020), hospitalisation rates, or recorded infections. The random variables $Y_{t,l}$ are assumed to follow a negative binomial distribution with positive mean $y_{t,l}$ and variance given by
$$
 y_{t,l} + \frac{y_{t,l}^{2}}{\phi_l},
$$
with $\phi_l \sim \mathcal{N}^+(0,\sigma^2_{\phi})$ for some hyperparameter $\sigma^2_{\phi_l} > 0$. The expected value $y_{tl}$ is modeled as a function of 

* $I_1, \ldots, I_{t-1}$, where $I_i$ represents the cumulative number of infections at period $i$, 
* $\pi^{(l)}$, a discrete distribution on $\mathbb{Z}^+$, representing the time from an infection event to an observation event, 
* and a proportion $\alpha_l$, assumed to be a time constant quantity representing the rate of infections which will manifest as an observation of type $l$. 

To give intuition on the above quantities, suppose the observations were death counts. Conditional on an individual dying on a given date, then $\pi^{(l)}(t)$ is the probability that this individual was infected $t$ days prior. $\alpha_{l}$ is then the infection fatality ratio (IFR) in the population.

This functional form for $y_{tl}$ is then simply
$$
y_{t,l} := \alpha_l \sum_{\tau=1}^{t-1} (I_{\tau} - I_{\tau-1})\pi_{t-\tau}.
$$

While the distribution $\pi^{(l)}$ is *assumed*, a prior is used on $\alpha_l$. This is a normal distribution truncated to $[0,1]$, i.e. 
$$
\alpha_l \sim \mathcal{N}_{[0,1]}(\mu_l, \sigma^2_{\alpha_l}),
$$
for hyperparameters $\mu_l$ and $\sigma^2_{\alpha_l}$. In future versions of epidemia, this may be replaced by a Beta distribution. We may also place a prior on the distributions $\pi^{(l)}$.


To model the sequence $\{I_t\}$ we begin with an extension to continuous time. Let $I(t)$ be an ODE satisfying
$$
\frac{dI(t)}{dt} = \frac{P-I(t)}{P}R_{\lfloor t \rfloor}c_{\lfloor t \rfloor}.
$$
with $R_t$ being the *unadjusted* (not adjusted for the susceptible population) time-varying reproduction number, and $c_t$ is a weighted sum over previous infections, defined by
$$
c_{t} = \sum_{\tau=1}^{t} (I_{\tau} - I_{\tau-1}) g(t-\tau).
$$

$I_t$ is defined by the exact solution to the above ODE. This is easily shown to be
$$
I_t - I_{t-1} = (P - I_{t-1})\left( 1 -\exp\left(-\frac{R_tc_t}{P}\right)\right).
$$

This satisfies intuitive properties. If $R_t = 0$, then there are no new infections. Fixing $c_t > 0$ and letting $R_t \to \infty$ implies that $I_t \to P$, i.e. everyone is infected tomorrow.


## Multiple Infections

TODO



## Example Usage

The main model fitting function in epidemia is `epim`. This section demonstrates basic usage of this function.

### Europe Covid

The package contains the dataset used in @Flaxman2020. This data pertains to covid-19 in 11 European countries. Load this with
```{r}
library(epidemia)
data("EuropeCovid")
options(mc.cores = parallel::detectCores())
```

`EuropeCovid` is a list containing much of the information required for `epim`. These fields are named as follows.

```{r}
names(EuropeCovid)
```
Each of these names correspond to an argument required for `epim`. The 'data' argument is a dataframe with columns referring to possible covariates for modelling the time-varying reproduction number. It contains one column which will specify the `groups` to be modelled, and an additional column giving the dates corresponding to the covariate data. Note that the covariates included here will not be used unless specified in the formula argument of `epim` -- more on this below.

```{r}
args <- EuropeCovid
data <- args$data
head(data)
```

The `obs` argument is itself a list of lists. Each element of which corresponds to a different type of observation. This could for example be death, incidence, or hospitalisation counts. Following @Flaxman2020, we only consider death counts here.

```{r}
deaths <- args$obs$deaths
names(deaths)
```

`epim` requires a formula, which specifies the model to be fit. In the current version of the package, the terms in the formila must correspond to the names in `data`. This may be relaxed in future versions, in line with other model fitting functions like `lm` or `glm`. 

Although `data$country` contains 11 different populations, here we consider, for simplicity, only two. Specifically we will look at Germany and the United Kingdim. `epim` makes this simple by providing a `group_subset` argument.

```{r}
args$group_subset <- c("Germany", "United_Kingdom")
```

 A model is specified using the `formula` argument. The LHS of the formula always takes the form `R(x,y)` for some columns `x` and `y` in `data`. Unless `group_subset` is specified explicitly, `epim` will use the factor levels in `data$x` as the groups to model, and will use `data$y` to specify the modeled dates for each group. The dates must be a consecutive range, and there must be no missing covarite data in the columns specified on the RHS of the formula. The first date found for each group is assumed to be the beginning of the epidemic, and seeding of infections begins from this date.
 
We briefly give an intepretation of the models specified by different fomulas. Suppose for simplicity that the value of all covariates at the start date is zero, so that the intercept can be interpreted as specifying the $R_0$. Then

* `R(country, date) ~ 0 + ...` This is a no-intercept model. The effect is to set an exact starting $R_0$ which is the same for all countries. This is then modified at dates for which covariates become non-zero (i.e. after interventions come into place). This starting value is controlled by the `r0` argument to `epim`, which defaults to 3.28.

* `R(country, date) ~ 1 + ...` This gives a common intercept for all countries. The distribution for $R_0$ is the same for all countries. This distribution can be modified by specifying the `prior_intercept` argument for `epim`

* `R(country, date) ~ (1 | country) + ...` The random effects term allows the distribution for $R_0$ to depend on the country. The prior for these is controlled by both `prior_intercept` and `prior_covariance`.
 
Similar to @Flaxman2020, we specify the following model.

```{r}
args$formula <- R(country,date) ~ 1 + schools_universities + self_isolating_if_ill + public_events + lockdown + social_distancing_encouraged
```

This model allows a separate $R_0$ for each country, and includes 6 different non-pharamceutical interventions (NPIs) to explain the changes in the time-varying reproduction number.

### Trying out different priors.

The priors on the coefficient in the regressions, and on other parameters are controlled by the arguments `prior`, `prior_intercept`, `prior_covariance`, `prior_tau` and `prior_phi`. Please read the documentation for `epim` for a precise interpretation of these arguments. 

Here we focus on specifying the `prior` argument. This controls the prior distribution of the coefficients in the regression. Any of the rstanarm priors can be used. We have also added a `shifted_gamma` prior to replicate the prior in @Flaxman2020. 

To quickly visualise the effect of the prior distribution we can used the `prior_PD` flag to `epim`. If `TRUE` epim will sample all parameters from their prior distribution. We specify the prior for the intercept as follows.

```{r}
args$prior_intercept <- rstanarm::normal(location=0,scale = 0.5)
```

```{r, results = "hide"}
args$prior <- rstanarm::normal(scale = 0.5)
args$algorithm <- "sampling"
args$sampling_args <- list(iter=200,control=list(adapt_delta=0.95,max_treedepth=15))
args$prior_PD <- TRUE
fit <- do.call("epim", args)
plot_rt(fit, levels = c(20,40,60,80,95))
```

And example of using a shifted gamma prior...

```{r, results="hide"}
args$prior <- shifted_gamma(shape=1/6, scale=1, shift = -log(1.05)/6)
fit <- do.call("epim", args)
plot_rt(fit, levels = c(20,40,60,80,95))
```

Fitting the model to the data...
```{r, results="hide"}
args$prior_PD = FALSE
fit <- do.call("epim", args)
```

Printing the object gives a brief summary.

```{r}
print(fit, digits = 2)
```

Can extract the priors used...

```{r}
prior_summary(fit)
```

And get the matrix of parameter draws

```{r}
draws <- as.matrix(fit)
head(draws)
```


<!-- ### Model 1 -->

<!-- We start by fitting a simple model with the only covariate being the indicator for lockdown. This is intuitively specified as -->
<!-- ```{r} -->
<!-- args$formula <- R(country, date) ~ 0 + lockdown  -->
<!-- ``` -->
<!-- The LHS of the formula always takes the form `R(x,y)` for some columns `x` and `y` in `data`. Epim will always use the factor levels found in `data$x` as the groups to model, and will use `data$y` to specify the modeled dates for each group. Since we removed all countries other than `United_Kingdom` from `data$country`, `epim` will only model the UK. The dates must be a consecutive range, and there must be no missing covariate data in the columns specified on the R.H.S. of the above formula. The first date found for each group is assumed to be the beginning of the epidemic, and seeding of infections begins from this date. -->


<!-- We fit this model using variational bayes as it is quick. For a full analysis, MCMC sampling should be used. -->

<!-- ```{r} -->
<!-- # can switch out for "sampling" if desired -->
<!-- args$algorithm <- "meanfield" -->
<!-- fit <- do.call("epim", args) -->
<!-- ``` -->


<!-- We can quickly plot the estimated $R_{tm}$ with the `plot_rt` function, as follows: -->

<!-- ```{r} -->
<!-- plot_rt(fit, group = "United_Kingdom") -->
<!-- ``` -->

<!-- ### Model 2 -->

<!-- We also demonstrate how to use random effects terms in the formula. We will fit a simple model replacing the lockdown covariate with a 'week specific' effect. To do this, we augment `data` to store the week as a covariate, and update the formula -->

<!-- ```{r} -->
<!-- data$week <- as.factor(format(data$date, "%V")) -->
<!-- args$data <- data -->
<!-- args$formula <- R(country,date) ~ 0  + (1 | week) -->
<!-- ``` -->

<!-- Fitting the model -->
<!-- ```{r} -->
<!-- fit <- do.call("epim", args) -->
<!-- ``` -->
<!-- and plotting -->
<!-- ```{r} -->
<!-- plot_rt(fit, "United_Kingdom") -->
<!-- ``` -->


<!-- ### Model 3 -->

<!-- We can mix fixed effects and random effects... -->

<!-- ```{r} -->
<!-- args$formula <- R(country,date) ~ 0 + lockdown  + (1 | week) -->
<!-- fit <- do.call("epim", args) -->
<!-- plot_rt(fit, "United_Kingdom") -->
<!-- ``` -->





