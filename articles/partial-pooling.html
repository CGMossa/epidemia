<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Partial Pooling • epidemia</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Partial Pooling">
<meta property="og:description" content="epidemia">
<meta property="og:image" content="https://imperialcollegelondon.github.io/epidemia/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS_CHTML.js" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-186908163-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-186908163-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epidemia</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.7.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/install.html">Install</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Model
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/model-description.html">Description</a>
    </li>
    <li>
      <a href="../articles/model-implementation.html">Implementation</a>
    </li>
    <li>
      <a href="../articles/partial-pooling.html">Partial Pooling</a>
    </li>
    <li>
      <a href="../articles/priors.html">Priors</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/flu.html">A Basic Example</a>
    </li>
    <li>
      <a href="../articles/europe-covid.html">A Multilevel Model</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ImperialCollegeLondon/epidemia/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="partial-pooling_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Partial Pooling</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ImperialCollegeLondon/epidemia/blob/master/vignettes/partial-pooling.Rmd"><code>vignettes/partial-pooling.Rmd</code></a></small>
      <div class="hidden name"><code>partial-pooling.Rmd</code></div>

    </div>

    
    
<style>
.contents .page-header {
    display: none;
} 
</style>
<div class="article_container">

<div id="partial-pooling-in-epidemia" class="section level1">
<h1 class="hasAnchor">
<a href="#partial-pooling-in-epidemia" class="anchor"></a><span class="header-section-number">1</span> Partial Pooling in epidemia</h1>
<hr>
<p>Here we describe how to partially pool parameters underlying the reproduction
numbers in <strong>epidemia</strong>. This is done using a special operator in the formula passed to
<code><a href="../reference/epirt.html">epirt()</a></code>. If you have previously used any of the <strong>lme4</strong>,
<strong>nlmer</strong>, <strong>gamm4</strong>, <strong>glmer</strong> or <strong>rstanarm</strong> packages then this
syntax will be familiar.</p>
<p>A general R formula is written as <code>y ~ model</code>, where <code>y</code> is the response that
is modeled as some function of the linear predictor which is symbolically
represented by <code>model</code>. <code>model</code> is made up of a series of terms separated by
<code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code>. In <strong>epidemia</strong>, as in many other packages, parameters can be partially pooled
by using terms of the form <code>(expr | factor)</code>, where both <code>expr</code> and <code>factor</code> are
R expressions. <code>expr</code> is a standard linear model (i.e. treated the same as
<code>model</code>), and is parsed to produce a model matrix. The syntax <code>(expr | factor)</code>
makes explicit that columns in this model matrix have separate effects for
different levels of the factor variable.</p>
<p>Of course, separate effects can also be specified using the standard interaction
operator <code>:</code>. This however corresponds to <em>no pooling</em>, in that parameters
at different levels are given separate priors. The <code><a href="https://rdrr.io/r/base/Logic.html">|</a></code> operator, on the other
hand, ensures that parameters at different levels are given a common prior, which
is itself parameterised by parameters which are given hyperpriors. This allows
information to be shared between levels of the factor. To be concrete, suppose
that the model matrix parse from <code>expr</code> has <span class="math inline">\(p\)</span> columns,
and that <code>factor</code> has <span class="math inline">\(L\)</span> levels. The <span class="math inline">\(p\)</span>-dimensional parameter vector for
the <span class="math inline">\(l\)</span><sup>th</sup> group can be denoted by <span class="math inline">\(\theta_l\)</span>. In <strong>epidemia</strong>, this vector
is modeled as multivariate normal with an unknown covariance matrix. Specifically,
<span class="math display">\[\begin{equation}
  \theta_{l} \sim N(0, \Sigma),
\end{equation}\]</span>
where the covariance <span class="math inline">\(\Sigma\)</span> is given a prior. <strong>epidemia</strong> offers the same
priors for covariance matrices as <strong>rstanarm</strong>; in particular the <code><a href="https://mc-stan.org/rstanarm/reference/priors.html">rstanarm::decov</a></code> and
<code><a href="https://mc-stan.org/rstanarm/reference/priors.html">rstanarm::lkj</a></code> priors can be used. Note that <span class="math inline">\(\Sigma\)</span> is not assumed diagonal, i.e. 
the effects within each level may be correlated. For more information on priors
for covariance matrices, please see this <a href="#">article</a>.</p>
<p>If independence is desired for parameters in <span class="math inline">\(\theta_l\)</span>, we can simply replace
<code>(expr | factor)</code> with <code>(expr || factor)</code>. This latter term effectively
expands into <span class="math inline">\(p\)</span> terms of the form <code>(expr_1 | factor)</code>, <span class="math inline">\(\ldots\)</span>, <code>(expr_p | factor)</code>,
where <code>expr_1</code> produces the first column of the model matrix given by <code>expr</code>,
and so on. From the above discussion, the effects are independent across terms,
and essentially <span class="math inline">\(\Sigma\)</span> is replaced by <span class="math inline">\(p\)</span> one-dimensional covariance matrices
(i.e. variances).</p>
<div id="example-formulas-" class="section level2">
<h2 class="hasAnchor">
<a href="#example-formulas-" class="anchor"></a><span class="header-section-number">1.1</span> Example Formulas.</h2>
<p>The easiest way to become familiar with how the <code><a href="https://rdrr.io/r/base/Logic.html">|</a></code> operator works is to
see a multitude of examples. Here, we give many examples, their interpretations,
and where possible we compare the models to the no pooling and full pooling equivalents.
For a comprehensive reference on mixed model formulas, please see the
<a href="https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf">lme4 vignette</a>.</p>
<p>There are many possible ways to specify intercepts.</p>
<ul>
<li>
<code>R(region, date) ~ 1 + ...</code> : Full pooling, common intercept for all regions</li>
<li>
<code>R(region, date) ~ region + ...</code>: Separate intercepts for each region, not pooled.</li>
<li>
<code>R(region, date) ~ (1 | region) + ...</code> Separate intercepts for each region which are partially pooled.</li>
<li>
<code>R(region, date) ~   (1 | continent) + ...</code> Separate intercepts based on a factor other than <code>region</code>, partially pooled.</li>
</ul>
<p>We can also partially pool effects of covariates. Let <code>npi</code> be some indicator
of a non-pharmaceutical intervention.</p>
<ul>
<li>
<code>R(region, date) ~ 1 + npi + ...</code>: Full pooling. Effect of NPI the same across all regions.</li>
<li>
<code>R(region, date) ~ 1 + npi:region + ...</code>: No pooling. Separate effect in each region</li>
<li>
<code>R(region, date) ~ 1 + (0 + npi|region) + ...</code>: Partial pooling. Separate effects in each region.</li>
<li>
<code>R(region, date) ~ 1 + (npi|region) + ...</code>: Right hand side expands to <code>1 + (1 + npi|region)</code>, and so
both the intercept and effect are partially pooled.</li>
</ul>
<p>The final example above shows that it is important to remember that to parse the
term <code>(expr | factor)</code>, <code><a href="../reference/epim.html">epim()</a></code>first parses <code>expr</code> into a model matrix
in the same way as functions like <code>lm</code> and <code>glm</code> parse models. In this case,
the intercept term is implicit. Therefore, if this is to be avoided, we must
explicitly use <code>0 +</code> or <code>-1 +</code>.</p>
<div id="independent-effects" class="section level3">
<h3 class="hasAnchor">
<a href="#independent-effects" class="anchor"></a><span class="header-section-number">1.1.1</span> Independent Effects</h3>
<p>By default, the vector of partially pooled intercepts and slopes for each region
are correlated. The <code>||</code> operator can be used to specify independence. An example:</p>
<ul>
<li>
<code>R(region, date) ~ npi + (npi || region) + ...</code>: Right hand side expands to
<code>1 + npi + (1 | region) + (npi | region) + ...</code>. Separate intercepts and
effects for each region which are partially pooled. The intercept and NPI effect
are assumed independent within regions.</li>
</ul>
</div>
<div id="nested-groupings" class="section level3">
<h3 class="hasAnchor">
<a href="#nested-groupings" class="anchor"></a><span class="header-section-number">1.1.2</span> Nested Groupings</h3>
<p>Often we have groupings that are nested. For example, suppose we are modeling an
epidemic at quite a fine scale, say at the level of local districts.
Often there will be little data for
any given district, and so no pooling will give highly variable estimates of
reproduction numbers. Nonetheless, pooling at a broad scale, say at the country
level may hide region specific variations.</p>
<p>If we have another variable, say <code>county</code>, which denotes the county to which
each district belongs, we can in theory use a formula of the form</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu">R</span>(<span class="no">district</span>, <span class="no">date</span>) ~ (<span class="fl">1</span> <span class="kw">|</span> <span class="no">county</span> / <span class="no">district</span>) + <span class="no">...</span></pre></body></html></div>
<p>The right hand side expands to <code>(1 | county) + (1 | county:district)</code>.
There is a county level intercept, which is partially
pooled across different counties. There are also district intercepts
which are partially pooled <em>within</em> each county.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by James Scott, Axel Gandy, Swapnil Mishra, Juliette Unwin, Seth Flaxman, Samir Bhatt.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
