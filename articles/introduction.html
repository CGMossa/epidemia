<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flexible Epidemic Modeling with epidemia • epidemia</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Flexible Epidemic Modeling with epidemia">
<meta property="og:description" content="epidemia">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epidemia</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.6.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/IncidenceOnly.html">Modelling of R with Case data only</a>
    </li>
    <li>
      <a href="../articles/ResolvingProblems.html">Resolving Convergence Problems</a>
    </li>
    <li>
      <a href="../articles/TimeDependentR.html">Time-dependent Modelling of R</a>
    </li>
    <li>
      <a href="../articles/introduction.html">Flexible Epidemic Modeling with epidemia</a>
    </li>
    <li>
      <a href="../articles/plotting.html">Plotting with epidemia</a>
    </li>
    <li>
      <a href="../articles/priors.html">Using Prior Distributions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ImperialCollegeLondon/epidemia/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="introduction_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Flexible Epidemic Modeling with epidemia</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ImperialCollegeLondon/epidemia/blob/master/vignettes/introduction.Rmd"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="hidden name"><code>introduction.Rmd</code></div>

    </div>

    
    
<p><strong>Note:</strong> <em>This vignette is a work in progress, and will be regularly updated.</em></p>
<p><strong>epidemia</strong> is an R-package for fitting Bayesian epidemic models in the style of <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>. Here we detail these models and give users enough information to start fitting them independently.</p>
<p>The document is organized as follows. Section <a href="#example-usage">1</a> provides basic examples with minimal description, so that users can quickly get a feel for the package. Section <a href="#model-overview">2</a> gives a formal framework for the models within the scope of the package. Understanding this framework is essential for making the most of the flexibility offered by <strong>epidemia</strong>. Section <a href="#r-implementation">3</a> discusses the details of <code>epim</code>; the primary model fitting function in the package. <code>epim</code> is designed to be flexible, and therefore has a number of arguments. This can be intimidating, so we describe these arguments in a lot of detail. Finally Section <a href="#a-more-complete-example">4</a> highlights some of the more useful features of the package.</p>
<p><strong>epidemia</strong> contains an example dataset <code>EuropeCovid</code>, which contains data on the daily deaths from Covid-19 recorded in 11 European countries. This will be used as a running example throughout the vignette.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">epidemia</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rstanarm</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"EuropeCovid"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="kw">mc.cores</span> <span class="kw">=</span> <span class="kw pkg">parallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>())</pre></body></html></div>
<p>The line <code><a href="https://rdrr.io/r/base/options.html">options(mc.cores = parallel::detectCores())</a></code> is important if MCMC sampling is used, as it allows different chains to be run in parallel, rather than sequentially.</p>
<div id="example-usage" class="section level1">
<h1 class="hasAnchor">
<a href="#example-usage" class="anchor"></a><span class="header-section-number">1</span> Example Usage</h1>
<p>Here we provide code snippets showing basic usage of <strong>epidemia</strong>. Below considers fitting a model to the Italian data, and demonstrates usage of various arguments to <code>epim</code>.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co"># collect arguments for 'epim'</span>
<span class="no">args</span> <span class="kw">&lt;-</span> <span class="no">EuropeCovid</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">args</span>))</pre></body></html></div>
<pre><code>## [1] "data" "obs"  "pops" "si"</code></pre>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># use NUTs sampler to fit the model</span>
<span class="no">args</span>$<span class="no">algorithm</span> <span class="kw">&lt;-</span> <span class="st">"sampling"</span>
<span class="no">args</span>$<span class="no">sampling_args</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">iter</span><span class="kw">=</span><span class="fl">1e3</span>,<span class="kw">control</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">adapt_delta</span><span class="kw">=</span><span class="fl">0.95</span>,<span class="kw">max_treedepth</span><span class="kw">=</span><span class="fl">15</span>),<span class="kw">seed</span><span class="kw">=</span><span class="fl">12345</span>)

<span class="co"># model for the reproduction number</span>
<span class="no">args</span>$<span class="no">rt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epirt.html">epirt</a></span>(
  <span class="kw">formula</span> <span class="kw">=</span> <span class="fu">R</span>(<span class="no">country</span>,<span class="no">date</span>) ~  <span class="fl">1</span> + <span class="no">lockdown</span>,
  <span class="kw">prior</span> <span class="kw">=</span> <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">location</span><span class="kw">=</span><span class="fl">0</span>,<span class="kw">scale</span><span class="kw">=</span><span class="fl">.5</span>),
  <span class="kw">prior_intercept</span> <span class="kw">=</span> <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">location</span><span class="kw">=</span><span class="fl">0</span>,<span class="kw">scale</span><span class="kw">=</span><span class="fl">2</span>)
)

<span class="no">args</span>$<span class="no">group_subset</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Italy"</span>)
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">epim</span>, <span class="no">args</span>)</pre></body></html></div>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_rt.html">plot_rt</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/plotItaly-1.png" width="1152" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_obs.html">plot_obs</a></span>(<span class="no">fit</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"deaths"</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/plotItaly-2.png" width="1152" style="display: block; margin: auto;"></p>
<p><strong>epidemia</strong> can model the evolution of an epidemic in multiple populations using hierarchical models. Here is an example where the parameterization of the time-varying reproduction number includes a country-specific intercept. This could also be extended to group specific slopes; for example by using <code>(1 + lockdown | country)</code> in place of <code>(1 | country)</code> below.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># consider two countries</span>
<span class="no">args</span>$<span class="no">group_subset</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Italy"</span>, <span class="st">"United_Kingdom"</span>)
<span class="no">args</span>$<span class="no">rt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epirt.html">epirt</a></span>(
  <span class="kw">formula</span> <span class="kw">=</span> <span class="fu">R</span>(<span class="no">country</span>, <span class="no">date</span>) ~ <span class="fl">0</span> + (<span class="fl">1</span> <span class="kw">|</span> <span class="no">country</span>) + <span class="no">lockdown</span>,
  <span class="kw">prior</span> <span class="kw">=</span> <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">location</span><span class="kw">=</span><span class="fl">0</span>,<span class="kw">scale</span><span class="kw">=</span><span class="fl">.5</span>),
  <span class="kw">prior_intercept</span> <span class="kw">=</span> <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">location</span><span class="kw">=</span><span class="fl">0</span>,<span class="kw">scale</span><span class="kw">=</span><span class="fl">2</span>),
  <span class="kw">prior_covariance</span> <span class="kw">=</span> <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">decov</a></span>(<span class="kw">scale</span><span class="kw">=</span><span class="fl">0.1</span>)
)
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>, <span class="no">args</span>)</pre></body></html></div>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_rt.html">plot_rt</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/plotIU-1.png" width="1152" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_obs.html">plot_obs</a></span>(<span class="no">fit</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"deaths"</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/plotIU-2.png" width="1152" style="display: block; margin: auto;"></p>
</div>
<div id="model-overview" class="section level1">
<h1 class="hasAnchor">
<a href="#model-overview" class="anchor"></a><span class="header-section-number">2</span> Model Overview</h1>
<p><span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span> introduced a hierarchical Bayesian approach for epidemic modeling, and applied it to assessing the effect of non-pharmaceutical interventions on the covid-19 pandemic in 11 European countries. <strong>epidemia</strong> is designed to fit models which are largely extensions of this approach. There are however important differences which will be emphasized as we go along.</p>
<p>The model is first described as it applies to modeling an epidemic within a single population. Extensions to multiple populations are considered in the subsequent section.</p>
<div id="a-single-population" class="section level2">
<h2 class="hasAnchor">
<a href="#a-single-population" class="anchor"></a><span class="header-section-number">2.1</span> A Single Population</h2>
<p>Let <span class="math inline">\(t_0\)</span> be an integer representing the first date at which the epidemic is modeled, and <span class="math inline">\(T\)</span> be the number of consecutive days over which to simulate the epidemic.</p>
<p>Observed data (daily deaths, cases etc.) are modeled a function of <span class="math inline">\(I(t)\)</span>, a process representing cumulative infections at time <span class="math inline">\(t_0 + t\)</span>. This is unobserved and evolves according to
<span class="math display" id="eq:ode">\[\begin{equation}
I'(t) =  \left(\frac{S_0-I(t)}{S_0} \right)C_{\lfloor t \rfloor}\tilde{R}_{\lfloor t \rfloor},
\tag{2.1}
\end{equation}\]</span>
where <span class="math inline">\(S_0\)</span> is the initial susceptible population at <span class="math inline">\(t_0\)</span>, <span class="math inline">\(C_t\)</span> is a measure of ‘total infectiousness’ and <span class="math inline">\(\tilde{R}_t\)</span> is the time-varying basic reproduction number. Note that both <span class="math inline">\(C_t\)</span> and <span class="math inline">\(\tilde{R}_t\)</span> are modeled as time discrete.</p>
<p>Infected individuals have an infectiousness score which depends on the date at which they were initially infected, and the generation distribution of the disease. <span class="math inline">\(C_t\)</span> aggregates this score across all infected people. More on this in Section <a href="#infections">2.1.2</a>.</p>
<p><span class="math inline">\(R^b_t\)</span> is the expected number of secondary infections arising from a typical infected individual if the entire population is susceptible and if the conditions at time <span class="math inline">\(t_0 + t\)</span> remained the same over time. This is essentially the basic reproduction number, but allowing for changing conditions which will affect contact rates over time.</p>
<p>The remainder of Section <a href="#model-overview">2</a> discusses each component of the model in greater depth, starting with the reproduction number. Section <a href="#infections">2.1.2</a> considers the infection model, paying particular attention to initial conditions (seeding), and the simulation of <span class="math inline">\(I(t)\)</span> at discrete intervals. Finally in Section <a href="#observations">2.1.3</a> the observed data is modeled as a function of these latent infections.</p>
<div id="time-varying-reproduction-number" class="section level3">
<h3 class="hasAnchor">
<a href="#time-varying-reproduction-number" class="anchor"></a><span class="header-section-number">2.1.1</span> Time-Varying Reproduction Number</h3>
<p>Recall that <span class="math inline">\(\tilde{R}_t\)</span> is akin to a time-varying basic reproduction number. It differs from the time-varying <em>effective</em> reproduction number <span class="math inline">\(R_t\)</span> in that it assumes the entire population to be susceptible. These two quantities are related by
<span class="math display">\[\begin{equation}
R_t := \left(\frac{S_0-I(t)}{S_0} \right) \tilde{R}_t.
\end{equation}\]</span></p>
<p>We model <span class="math inline">\(\tilde{R}_t\)</span> as
<span class="math display" id="eq:rt">\[\begin{equation}
R_t = 2R' \text{logit}^{-1}\left(\eta_t\right),
\tag{2.2}
\end{equation}\]</span>
where <span class="math inline">\(R'\)</span> is a constant and <span class="math inline">\(\eta_t\)</span> is a linear predictor. When <span class="math inline">\(\eta_0 = 0\)</span>, the constant <span class="math inline">\(R'\)</span> has the special interpretation of being the initial reproduction number. In general however, <span class="math inline">\(\eta_t\)</span> will contain an intercept so that <span class="math inline">\(\tilde{R}_0\)</span> can be treated as unknown. Note that <a href="#eq:rt">(2.2)</a> implies that <span class="math inline">\(\tilde{R}_t\)</span> cannot be greater than <span class="math inline">\(2R'\)</span>. Therefore <span class="math inline">\(R'\)</span> must be chosen carefully to ensure a plausible upper-bound for the series.</p>
<p>In the most general case <span class="math inline">\(\eta_t\)</span> can include pooled coefficients, group specific effects, and autocorrelation terms. This generality is most useful when extended to modeling the epidemic in multiple populations (Section <a href="#multiple-populations">2.2</a>). <span class="math inline">\(\eta_t\)</span> can be decomposed as
<span class="math display" id="eq:eta">\[\begin{equation}
\eta_t = X'_t\beta + Z'_t b + Q'_t\gamma_t
\tag{2.3}
\end{equation}\]</span>
where</p>
<ul>
<li>
<span class="math inline">\(X_t\)</span> is a <span class="math inline">\(p\)</span>-dimensional set of regressors for <em>pooled</em> coefficients <span class="math inline">\(\beta\)</span>,</li>
<li>
<span class="math inline">\(Z_t\)</span> is a <span class="math inline">\(q\)</span>-dimensional vector for group-specific effects <span class="math inline">\(b\)</span>, and</li>
<li>
<span class="math inline">\(Q_t\)</span> is a <span class="math inline">\(v\)</span>-dimensional binary vector specifying a subset of the autocorrelation processes <span class="math inline">\(\gamma_t\)</span> to include for that period.</li>
</ul>
<p>The parameters <span class="math inline">\(\beta\)</span> are assigned a prior distribution. This is flexible, and leverages the framework offered by <strong>rstanarm</strong>. Multiple different prior families are available. The group specific parameters <span class="math inline">\(b\)</span> are treated as zero-mean multivariate normal. Prior specifications are described in more detail in Section <a href="#prior-arguments">3.1.1.4</a>.</p>
<p><span class="math inline">\(\gamma_t\)</span> is a vector giving the value of each of the <span class="math inline">\(v\)</span> autocorrelation processes for period <span class="math inline">\(t\)</span>. At the moment, epidemia only supports random walk processes, however this may be extended in future versions. Each walk is assumed to be independent. <span class="math inline">\(\gamma_t\)</span> can be written as
<span class="math display">\[
\gamma_t = (\gamma^{(1)}_{t'_1(t)}, \ldots, \gamma^{(v)}_{t'_v(t)}),
\]</span>
where each <span class="math inline">\(\gamma^{(k)}_{t}\)</span> is an independent random walk whose increments may occur at different time indices. That is to say that each <span class="math inline">\(t'_k\)</span> may transform the time index. This is useful, for example, for modeling a weekly random walk, in which case <span class="math inline">\(t'_k(t)\)</span> would give the week corresponding to date <span class="math inline">\(t_0+t\)</span>. The individual walks each satisfy
<span class="math display">\[\begin{equation}
    \gamma_{t'}^{(k)} = \gamma_{t'-1}^{(k)} + \epsilon^{(k)}_{t'},
\end{equation}\]</span>
where <span class="math inline">\(\epsilon^{(k)}_{t'} \sim N(0, \sigma_k^2)\)</span>. Each <span class="math inline">\(\sigma_k\)</span> is given an independent half normal prior, such that <span class="math inline">\(\sigma_k = |X|\)</span> where <span class="math inline">\(X \sim N(0, \sigma^0_k)\)</span> for a given hyperparameter <span class="math inline">\(\sigma^0_k &gt; 0\)</span>.</p>
<p>Recall that <span class="math inline">\(\tilde{R}_t\)</span> is latent. The quantities we do observe are linked to it through its effect on the underlying infections in the population, which we now describe.</p>
</div>
<div id="infections" class="section level3">
<h3 class="hasAnchor">
<a href="#infections" class="anchor"></a><span class="header-section-number">2.1.2</span> Infections</h3>
<p>The evolution of infected individuals over time is modeled using a discrete renewal process. New infections today are taken to be a function of previous infections, a generation distribution, and the series <span class="math inline">\(\tilde{R}_t\)</span> described above. This is summarized by <a href="#eq:ode">(2.1)</a>.</p>
<p>We are only interested in the cumulative infections at discrete intervals. In particular, we simulate the series <span class="math inline">\(I_t := I(t)\)</span>, for <span class="math inline">\(t=0,\ldots,T\)</span>. Our model assumes that <span class="math inline">\(t_0\)</span> is the first day at which infections occur, and so we define <span class="math inline">\(I_{-1}=0\)</span>. For the remainder of this article <span class="math inline">\(\Delta I_t := I_t - I_{t-1}\)</span> refers to the number of new infections at a given period.</p>
<p>Before evolving infections according to <a href="#eq:ode">(2.1)</a>, we need to specify initial conditions. This is done through seeding infections for the first <span class="math inline">\(n_0 &gt; 0\)</span> days of the epidemic through letting
<span class="math display">\[
\Delta I_t \sim \text{Exponential}(\tau^{-1}),
\]</span>
for all <span class="math inline">\(0\leq t&lt;n_0\)</span>. The parameter <span class="math inline">\(\tau\)</span> is given an exponential prior with a rate hyperparameter <span class="math inline">\(\lambda_0&gt;0\)</span>. This allows the number of infections in the first <span class="math inline">\(n_0\)</span> days to be learnt by the model.</p>
<p>Infections after the seeding period evolve according to <a href="#eq:ode">(2.1)</a>. However this quantity remains ill-defined, as we have yet to define <span class="math inline">\(C_t\)</span>, the total infectiousness at period <span class="math inline">\(t_0+t\)</span>. This is a function of both previous infections and the generation distribution of the disease. This generation distribution is typically unknown. Therefore, as in <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>, we assume that it is the same as the serial interval; represented by a distribution <span class="math inline">\(s := (s_1,s_2,\ldots)\)</span> over the time from disease onset to a secondary onset. <span class="math inline">\(C_t\)</span> is then given by the discrete convolution
<span class="math display">\[
C_t := \sum_{i=0}^{t}\Delta I_i s_{t-i}.
\]</span></p>
<p>Implicit in <a href="#eq:ode">(2.1)</a> is the assumption that no reinfection can occur, so that infected individuals are permanently removed from the susceptible population. This assumption may be relaxed in future versions of epidemia.</p>
<p>Consider <a href="#eq:ode">(2.1)</a> restricted to the period <span class="math inline">\([0, 1]\)</span>. Since both <span class="math inline">\(t \to R_{\lfloor t\rfloor}\)</span> and <span class="math inline">\(t \to C_{\lfloor t\rfloor}\)</span> are constant over this period, <a href="#eq:ode">(2.1)</a> reduces to an easily solvable first-order linear ODE with constant coefficients. Generalizing this argument to other time periods shows that given <span class="math inline">\(I_{t-1}\)</span>,
<span class="math display" id="eq:inf">\[\begin{equation}
\Delta I_t = (S_0 - I_{t-1})\left( 1 -\exp\left(-\frac{R_tC_t}{S_0}\right)\right),
\tag{2.4}
\end{equation}\]</span>
for all <span class="math inline">\(t \geq n_0\)</span>. This satisfies intuitive properties. If <span class="math inline">\(R_t = 0\)</span> or if nobody is susceptible, there are no new infections. Fixing <span class="math inline">\(C_t &gt; 0\)</span> and letting <span class="math inline">\(R_t \to \infty\)</span> implies that <span class="math inline">\(I_t \to S_0\)</span>, i.e. everyone that is susceptible is infected today.</p>
<p>The reader may notice that <a href="#eq:inf">(2.4)</a> differs from the update used in <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>. This new update has the advantage of ensuring that cumulative infections never exceed the total population size.</p>
</div>
<div id="observations" class="section level3">
<h3 class="hasAnchor">
<a href="#observations" class="anchor"></a><span class="header-section-number">2.1.3</span> Observations</h3>
<p>Data is observed from <span class="math inline">\(L\)</span> series <span class="math inline">\(Y_t^{(1)}, \ldots, Y_{t}^{(L)}\)</span> with the subscript <span class="math inline">\(t\)</span> ranging between <span class="math inline">\(1\)</span> and <span class="math inline">\(T\)</span>. These series do not need to be fully observed; i.e. data may be missing for a subset of time periods. The typical example of such data would be daily death (as used in <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>) or case incidence data. However, you are not limited to this. In general,</p>
<ul>
<li>
<span class="math inline">\(Y_t^{(l)}\)</span> should represent the count of a particular ‘event’ at time <span class="math inline">\(t_0 + t\)</span>,</li>
<li>this event occurs at most once per member of the population; an example would be hospitalization data,</li>
<li>each series should be roughly conditionally independent given the underlying infection process.</li>
</ul>
<p>Extensions to more general types of data may be considered in future versions of the package. Each <span class="math inline">\(Y_t^{l}\)</span> is assumed to follow
<span class="math display">\[\begin{equation}
Y_t^{(l)} \sim \mathcal{F}^{(l)}(y_{t}^{(l)}, \phi_l),
\end{equation}\]</span>
where <span class="math inline">\(\mathcal{F}^{(l)}\)</span> represents a parametric family with mean <span class="math inline">\(y_{t}^{(l)}\)</span> and auxiliary parameter <span class="math inline">\(\phi_l\)</span>. <strong>epidemia</strong> currently supports poisson and negative binomial families. The poisson distribution has no auxiliary parameter, while for negative binomial <span class="math inline">\(\phi_l\)</span> represents the reciprocal dispersion.</p>
<p>The expected values <span class="math inline">\(y_t^{(l)}\)</span> are modeled as
<span class="math display" id="eq:ytl">\[\begin{equation}
y_{t}^{(l)} := \alpha^{(l)}_t \sum_{i=0}^{t-1} \Delta I_{i}\pi^{(l)}_{t-i}.
\tag{2.5}
\end{equation}\]</span>
This is a function of previous infections and a discrete distribution <span class="math inline">\(\pi^{(l)} = (\pi^{(l)}_1, \pi^{(l)}_2, \ldots)\)</span> on <span class="math inline">\(\mathbb{Z}^+\)</span> representing the time distribution from infection to observation, conditional on an observation occuring. This is then weighted by a factor <span class="math inline">\(\alpha_t^{(l)}\)</span> which represents the probability that any event occuring at time <span class="math inline">\(t_0 + t\)</span> is actually recorded as an observation.</p>
<p>To give intuition on the above quantities, suppose for now that the <span class="math inline">\(l\)</span><sup>th</sup> observation process recorded daily death counts. Then <span class="math inline">\(\pi^{(l)}_{t}\)</span> is the probability, conditional on a death being recorded today, that this individual was infected exactly <span class="math inline">\({t}\)</span> days prior. <span class="math inline">\(\alpha^{(l)}_t\)</span> is then the time-varying infection fatality ratio (IFR) for the given population.</p>
<p>Of course <span class="math inline">\(\alpha^{(l)}_t\)</span> may vary over the course of an epidemic. For example, the infection fatality ratio may change over time as a result of improved treatments. Alternatively for case counts this is the infection ascertainment rate, which may improve over time as a result of increased testing capacity and track and trace systems. To allow for this <span class="math inline">\(\alpha^{(l)}_t\)</span> takes the form
<span class="math display">\[\begin{equation}
\alpha^{(l)}_t = f^{(l)} \left(o^{(l)} + X^{(l)'}_t \beta^{(l)}\right),
\end{equation}\]</span>
where <span class="math inline">\(f\)</span> is a link function, <span class="math inline">\(o^{(l)}\)</span> is a set of known offsets, and <span class="math inline">\(X^{(l)}\)</span> is a <span class="math inline">\(p_l\)</span>-dimensional set of regressors for <span class="math inline">\(\beta^{(l)}\)</span>.</p>
<p>Although not as flexible as <a href="#eq:eta">(2.3)</a>, this is powerful enough to model the aforementioned effects. The user can choose the parameterisation, and the priors on <span class="math inline">\(\beta^{(l)}\)</span>. Future versions of <strong>epidemia</strong> may extend this to allow for partial pooling.</p>
<p>The distribution <span class="math inline">\(\pi^{(l)}\)</span> in <a href="#eq:ytl">(2.5)</a> is <em>treated as known</em>, however in the future we may allow it to be parameterized by unknown quantities. One possibility in this direction would be to view <span class="math inline">\(\pi^{(l)}\)</span> as a discretization of a continuous parametric distribution. The parameters could be given priors to represent our uncertainty over the interval. The Gamma distribution may be a suitable candidate for this.</p>
</div>
</div>
<div id="multiple-populations" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-populations" class="anchor"></a><span class="header-section-number">2.2</span> Multiple Populations</h2>
<p>Previously we described models for an epidemic occuring in a single homogenous population. Here we describe how to adapt this model for simultaneously modeling multiple separate populations. These populations could represent different age cohorts, different states within a country, or even different countries.</p>
<p>Suppose now that there are <span class="math inline">\(M\)</span> non-overlapping populations with differing start dates <span class="math inline">\(t^{(m)}_0\)</span> and epidemic lengths <span class="math inline">\(T_m\)</span>. As before, start by considering the model for the time-varying reproduction number. Fix <span class="math inline">\(t\)</span> and now let
<span class="math display">\[
\tilde{R}_t := (\tilde{R}_{t,1}, \ldots \tilde{R}_{t,M}),
\]</span>
where <span class="math inline">\(\tilde{R}_{t,m}\)</span> is the unadjusted reproduction number at time <span class="math inline">\(t\)</span> for population <span class="math inline">\(m\)</span>.</p>
<p><span class="math inline">\(\tilde{R}_t\)</span> follows the same form as in <a href="#eq:rt">(2.2)</a> with <span class="math inline">\(\eta_t\)</span> now being<br><span class="math display" id="eq:etapooled">\[\begin{equation}
\eta_t = X_t\beta + Z_t b + Q_t\gamma_t,
\tag{2.6}
\end{equation}\]</span>
where <span class="math inline">\(X_t\)</span>, <span class="math inline">\(Z_t\)</span> and <span class="math inline">\(Q_t\)</span> are <span class="math inline">\(M \times p\)</span>, <span class="math inline">\(M \times q\)</span> and <span class="math inline">\(M \times v\)</span> model matrices for the pooled coefficients, group specific effects and autocorrelation terms respectively.</p>
<p>The parameterization implied by <a href="#eq:etapooled">(2.6)</a> is very flexible. The user can choose which parameters to pool and which to retain as group-level effects. Moreover, multiple random walks can be specified and shared between populations, or according to some other grouping variable like region, or even by grouping different time periods.</p>
<p>The model for the infection processes within populations remains largely the same. In future versions of the package, we will extend this to allow for importations between groups. The parameter <span class="math inline">\(\tau\)</span> controlling initial infections is pooled between all populations.</p>
<p>The observation model remains the same, with the parameters <span class="math inline">\(\beta^{(l)}\)</span> shared between all groups. The auxiliary parameters <span class="math inline">\(\phi_l\)</span> are pooled and the infection to observations distributions <span class="math inline">\(\pi^{(l)}\)</span> are assumed the same for each population.</p>
</div>
</div>
<div id="r-implementation" class="section level1">
<h1 class="hasAnchor">
<a href="#r-implementation" class="anchor"></a><span class="header-section-number">3</span> R Implementation</h1>
<p><strong>epidemia</strong> is designed to fit the models described in Section <a href="#model-overview">2</a>. In particular, it uses R’s formula interface to parameterize the time-varying reproduction number in terms of a number of covariates (see <a href="#eq:etapooled">(2.6)</a>). The implementation of this shares many similarities with the <code>stan_glmer</code> function in <strong>rstanarm</strong> and the <code>glmer</code> function in <strong>lme4</strong>.</p>
<div id="model-fitting-using-epim" class="section level2">
<h2 class="hasAnchor">
<a href="#model-fitting-using-epim" class="anchor"></a><span class="header-section-number">3.1</span> Model fitting using <code>epim</code>
</h2>
<p>As mentioned in the introduction, the primary model fitting function in <strong>epidemia</strong> is <code>epim</code>. We now describe this function in depth. Section <a href="#function-arguments">3.1.1</a> details the formal arguments to <code>epim</code>, and links them where possible to the mathematical notation used in Section <a href="#model-overview">2</a>.</p>
<div id="function-arguments" class="section level3">
<h3 class="hasAnchor">
<a href="#function-arguments" class="anchor"></a><span class="header-section-number">3.1.1</span> Function Arguments</h3>
<p>Table <a href="#tab:epimArgs">3.1</a> lists the formal arguments to <code>epim</code>.</p>
<table class="table">
<caption>
<span id="tab:epimArgs">Table 3.1: </span>Formal arguments for the epim function</caption>
<colgroup>
<col width="4%">
<col width="92%">
<col width="3%">
</colgroup>
<thead><tr class="header">
<th align="left">Arguments</th>
<th align="left">Description</th>
<th align="left">Class</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">rt</td>
<td align="left">A call to <code>epirt</code>, specifying the model <a href="#eq:etapooled">(2.6)</a> for the unadjusted time-varying reproduction number.</td>
<td align="left">epirt</td>
</tr>
<tr class="even">
<td align="left">data</td>
<td align="left">A data frame containing all data required to fit the model. See <a href="https://www.rdocumentation.org/packages/lme4/versions/1.1-23/topics/glmer">glmer</a> for more details.</td>
<td align="left">data.frame</td>
</tr>
<tr class="odd">
<td align="left">obs</td>
<td align="left">A list of calls to <code>epiobs</code>. Each component specifies the model for an observation.</td>
<td align="left">list</td>
</tr>
<tr class="even">
<td align="left">pops</td>
<td align="left">Population of each modeled group. The first column represents the group and the second giving the corresponding population.</td>
<td align="left">data.frame</td>
</tr>
<tr class="odd">
<td align="left">si</td>
<td align="left">A vector representing the serial interval of the disease. This should be a simplex vector - i.e. all elements are non-negative and sum to one. The <span class="math inline">\(n\)</span><sup>th</sup> element gives the probability an individual infects another <span class="math inline">\(n\)</span> days after disease onset.</td>
<td align="left">numeric</td>
</tr>
<tr class="even">
<td align="left">seed_days</td>
<td align="left">Number of days <span class="math inline">\(n_0\)</span> for which to seed infections at the start of the epidemic. Defaults to 6L</td>
<td align="left">integer</td>
</tr>
<tr class="odd">
<td align="left">algorithm</td>
<td align="left">The algorithm used to fit the model. Must be one of ‘sampling’, ‘meanfield’ or ‘fullrank’, which correspond to <code>rstan</code> sampling methods. See <a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html">sampling</a> and <a href="https://mc-stan.org/rstan/reference/stanmodel-method-vb.html">vb</a>.</td>
<td align="left">character</td>
</tr>
<tr class="even">
<td align="left">group_subset</td>
<td align="left">An optional vector specifying a subset of groups to model. Elements should correspond to the group levels specified through the <code>data</code> argument.</td>
<td align="left">character</td>
</tr>
<tr class="odd">
<td align="left">prior_tau</td>
<td align="left">Prior on <span class="math inline">\(\tau\)</span>, the parameter controling the variability in the seeded cases.</td>
<td align="left">list</td>
</tr>
<tr class="even">
<td align="left">prior_PD</td>
<td align="left">Flag whether to sample from the prior distribution. Same as <a href="https://mc-stan.org/rstanarm/reference/stan_lm.html">stan_lm</a>. Defaults to <code>FALSE</code>.</td>
<td align="left">logical</td>
</tr>
<tr class="odd">
<td align="left">sampling_args</td>
<td align="left">An (optional) named list of parameters to pass to the rstan function used for model fitting. See <a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html">sampling</a> and <a href="https://mc-stan.org/rstan/reference/stanmodel-method-vb.html">vb</a> for details of possible arguments.</td>
<td align="left">list</td>
</tr>
</tbody>
</table>
<p>Most of the arguments listed in Table <a href="#tab:epimArgs">3.1</a> are self-explanatory. However the first three and also the prior arguments require further explanation. We tackle each of these in turn.</p>
<div id="rt-argument" class="section level4">
<h4 class="hasAnchor">
<a href="#rt-argument" class="anchor"></a><span class="header-section-number">3.1.1.1</span> <code>rt</code> Argument</h4>
<p>This specifies the model for the time-varying reproduction number, given by <a href="#eq:etapooled">(2.6)</a>. This is done via a call to <code>epirt</code>, whose arguments include a <code>formula</code> and arguments to specify the prior distributions for the model.</p>
<p>The LHS of the <code>formula</code> argument must take the form <code>R(group,date)</code>. This is just syntactic sugar to make explicit that the model is for the reproduction number for a given population and date. The RHS can include booth pooled and unpooled terms. Autocorrelation terms may also be included. For more details on interpreting different formulas, please see <a href="https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf">here</a>.</p>
<p>We briefly give an intepretation for specific models in the context of the Europe data. First note that terms in the formula must correspond to column names in <code>data</code>, which are</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">EuropeCovid</span>$<span class="no">data</span>)</pre></body></html></div>
<pre><code>## [1] "country"                      "date"                        
## [3] "schools_universities"         "self_isolating_if_ill"       
## [5] "public_events"                "lockdown"                    
## [7] "social_distancing_encouraged" "deaths"</code></pre>
<p>Suppose for simplicity that the value of all covariates at the start date of each group is zero, so that the intercept can be interpreted as determining the starting reproduction number <span class="math inline">\(R_0\)</span> of the disease (this is indeed the case for the Europe example). Then</p>
<ul>
<li><p><code>R(country, date) ~ 0 + lockdown</code> This is a no-intercept model. The effect is to set an exact <span class="math inline">\(R_0\)</span> which is <em>the same for all countries</em>. This potentially changes at dates for which <code>lockdown</code> become non-zero (i.e. after the intervention come into place). The starting value is precisely <span class="math inline">\(R'\)</span> defined in <a href="#eq:rt">(2.2)</a>.</p></li>
<li><p><code>R(country, date) ~ 1 + lockdown</code> The intercept is the same for all countries. This implies a common distribution for <span class="math inline">\(R_0\)</span>, which is set by the argument <code>prior_intercept</code>.</p></li>
<li><p><code>R(country, date) ~ (1 | country) + lockdown</code> A country-specific intercept allows the distribution of <span class="math inline">\(R_0\)</span> to depend on the country. The prior on these is controlled by both the arguments <code>prior_intercept</code> and <code>prior_covariance</code> to <code>epirt</code>.</p></li>
</ul>
<p><code>epirt</code> has three different prior arguments: <code>prior</code>, <code>prior_intercept</code>, and <code>prior_covariance</code>. The latter is only used if at least one random effect term has been specified.</p>
</div>
<div id="data-argument" class="section level4">
<h4 class="hasAnchor">
<a href="#data-argument" class="anchor"></a><span class="header-section-number">3.1.1.2</span> <code>data</code> argument</h4>
<p>The <code>data</code> argument should be a data frame providing all covariates and observations specified by either the reproduction number model, or in any of the observation models. It must contain at least two columns which give the modeled populations and simulation dates. In the Europe example, the columns <code>country</code> and <code>date</code> serve this purpose. The <code>country</code> column must be coercible to class <code>factor</code>, and the levels of this column determine the possible populations to model.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">data</span> <span class="kw">&lt;-</span> <span class="no">EuropeCovid</span>$<span class="no">data</span>
<span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="no">data</span>$<span class="no">country</span>)</pre></body></html></div>
<pre><code>##  [1] "Austria"        "Belgium"        "Denmark"        "France"        
##  [5] "Germany"        "Italy"          "Norway"         "Spain"         
##  [9] "Sweden"         "Switzerland"    "United_Kingdom"</code></pre>
<p>If specified, only the populations given in the <code>group_subset</code> argument to <code>epim</code> are modeled. Otherwise, all levels are used.</p>
<p>The <code>dates</code> column must be coercible to a ‘Date’ vector. Dates must be consecutive for each modeled group, because it is neccessary to simulate the reproduction number at each date of the epidemic. This means that covariates for the reproduction number model may not contain missing values. This is not neccessarily the case for the observation models, where NAs can simply be omitted.</p>
<p>The first date is taken to be the start date <span class="math inline">\(t^{(m)}_0\)</span> of the epidemic in that population, and the final date is taken to be <span class="math inline">\(t^{(m)} + T\)</span>.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">agg</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>,<span class="no">f</span>) <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(<span class="no">x</span>$<span class="no">date</span>, <span class="kw">by</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">x</span>$<span class="no">country</span>), <span class="kw">FUN</span><span class="kw">=</span><span class="no">f</span>)
<span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fu">agg</span>(<span class="no">data</span>, <span class="no">min</span>),
               <span class="fu">agg</span>(<span class="no">data</span>, <span class="no">max</span>)[,<span class="fl">2</span>]),
         <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"country"</span>, <span class="st">"start"</span>, <span class="st">"date"</span>))</pre></body></html></div>
<pre><code>##           country      start       date
## 1         Austria 2020-02-22 2020-05-05
## 2         Belgium 2020-02-18 2020-05-05
## 3         Denmark 2020-02-21 2020-05-05
## 4          France 2020-02-07 2020-05-05
## 5         Germany 2020-02-15 2020-05-05
## 6           Italy 2020-01-27 2020-05-05
## 7          Norway 2020-02-24 2020-05-05
## 8           Spain 2020-02-09 2020-05-05
## 9          Sweden 2020-02-18 2020-05-05
## 10    Switzerland 2020-02-14 2020-05-05
## 11 United_Kingdom 2020-02-13 2020-05-05</code></pre>
<p>Following <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>, the start dates shown above are thirty days prior to the first date for which more than 10 cumulative deaths were observed in the given country. They are <em>not learnt by the model</em>, rather they are assumed and specified by the user.</p>
</div>
<div id="obs-argument" class="section level4">
<h4 class="hasAnchor">
<a href="#obs-argument" class="anchor"></a><span class="header-section-number">3.1.1.3</span> <code>obs</code> argument</h4>
<p>This gives a list of observation models. Each component of the list must be a call to <code>epiobs</code>. As in <code>epirt</code>, this has a <code>formula</code> argument and arguments <code>prior</code> and <code>prior_intercept</code> to specify model priors. There is no <code>prior_covariance</code> argument because random effect terms are not permitted in <code>formula</code>. This may be allowed in future versions of <strong>epidemia</strong>.</p>
<p>The <code>family</code> argument specifies whether the error model is negative binomial or Poisson. In the former case, <code>prior_aux</code> specifies the prior on the reciprocal dispersion. In the latter, <code>prior_aux</code> is ignored because there is no auxiliary parameter. The function <span class="math inline">\(f^{(l)}\)</span> introduced in Section <a href="#observations">2.1.3</a> is controlled by <code>link</code>.The <code>i2o</code> argument gives the infection to observation distribution <span class="math inline">\(\pi^{(l)}\)</span>.</p>
<p>The <code>EuropeCovid</code> data contains an example of the <code>obs</code> argument. It uses only one type of observation, death data, and so <span class="math inline">\(L=1\)</span> in this case.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">deaths</span> <span class="kw">&lt;-</span> <span class="no">EuropeCovid</span>$<span class="no">obs</span>$<span class="no">deaths</span></pre></body></html></div>
<p>We can inspect the model as follows.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">deaths</span>$<span class="no">formula</span></pre></body></html></div>
<pre><code>## deaths(country, date) ~ 1</code></pre>
<p>Visualise the distribution of time from disease onset to death.</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(<span class="no">deaths</span>$<span class="no">i2o</span>, <span class="kw">names.arg</span><span class="kw">=</span><span class="fl">1</span>:<span class="fl">101</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/pvec-1.png" width="672" style="display: block; margin: auto;">
Following <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>, this is a discretization of the distribution of <span class="math inline">\(\text{Gamma}(1.35,3.77) + \text{Gamma}(4.94,3.60)\)</span>, where the notation <span class="math inline">\(\text{Gamma}(\alpha, \theta)\)</span> refers to a Gamma random variable with shape <span class="math inline">\(\alpha\)</span> and scale <span class="math inline">\(\theta\)</span>.</p>
</div>
<div id="prior-arguments" class="section level4">
<h4 class="hasAnchor">
<a href="#prior-arguments" class="anchor"></a><span class="header-section-number">3.1.1.4</span> Prior arguments</h4>
<p>Prior distributions ought to be specified for all <code>epirt</code> and <code>epiobs</code> objects. A prior should also be set for the seeding parameter <code>tau</code> in the call to <code>epim</code>.</p>
<p><em>Please note that the current default priors may not be appropriate, and should not be relied upon. In future versions of the package, we hope to set good default priors.</em></p>
<p>Consider <span class="math inline">\(\beta\)</span> in <a href="#eq:etapooled">(2.6)</a>. The priors for this are set using the <code>prior</code> and <code>prior_intercept</code> argument to <code>epirt</code>. These will only have an effect if the formula specifies covariates and an intercept respectively. These function similarly to the same arguments in <a href="https://mc-stan.org/rstanarm/reference/stan_lm.html"><code>stan_lm</code></a>. To better understan which families are supported please refer to <a href="https://mc-stan.org/rstanarm/reference/priors.html">rstanarm’s priors</a>.</p>
<p>There is one caveat: which is that we offer additional priors. Currently there is just one, <code>shifted_gamma</code>, which can only be used for the <code>prior</code> argument. The addition of this prior is motivated by the priors used in <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>. This essentially allows for
<span class="math display">\[\begin{equation}
\beta_i \sim \text{Gamma}(\alpha,\theta) - \eta,
\end{equation}\]</span>
where <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\theta\)</span> are shape and scale parameters, and <span class="math inline">\(\eta\)</span> is a shift to allow for priors with support below zero.</p>
<p>Consider a single ‘random-effects’ term in the formula for <code>epirt</code>. A good example would be <code>(1 + lockdown | country)</code>. For each group the intercepts and slopes are treated as zero-mean multivariate normal with unknown covariance matrix <span class="math inline">\(\Sigma\)</span>. For our example term, fix one level implied by the factor <code>country</code>, say <code>"Italy"</code>. For this group, there are two coefficients - a random intercept for Italy, and a random slope. Therefore <span class="math inline">\(\Sigma\)</span> has dimension <span class="math inline">\(2 \times 2\)</span>. Coefficients for different groups are treated as independent.</p>
<p><strong>epidemia</strong> borrows from <strong>rstanarm</strong> and uses the <a href="rstanarm%20priors"><code>decov</code></a> prior for <span class="math inline">\(\Sigma\)</span>. This decomposes <span class="math inline">\(\Sigma\)</span> into a variance vector and a correlation matrix. An LKJ prior is used on the correlation matrix, while the variance is decomposed into the product of a simplex vector and the trace of <span class="math inline">\(\Sigma\)</span>. The simplex vector is given a symmetric Dirichlet prior, which the trace is once again decomposed as <span class="math inline">\(tr(\Sigma) = J \kappa\)</span>, where <span class="math inline">\(J\)</span> is the order of <span class="math inline">\(\Sigma\)</span>. Finally <span class="math inline">\(\kappa\)</span> is assigned a scale-invariant prior - specifically a Gamma distribution with give shape and scale hyperparameters. For more information on this, please see <a href="http://mc-stan.org/rstanarm/reference/priors.html">rstanarm priors</a> and this <a href="http://mc-stan.org/rstanarm/articles/glmer.html">vignette</a>.</p>
<p>When the left hand side of the formula has only one term (for example <code>(1 | country)</code>), this prior on the covariance simplifies considerably. <span class="math inline">\(\Sigma\)</span> simply reduces to <span class="math inline">\(\kappa\)</span>, which has a gamma prior.</p>
</div>
</div>
</div>
</div>
<div id="a-more-complete-example" class="section level1">
<h1 class="hasAnchor">
<a href="#a-more-complete-example" class="anchor"></a><span class="header-section-number">4</span> A More Complete Example</h1>
<p>Here we demonstrate how to specify different prior distributions in practice, using the Europe data restricted to Germany and the United Kingdom as an example. In particular, we demonstrate the utility of the <code>prior_PD</code> flag for sampling from the prior predictive distribution. This allows you to easily visualise the prior assumptions on the reproduction number. Various methods that can be used on fitted models (<code>epimodel</code>) are demonstrated.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">args</span>$<span class="no">group_subset</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Germany"</span>, <span class="st">"United_Kingdom"</span>)</pre></body></html></div>
<p>Similar to <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>, we specify the following model.</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">args</span>$<span class="no">rt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epirt.html">epirt</a></span>(
  <span class="kw">formula</span> <span class="kw">=</span> <span class="fu">R</span>(<span class="no">country</span>,<span class="no">date</span>) ~ (<span class="fl">1</span> <span class="kw">|</span> <span class="no">country</span>) + <span class="no">schools_universities</span> + <span class="no">self_isolating_if_ill</span> + <span class="no">public_events</span> + <span class="no">lockdown</span> + <span class="no">social_distancing_encouraged</span>,
  <span class="kw">prior</span> <span class="kw">=</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">scale</span> <span class="kw">=</span> <span class="fl">0.5</span>),
  <span class="kw">prior_intercept</span> <span class="kw">=</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">location</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">scale</span> <span class="kw">=</span> <span class="fl">0.5</span>)
)</pre></body></html></div>
<p>This model allows a separate initial reproduction number for each country, and includes 6 different non-pharamceutical interventions (NPIs) to explain the changes to the number over time.</p>
<div id="prior-specification" class="section level2">
<h2 class="hasAnchor">
<a href="#prior-specification" class="anchor"></a><span class="header-section-number">4.1</span> Prior Specification</h2>
<p>Here we focus on specifying the <code>prior</code> argument. This controls the prior distribution of the coefficients in the regression. Any of the rstanarm priors can be used. We have also added a <code>shifted_gamma</code> prior to replicate the prior in <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>.</p>
<p>To quickly visualise the effect of the prior distribution we can used the <code>prior_PD</code> flag to <code>epim</code>. If <code>TRUE</code> epim will sample all parameters from their prior distribution. We specify the prior for the intercept as follows.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">args</span>$<span class="no">algorithm</span> <span class="kw">&lt;-</span> <span class="st">"sampling"</span>
<span class="no">args</span>$<span class="no">sampling_args</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">iter</span><span class="kw">=</span><span class="fl">500</span>,<span class="kw">control</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">adapt_delta</span><span class="kw">=</span><span class="fl">0.95</span>,<span class="kw">max_treedepth</span><span class="kw">=</span><span class="fl">15</span>))
<span class="no">args</span>$<span class="no">prior_PD</span> <span class="kw">&lt;-</span> <span class="fl">TRUE</span>
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">epim</span>, <span class="no">args</span>)
<span class="fu"><a href="../reference/plot_rt.html">plot_rt</a></span>(<span class="no">fit</span>, <span class="kw">adjusted</span><span class="kw">=</span><span class="no">F</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/normalPrior-1.png" width="672" style="display: block; margin: auto;"></p>
<p>And example of using a shifted gamma prior…</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">args</span>$<span class="no">rt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epirt.html">epirt</a></span>(
  <span class="kw">formula</span> <span class="kw">=</span> <span class="fu">R</span>(<span class="no">country</span>,<span class="no">date</span>) ~ (<span class="fl">1</span> <span class="kw">|</span> <span class="no">country</span>) + <span class="no">schools_universities</span> + <span class="no">self_isolating_if_ill</span> + <span class="no">public_events</span> + <span class="no">lockdown</span> + <span class="no">social_distancing_encouraged</span>,
  <span class="kw">prior</span> <span class="kw">=</span> <span class="fu"><a href="../reference/shifted_gamma.html">shifted_gamma</a></span>(<span class="kw">shape</span><span class="kw">=</span><span class="fl">1</span>/<span class="fl">6</span>, <span class="kw">scale</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">shift</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">1.05</span>)/<span class="fl">6</span>),
  <span class="kw">prior_intercept</span> <span class="kw">=</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">location</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">scale</span> <span class="kw">=</span> <span class="fl">0.5</span>)
)
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">epim</span>, <span class="no">args</span>)
<span class="fu"><a href="../reference/plot_rt.html">plot_rt</a></span>(<span class="no">fit</span>, <span class="kw">adjusted</span><span class="kw">=</span><span class="no">F</span>)</pre></body></html></div>
<p><img src="introduction_files/figure-html/gammaPrior-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The above plots give a good indication of the implications of different prior families.</p>
</div>
<div id="methods-for-epimodels" class="section level2">
<h2 class="hasAnchor">
<a href="#methods-for-epimodels" class="anchor"></a><span class="header-section-number">4.2</span> Methods for <code>epimodels</code>
</h2>
<p>Fitting the model to the data…</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">args</span>$<span class="no">prior_PD</span> <span class="kw">=</span> <span class="fl">FALSE</span>
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>, <span class="no">args</span>)</pre></body></html></div>
<p>Printing the object gives a brief summary of estimated coefficients and standard errors. This is very similar to the print method for <a href="http://mc-stan.org/rstanarm/reference/stanreg-objects.html"><code>stanreg</code></a> objects.</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">fit</span>, <span class="kw">digits</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p>You can retrieve the prior distributions used easily with the following.</p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="fu"><a href="https://mc-stan.org/rstantools/reference/prior_summary.html">prior_summary</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<pre><code>## Priors for model 'fit' 
## ----------
##  Regression for  R :
## ----
## Intercept
##  ~ normal(location = 0, scale = 0.5)
## 
## Coefficients
##  ~ gamma(shape = [0.167,0.167,0.167,...], scale = [1,1,1,...], shift = [0.00813,0.00813,0.00813,...])
## 
## Covariance
##  ~ decov(reg. = 1, conc. = 1, shape = 1, scale = 0.5)
## ----
##  Regression for  deaths :
## ----
## Intercept
##  ~ normal(location = 0.01, scale = 0.001)
## 
##  reciprocal dispersion
##  ~ exponential(rate = 1)
## ----
## See help('prior_summary.epimodel') for more details</code></pre>
<p>Often it will be useful to obtain the MCMC draws for sampled parameters. This can be done using <code>as.matrix</code>, <code>as.array</code>, or <code>as.data.frame</code>. Here is an example of using <code>as.matrix</code>.</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="no">draws</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">fit</span>)
<span class="no">draws</span>[<span class="fl">1</span>:<span class="fl">5</span>,<span class="fl">1</span>:<span class="fl">5</span>]</pre></body></html></div>
<pre><code>##           parameters
## iterations R|(Intercept) R|schools_universities R|self_isolating_if_ill
##       [1,]     0.5092952           -0.411224149             -0.43337151
##       [2,]     0.4403600           -0.593767924             -0.35688656
##       [3,]     0.5179706           -0.313838759             -0.05178866
##       [4,]     0.7496354           -0.147739026             -0.32393192
##       [5,]     0.7711350            0.007841624             -1.00834615
##           parameters
## iterations R|public_events R|social_distancing_encouraged
##       [1,]       -2.148474                   -0.541779316
##       [2,]       -2.197250                   -0.204239094
##       [3,]       -2.223381                   -0.283055680
##       [4,]       -2.231270                   -0.341593938
##       [5,]       -2.656384                    0.008125047</code></pre>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-Flaxman2020">
<p>Flaxman, Seth, Swapnil Mishra, Axel Gandy, H Juliette T Unwin, Thomas A Mellan, Helen Coupland, Charles Whittaker, et al. 2020. “Estimating the effects of non-pharmaceutical interventions on COVID-19 in Europe.” <em>Nature</em>. <a href="https://doi.org/10.1038/s41586-020-2405-7">https://doi.org/10.1038/s41586-020-2405-7</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by James Scott, Axel Gandy, Swapnil Mishra, Juliette Unwin, Seth Flaxman, Samir Bhatt.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
