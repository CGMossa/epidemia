<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flexible Epidemic Modeling with epidemia • epidemia</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Flexible Epidemic Modeling with epidemia">
<meta property="og:description" content="epidemia">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epidemia</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/IncidenceOnly.html">Modelling of R  with only Incidence data</a>
    </li>
    <li>
      <a href="../articles/ResolvingProblems.html">Resolving Problems</a>
    </li>
    <li>
      <a href="../articles/TimeDependentR.html">Time-dependent Modelling of R</a>
    </li>
    <li>
      <a href="../articles/introduction.html">Flexible Epidemic Modeling with epidemia</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ImperialCollegeLondon/epidemia/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="introduction_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Flexible Epidemic Modeling with epidemia</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ImperialCollegeLondon/epidemia/blob/master/vignettes/introduction.Rmd"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="hidden name"><code>introduction.Rmd</code></div>

    </div>

    
    
<style type="text/css">
body{ /* Normal */
font-size: 16px;
}
td { /* Table */
font-size: 14px;
}
h1.title {
font-size: 38px;
color: Black;
}
h1 { /* Header 1 */
font-size: 28px;
color: Black;
}
h2 { /* Header 2 */
font-size: 22px;
color: DarkBlue;
}
h3 { /* Header 3 */
font-size: 18px;
color: DarkBlue;
}
}
h3 { /* Header 4 */
font-size: 16px;
color: DarkBlue;
}
h4 { /* Header 4 */
font-size: 16px;
color: DarkBlue;
}
code.r{ /* Code block */
font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
font-size: 14px;
}
</style>
<p><strong>Note:</strong> <em>This vignette is a work in progress, and will be regularly updated.</em></p>
<p><strong>epidemia</strong> is an R-package for fitting Bayesian epidemic models in the style of <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>. Here we detail these models and give users enough information to start fitting them independently.</p>
<p>The document is organized as follows. Section <a href="#example-usage">1</a> provides basic examples with minimal description, so that users can quickly get a feel for the package. Section <a href="#model-overview">2</a> gives a formal framework for the models within the scope of the package. Understanding this framework is essential for making the most of the flexibility offered by <strong>epidemia</strong>. Section <a href="#r-implementation">3</a> discusses the details of <code>epim</code>; the primary model fitting function in the package. <code>epim</code> is designed to be flexible, and therefore has a number of arguments. This can be intimidating, so we describe these arguments in a lot of detail. Finally Section <a href="#a-more-complete-example">4</a> highlights some of the more useful features of the package.</p>
<p><strong>epidemia</strong> contains an example dataset <code>EuropeCovid</code>, which contains data on the daily deaths from Covid-19 recorded in 11 European countries. This will be used as a running example throughout the vignette.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/ImperialCollegeLondon/epidemia">epidemia</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/yihui/xfun">xfun</a></span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"EuropeCovid"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span>(mc.cores = <span class="kw">parallel</span>::<span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>())
</pre></div>
<p>The line <code><a href="https://rdrr.io/r/base/options.html">options(mc.cores = parallel::detectCores())</a></code> is important if MCMC sampling is used, as it allows different chains to be run in parallel, rather than sequentially.</p>
<div id="example-usage" class="section level1">
<h1 class="hasAnchor">
<a href="#example-usage" class="anchor"></a><span class="header-section-number">1</span> Example Usage</h1>
<p>Here we provide code snippets showing basic usage of <strong>epidemia</strong>. Below considers fitting a model to the Italian data, and demonstrates usage of various arguments to <code>epim</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co"># collect arguments for 'epim'</span>
<span class="kw">args</span> <span class="op">&lt;-</span> <span class="kw">EuropeCovid</span>
<span class="kw">args</span><span class="op">$</span><span class="kw">algorithm</span> <span class="op">&lt;-</span> <span class="st">"sampling"</span>
<span class="kw">args</span><span class="op">$</span><span class="kw">sampling_args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(iter=<span class="fl">1e3</span>,control=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(adapt_delta=<span class="fl">0.95</span>,max_treedepth=<span class="fl">15</span>),seed=<span class="fl">12345</span>)
<span class="kw">args</span><span class="op">$</span><span class="kw">group_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Italy"</span>)
<span class="kw">args</span><span class="op">$</span><span class="kw">formula</span> <span class="op">&lt;-</span> <span class="fu">R</span>(<span class="kw">country</span>,<span class="kw">date</span>) <span class="op">~</span>  <span class="fl">1</span> <span class="op">+</span> <span class="kw">lockdown</span>
<span class="kw">args</span><span class="op">$</span><span class="kw">prior</span> <span class="op">&lt;-</span> <span class="kw">rstanarm</span>::<span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(location=<span class="fl">0</span>,scale=<span class="fl">.5</span>)
<span class="kw">args</span><span class="op">$</span><span class="kw">prior_intercept</span> <span class="op">&lt;-</span> <span class="kw">rstanarm</span>::<span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(location=<span class="fl">0</span>,scale=<span class="fl">2</span>)
<span class="kw">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>, <span class="kw">args</span>)
</pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">gridExtra</span>)
<span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="fu">plot_obs</span>(<span class="kw">fit</span>, type=<span class="st">"deaths"</span>), <span class="fu">plot_infections</span>(<span class="kw">fit</span>), <span class="fu">plot_rt</span>(<span class="kw">fit</span>),nrow=<span class="fl">3</span>)
</pre></div>
<p><img src="introduction_files/figure-html/plotItaly-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Often we would like to model more than one population. Here is an example of using multiple populations, where the regression for the time-varying reproduction number includes a country-specific intercept. This could also be extended to group specific slopes; for example by using <code>(1 + lockdown | country)</code> in place of <code>(1 | country)</code> in <code>args$formula</code> below.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="co"># collect arguments for 'epim'</span>
<span class="kw">args</span><span class="op">$</span><span class="kw">group_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Italy"</span>, <span class="st">"United_Kingdom"</span>)
<span class="kw">args</span><span class="op">$</span><span class="kw">formula</span> <span class="op">&lt;-</span> <span class="fu">R</span>(<span class="kw">country</span>,<span class="kw">date</span>) <span class="op">~</span>  <span class="fl">0</span> <span class="op">+</span> (<span class="fl">1</span><span class="op">|</span><span class="kw">country</span>) <span class="op">+</span> <span class="kw">lockdown</span>
<span class="kw">args</span><span class="op">$</span><span class="kw">prior_covariance</span> <span class="op">&lt;-</span> <span class="kw">rstanarm</span>::<span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">decov</a></span>(scale=<span class="fl">0.1</span>) 
<span class="kw">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>, <span class="kw">args</span>)
</pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu">plot_obs</span>(<span class="kw">fit</span>, type = <span class="st">"deaths"</span>)
</pre></div>
<p><img src="introduction_files/figure-html/plotIU-1.png" width="1152" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu">plot_rt</span>(<span class="kw">fit</span>)
</pre></div>
<p><img src="introduction_files/figure-html/plotIU-2.png" width="1152" style="display: block; margin: auto;"></p>
</div>
<div id="model-overview" class="section level1">
<h1 class="hasAnchor">
<a href="#model-overview" class="anchor"></a><span class="header-section-number">2</span> Model Overview</h1>
<p><span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span> introduced a hierarchical Bayesian approach for epidemic modeling, and applied it to assessing the effect of non-pharmaceutical interventions on the covid-19 pandemic in 11 European countries. <strong>epidemia</strong> is designed to fit models which are largely extensions of this approach. There are however important differences which will be emphasized as we go along. The model is first described as it applies to a single population. Extensions to multiple populations are considered in the subsequent section.</p>
<div id="a-single-population" class="section level2">
<h2 class="hasAnchor">
<a href="#a-single-population" class="anchor"></a><span class="header-section-number">2.1</span> A Single Population</h2>
<p>Let <span class="math inline">\(t_0\)</span> be an integer representing the first date at which infections are non-zero in the population, and let <span class="math inline">\(T\)</span> be the number of consecutive days over which to simulate the epidemic.</p>
<p>The basic idea behind the model is that the observed quantities (daily deaths, incidence rates etc.) are a function of the latent infections in the population over time. These infections are in turn a function of the <em>time-varying reproduction number</em>. This number may be explained by a number of covariates; for example non-pharmaceutical interventions, or changes in mobility over time.</p>
<p>The remainder of this section is organized as follows. First, the model for the sequence of time-varying reproduction numbers is described. Infections are then modeled in terms of this sequence. Finally, the observed data is modeled as a function of these latent infections.</p>
<div id="time-varying-reproduction-number" class="section level3">
<h3 class="hasAnchor">
<a href="#time-varying-reproduction-number" class="anchor"></a><span class="header-section-number">2.1.1</span> Time-varying reproduction number</h3>
<p>Let <span class="math inline">\(R := (R_{0},\ldots,R_{T})\)</span> be a non-negative sequence representing the <em>unadjusted</em> time-varying reproduction number over the period considered. Intuitively, <span class="math inline">\(R_t\)</span> measures the intensity of infectious interactions occuring in the population at time <span class="math inline">\(t_0 + t\)</span>. The term <em>unadjusted</em> is used to make explicit that the sequence being modeled has not been adjusted for the size of the susceptible population. This adjustment is made later in the model for infections. The sequence is parameterized as
<span class="math display" id="eq:rt">\[\begin{equation}
R = 2A f\left(X\beta + Zb\right)
\tag{2.1}
\end{equation}\]</span>
where <span class="math inline">\(A\)</span> is a constant, <span class="math inline">\(X\)</span> and <span class="math inline">\(Z\)</span> are <span class="math inline">\(T \times p\)</span> and <span class="math inline">\(T \times q\)</span> model matrices and where <span class="math inline">\(f\)</span> is the standard logistic function <span class="math inline">\(f(a) := \exp(a)/(1+\exp(a))\)</span>. The <span class="math inline">\(p\)</span>-dimensional <span class="math inline">\(\beta\)</span> represents pooled coefficients, while the <span class="math inline">\(q\)</span>-dimensional <span class="math inline">\(b\)</span> represent group-specific effects. When both <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> are greater than zero, this is known as <em>partial pooling</em>.</p>
<p>The parameters <span class="math inline">\(\beta\)</span> are assigned a prior distribution. This is flexible, and leverages the framework offered by <strong>rstanarm</strong>. Multiple different prior families are available. The group specific parameters <span class="math inline">\(b\)</span> are treated as zero mean multivariate normal. Prior specifications are described in more detail in Section <a href="#prior-arguments">3.1.1.4</a>.</p>
<p>The vector <span class="math inline">\(R\)</span> is latent and unobserved. The quantities we do observe are linked to <span class="math inline">\(R\)</span> through its effect on the underlying infections, which we now describe.</p>
</div>
<div id="infections" class="section level3">
<h3 class="hasAnchor">
<a href="#infections" class="anchor"></a><span class="header-section-number">2.1.2</span> Infections</h3>
<p>Let <span class="math inline">\(I_{0}, \ldots I_{T}\)</span> be a sequence where <span class="math inline">\(I_{t}\)</span> represents the cumulative infections that have occurred by <span class="math inline">\(t_0 + t\)</span>. The first <span class="math inline">\(N_0\)</span> days are seeded such that the prior on the incremental infections during this initial period is<br><span class="math display">\[
I_t - I_{t-1} \sim \text{Exponential}(1/\tau),
\]</span>
for <span class="math inline">\(t=0,\ldots, N_0-1\)</span> and with <span class="math inline">\(I_{-1}=0\)</span>, and where apriori <span class="math inline">\(\tau \sim \text{Exponential}(\lambda_0)\)</span> for some <span class="math inline">\(\lambda_0 &gt; 0\)</span>.</p>
<p><span class="math inline">\(I_t\)</span> for <span class="math inline">\(t \geq N_0\)</span> is modeled as the <em>exact</em> solution to an ordinary differential equation denoted by <span class="math inline">\(I(t)\)</span>. Before describing this ODE, first let <span class="math inline">\(s := (s_1,s_2,\ldots)\)</span> be a distribution on <span class="math inline">\(\mathbb{Z}^+\)</span> representing the serial interval of the disease being modeled.</p>
<p>The ODE <span class="math inline">\(I(t)\)</span> satisfies
<span class="math display">\[
I'(t) =  \left(\frac{P-I(t)}{P} \right)R_{\lfloor t \rfloor}c_{\lfloor t \rfloor},
\]</span>
with initial condition <span class="math inline">\(I(N_0-1) = I_{N_0-1}\)</span> and where <span class="math inline">\(c_t\)</span> is a weighted summation over previous infections
<span class="math display">\[
c_{t} = \sum_{\tau=0}^{t} (I(\tau) - I(\tau-1)) s_{t-\tau}.
\]</span></p>
<p>Given the value of <span class="math inline">\(I_{t-1}\)</span>, the exact solution to the above ODE at period <span class="math inline">\(t\)</span> can be shown to be
<span class="math display">\[
I_t = I_{t-1} + (P - I_{t-1})\left( 1 -\exp\left(-\frac{R_tc_t}{P}\right)\right),
\]</span>
where <span class="math inline">\(P\)</span> is the population size. This satisfies intuitive properties. If <span class="math inline">\(R_t = 0\)</span>, then there are no new infections. Fixing <span class="math inline">\(c_t &gt; 0\)</span> and letting <span class="math inline">\(R_t \to \infty\)</span> implies that <span class="math inline">\(I_t \to P\)</span>, i.e. everyone is infected tomorrow.</p>
<p>Please note that this infection model departs from <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>, and has the advantage of ensuring that cumulative infections are always bounded by the population size.</p>
</div>
<div id="observations" class="section level3">
<h3 class="hasAnchor">
<a href="#observations" class="anchor"></a><span class="header-section-number">2.1.3</span> Observations</h3>
<p>Data is observed from <span class="math inline">\(L\)</span> observation processes <span class="math inline">\(Y_t^{(1)} \ldots Y_{t}^{(L)}\)</span>, with the subscript <span class="math inline">\(t\)</span> ranging between <span class="math inline">\(1\)</span> and <span class="math inline">\(T\)</span>. These processes do not need to be fully observed; i.e. data may be missing for a subset of time periods. The typical example of such data would be daily death (as used in <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>) or incidence data. However, you are not limited to this. In general,</p>
<ul>
<li>
<span class="math inline">\(Y_t^{(l)}\)</span> should represent the count of a particular type of ‘event’ at time <span class="math inline">\(t\)</span>.</li>
<li>This event is assumed to occur at most once per member of the population; an example would be hospitalization data. This assumption excludes the processes from representing cumulative observations - which would require a more complex dependence structure than presented here.</li>
<li>The processes should be roughly conditionally independent given the underlying infection process.</li>
</ul>
<p>Extensions to more general types of data will be considered in future versions of the package.</p>
<p>Although the multivariate normal is an obvious candidate for the distribution of <span class="math inline">\(Y^{(l)}_t\)</span>, in practice there can be data issues leading to many observations being reported on one day, and fewer on others. To avoid being too influenced by this, the random variables <span class="math inline">\(Y^{(l)}_t\)</span> are assumed independent and negative binomial with mean <span class="math inline">\(y_{t}^{(l)}\)</span> and variance
<span class="math display">\[
y_t^{(l)} + \frac{{\left(y_t^{(l)}\right)}^2}{\phi_l},
\]</span>
where <span class="math inline">\(\phi_l\)</span> is a dispersion parameter distributed <span class="math inline">\(\phi_l \sim \mathcal{N}^+(0,\sigma^2_{\phi_l})\)</span> for some hyperparameter <span class="math inline">\(\sigma^2_{\phi_l} &gt; 0\)</span>. The expected value <span class="math inline">\(y_{t}^{(l)}\)</span> is then modeled as a function of</p>
<ul>
<li>
<span class="math inline">\(I_{0}, \ldots, I_{t-1}\)</span>, the previous infections,</li>
<li>
<span class="math inline">\(\pi^{(l)} = (\pi^{(l)}_1, \pi^{(l)}_2, \ldots)\)</span>, a discrete distribution on <span class="math inline">\(\mathbb{Z}^+\)</span> representing the time distribution from an infection event to an observation event,</li>
<li>and a proportion <span class="math inline">\(\alpha_l\)</span>, assumed to be a time constant quantity representing the rate of infections which will eventually record as an observation of type <span class="math inline">\(l\)</span>.</li>
</ul>
<p>To give intuition on the above quantities, suppose for now that the <span class="math inline">\(l\)</span><sup>th</sup> observation process recorded daily death counts. Then <span class="math inline">\(\pi^{(l)}_{t}\)</span> is the probability, conditional on a death being recorded today, that this individual was infected exactly <span class="math inline">\({t}\)</span> days prior. <span class="math inline">\(\alpha_{l}\)</span> is then the mean infection fatality ratio (IFR) for the given population.</p>
<p>The functional form for <span class="math inline">\(y_{t}^{(l)}\)</span> is then simply
<span class="math display">\[
y_{t}^{(l)} := \alpha_l \sum_{\tau=0}^{t-1} (I_{\tau} - I_{\tau-1})\pi^{(l)}_{t-\tau}.
\]</span>
The distribution <span class="math inline">\(\pi^{(l)}\)</span> is <em>treated as known</em>, however in future versions of epidemia we may allow it to be learnt. One possibility in this direction would be to view <span class="math inline">\(\pi^{(l)}\)</span> as a discretization of a continuous parametric distribution. The parameters could be given priors and learnt. The Gamma distribution is a suitable candidate for this.</p>
<p>The proportion <span class="math inline">\(\alpha_l\)</span> is treated as unknown, and given a normal prior truncated to the unit interval. To be precise
<span class="math display" id="eq:alpha">\[\begin{equation}
\alpha_l \sim \mathcal{N}_{[0,1]}(\mu_l, \sigma^2_{\alpha_l}),
\tag{2.2}
\end{equation}\]</span>
for given hyperparameters <span class="math inline">\(\mu_l\)</span> and <span class="math inline">\(\sigma^2_{\alpha_l}\)</span>. In future versions of epidemia, these proportions may instead be assigned Beta priors.</p>
</div>
</div>
<div id="multiple-populations" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-populations" class="anchor"></a><span class="header-section-number">2.2</span> Multiple Populations</h2>
<p>Extending to multiple populations is done by allowing some parameters to be pooled, while keeping others group specific. Suppose now that there are <span class="math inline">\(M\)</span> non-overlapping populations with differing start dates <span class="math inline">\(t^{(m)}_0\)</span> and epidemic lengths <span class="math inline">\(T_m\)</span>.</p>
<p>We begin by discussing the model parameters outside of <a href="#eq:rt">(2.1)</a>. We replace <a href="#eq:alpha">(2.2)</a> with
<span class="math display">\[
\alpha_{l,m} \sim \mathcal{N}_{[0,1]}(\mu_{l,m}, \sigma^2_{\alpha_l}),
\]</span>
so that <a href="#eq:alpha">(2.2)</a> is replicated for each group, except that each observation type has a shared hyperparameter <span class="math inline">\(\sigma^2_{\alpha_l}\)</span>. The dispersion parameters <span class="math inline">\(\phi_l\)</span> are on the other hand pooled, and <span class="math inline">\(\pi^{(l)}\)</span> are assumed the same for each group.</p>
<p>The remaining parameters relate to the parameterisation of the time-varying reproduction numbers. Collect these into a vector <span class="math inline">\(R\)</span> with total length <span class="math inline">\(T' := \sum_{m=1}^M T_m\)</span>, and consider the parameterization of <span class="math inline">\(R\)</span> in terms of covariates given in <a href="#eq:rt">(2.1)</a>. This approach allows flexible pooling of parameters through <span class="math inline">\(\beta\)</span>, while still permitting between group variation using the group-effects <span class="math inline">\(b\)</span>.</p>
</div>
</div>
<div id="r-implementation" class="section level1">
<h1 class="hasAnchor">
<a href="#r-implementation" class="anchor"></a><span class="header-section-number">3</span> R Implementation</h1>
<p><strong>epidemia</strong> is designed to fit the models described in Section <a href="#model-overview">2</a>. In particular, it uses R’s formula interface to parameterize the time-varying reproduction number in terms of a number of covariates (see <a href="#eq:rt">(2.1)</a>). The implementation of this shares many similarities with the <code>stan_glmer</code> function in <strong>rstanarm</strong> and the <strong>glmer</strong> function in <strong>lme4</strong>.</p>
<div id="model-fitting-using-epim" class="section level2">
<h2 class="hasAnchor">
<a href="#model-fitting-using-epim" class="anchor"></a><span class="header-section-number">3.1</span> Model fitting using <code>epim</code>
</h2>
<p>As mentioned in the introduction, the primary model fitting function in <strong>epidemia</strong> is <code>epim</code>. We now describe this function in depth. Section <a href="#function-arguments">3.1.1</a> details the formal arguments to <code>epim</code>, and links them where possible to the mathematical notation used in Section <a href="#model-overview">2</a>.</p>
<div id="function-arguments" class="section level3">
<h3 class="hasAnchor">
<a href="#function-arguments" class="anchor"></a><span class="header-section-number">3.1.1</span> Function Arguments</h3>
<p>Table <a href="#tab:epimArgs">3.1</a> lists the formal arguments to <code>epim</code>.</p>
<table class="table">
<caption>
<span id="tab:epimArgs">Table 3.1: </span>Formal arguments for the epim function</caption>
<colgroup>
<col width="5%">
<col width="91%">
<col width="3%">
</colgroup>
<thead><tr class="header">
<th align="left">Arguments</th>
<th align="left">Description</th>
<th align="left">Class</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">formula</td>
<td align="left">Specifies the model <a href="#eq:rt">(2.1)</a> for the unadjusted time-varying reproduction number. See <a href="https://www.rdocumentation.org/packages/lme4/versions/1.1-23/topics/glmer">glmer</a> for more details.</td>
<td align="left">formula</td>
</tr>
<tr class="even">
<td align="left">data</td>
<td align="left">The data used in the model specified by ‘formula’. Each term in <code>formula</code> must have a corresponding column in <code>data</code>. See <a href="https://www.rdocumentation.org/packages/lme4/versions/1.1-23/topics/glmer">glmer</a> for more details.</td>
<td align="left">data.frame</td>
</tr>
<tr class="odd">
<td align="left">obs</td>
<td align="left">All available observations and hyperparamters for the observation model (Section <a href="#observations">2.1.3</a>). Each element of <code>obs</code> represents its own type of observation. More on this below.</td>
<td align="left">list</td>
</tr>
<tr class="even">
<td align="left">pops</td>
<td align="left">Population of each modeled group. The first column represents the group and the second giving the corresponding population.</td>
<td align="left">data.frame</td>
</tr>
<tr class="odd">
<td align="left">si</td>
<td align="left">A vector representing the serial interval of the disease. This should be a simplex vector - i.e. all elements are non-negative and sum to one. The <span class="math inline">\(n\)</span><sup>th</sup> element gives the probability an individual infects another <span class="math inline">\(n\)</span> days after disease onset.</td>
<td align="left">numeric</td>
</tr>
<tr class="even">
<td align="left">seed_days</td>
<td align="left">Number of days <span class="math inline">\(N_0\)</span> for which to seed infections at the start of the epidemic. Defaults to 6L</td>
<td align="left">integer</td>
</tr>
<tr class="odd">
<td align="left">algorithm</td>
<td align="left">The algorithm used to fit the model. Must be one of ‘sampling’, ‘meanfield’ or ‘fullrank’, which correspond to <code>rstan</code> sampling methods. See <a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html">sampling</a> and <a href="https://mc-stan.org/rstan/reference/stanmodel-method-vb.html">vb</a>.</td>
<td align="left">character</td>
</tr>
<tr class="even">
<td align="left">group_subset</td>
<td align="left">An optional vector specifying a subset of groups to model. Elements should correspond to the group levels specified through the <code>data</code> argument.</td>
<td align="left">character</td>
</tr>
<tr class="odd">
<td align="left">center</td>
<td align="left">If <code>TRUE</code> then all covariates in <a href="#eq:rt">(2.1)</a> are centered (shifted to have mean zero). <strong>WARNING</strong>: <em>the priors are then interpreted as priors on the centered covariates</em>. Defaults to <code>FALSE</code>.</td>
<td align="left">logical</td>
</tr>
<tr class="even">
<td align="left">prior</td>
<td align="left">The prior distribution on <span class="math inline">\(\beta\)</span>, excluding any possible intercept.</td>
<td align="left">list</td>
</tr>
<tr class="odd">
<td align="left">prior_intercept</td>
<td align="left">Prior on the intercept if one has been specified in the model implied by <code>formula</code>.</td>
<td align="left">list</td>
</tr>
<tr class="even">
<td align="left">prior_covariance</td>
<td align="left">Prior on the covariance matrix of the group-specific parameters <span class="math inline">\(b\)</span>. Only used if the formula has at least one ‘random-effects’ term, i.e. <code>(a&amp;#124;b)</code>.</td>
<td align="left">list</td>
</tr>
<tr class="odd">
<td align="left">r0</td>
<td align="left">Set the constant <span class="math inline">\(A\)</span>, introduced in <a href="#eq:rt">(2.1)</a>. This will determine the maximum possible unadjusted <span class="math inline">\(R_t\)</span> (to be clear, not neccessarily <span class="math inline">\(A\)</span>). Defaults to 3.28.</td>
<td align="left">numeric</td>
</tr>
<tr class="even">
<td align="left">prior_phi</td>
<td align="left">Prior on the vector <span class="math inline">\((\phi_1, \ldots, \phi_L)\)</span>, the parameter controling variability of the observations around their mean values.</td>
<td align="left">list</td>
</tr>
<tr class="odd">
<td align="left">prior_tau</td>
<td align="left">Prior on <span class="math inline">\(\tau\)</span>, the parameter controling the variability in the seeded cases.</td>
<td align="left">list</td>
</tr>
<tr class="even">
<td align="left">prior_PD</td>
<td align="left">Flag whether to sample from the prior distribution. Same as <a href="https://mc-stan.org/rstanarm/reference/stan_lm.html">stan_lm</a>. Defaults to <code>FALSE</code>.</td>
<td align="left">logical</td>
</tr>
<tr class="odd">
<td align="left">sampling_args</td>
<td align="left">An (optional) named list of parameters to pass to the rstan function used for model fitting. See <a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html">sampling</a> and <a href="https://mc-stan.org/rstan/reference/stanmodel-method-vb.html">vb</a> for details of possible arguments.</td>
<td align="left">list</td>
</tr>
</tbody>
</table>
<p>Most of the arguments listed in Table <a href="#tab:epimArgs">3.1</a> are self-explanatory. However the first three and also the prior arguments require further explanation. We tackle each of these in turn.</p>
<div id="formula-argument" class="section level4">
<h4 class="hasAnchor">
<a href="#formula-argument" class="anchor"></a><span class="header-section-number">3.1.1.1</span> <code>formula</code> Argument</h4>
<p>This specifies the model for the <em>unadjusted</em> time-varying reproduction number, given by <a href="#eq:rt">(2.1)</a>. The LHS takes the form <code>R(group,date)</code>. This is just syntactic sugar to make explicit that the model is for the reproduction number for a given population and date.</p>
<p>The right hand side can include both pooled and unpooled coefficients. For more details on interpreting different formulas, please see <a href="https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf">here</a>.</p>
<p>We briefly give an intepretation for specific models in the context of the Europe data. First note that terms in the formula must correspond to column names in <code>data</code>, which are</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="kw">EuropeCovid</span><span class="op">$</span><span class="kw">data</span>)
</pre></div>
<pre><code>## [1] "country"                      "date"                        
## [3] "schools_universities"         "self_isolating_if_ill"       
## [5] "public_events"                "lockdown"                    
## [7] "social_distancing_encouraged"</code></pre>
<p>Suppose for simplicity that the value of all covariates at the start date of each group is zero, so that the intercept can be interpreted as determining the starting reproduction number <span class="math inline">\(R_0\)</span> of the disease (this is indeed the case for the Europe example). Then</p>
<ul>
<li><p><code>R(country, date) ~ 0 + lockdown</code> This is a no-intercept model. The effect is to set an exact <span class="math inline">\(R_0\)</span> which is <em>the same for all countries</em>. This potentially changes at dates for which <code>lockdown</code> become non-zero (i.e. after the intervention come into place). The starting value is precisely <span class="math inline">\(A\)</span> defined in <a href="#eq:rt">(2.1)</a>.</p></li>
<li><p><code>R(country, date) ~ 1 + lockdown</code> The intercept is the same for all countries. This implies a common distribution for <span class="math inline">\(R_0\)</span>, which is set by <code>prior_intercept</code>.</p></li>
<li><p><code>R(country, date) ~ (1 | country) + lockdown</code> A country-specific intercept allows the distribution of <span class="math inline">\(R_0\)</span> to depend on the country. The prior on these is controlled by both <code>prior_intercept</code> and <code>prior_covariance</code>.</p></li>
</ul>
</div>
<div id="data-argument" class="section level4">
<h4 class="hasAnchor">
<a href="#data-argument" class="anchor"></a><span class="header-section-number">3.1.1.2</span> <code>data</code> argument</h4>
<p>This argument provides any data specified by the formula. It must contain at least two columns which give the modeled populations and simulation dates. In the Europe example, the columns <code>country</code> and <code>date</code> serve this purpose. The <code>country</code> column must be coercible to class <code>factor</code>, and the levels of this column determine the possible populations to model.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="kw">data</span> <span class="op">&lt;-</span> <span class="kw">EuropeCovid</span><span class="op">$</span><span class="kw">data</span>
<span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="kw">data</span><span class="op">$</span><span class="kw">country</span>)
</pre></div>
<pre><code>##  [1] "Austria"        "Belgium"        "Denmark"        "France"        
##  [5] "Germany"        "Italy"          "Norway"         "Spain"         
##  [9] "Sweden"         "Switzerland"    "United_Kingdom"</code></pre>
<p>If specified, only the populations given in the <code>group_subset</code> argument are modeled. Otherwise, all levels are used.</p>
<p>The <code>dates</code> column must be coercible to a ‘Date’ vector. Dates must be consecutive for each modeled group. The first date is taken to be the start date <span class="math inline">\(t^{(m)}_0\)</span> of the epidemic in that population, and the final date is taken to be <span class="math inline">\(t^{(m)} + T\)</span>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="kw">agg</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">x</span>,<span class="kw">f</span>) <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(<span class="kw">x</span><span class="op">$</span><span class="kw">date</span>, by=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">x</span><span class="op">$</span><span class="kw">country</span>), FUN=<span class="kw">f</span>)
<span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fu">agg</span>(<span class="kw">data</span>, <span class="kw">min</span>),
               <span class="fu">agg</span>(<span class="kw">data</span>, <span class="kw">max</span>)[,<span class="fl">2</span>]),
         <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"country"</span>, <span class="st">"start"</span>, <span class="st">"date"</span>))
</pre></div>
<pre><code>##           country      start       date
## 1         Austria 2020-02-22 2020-05-05
## 2         Belgium 2020-02-18 2020-05-05
## 3         Denmark 2020-02-21 2020-05-05
## 4          France 2020-02-07 2020-05-05
## 5         Germany 2020-02-15 2020-05-05
## 6           Italy 2020-01-27 2020-05-05
## 7          Norway 2020-02-24 2020-05-05
## 8           Spain 2020-02-09 2020-05-05
## 9          Sweden 2020-02-18 2020-05-05
## 10    Switzerland 2020-02-14 2020-05-05
## 11 United_Kingdom 2020-02-13 2020-05-05</code></pre>
<p>Following <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>, the start dates shown above are thirty days prior to the first date for which more than 10 cumulative deaths were observed in the given country. They are <em>not learnt by the model</em>, rather they are assumed and specified by the user.</p>
</div>
<div id="obs-argument" class="section level4">
<h4 class="hasAnchor">
<a href="#obs-argument" class="anchor"></a><span class="header-section-number">3.1.1.3</span> <code>obs</code> argument</h4>
<p>A list of lists giving available observations from the <span class="math inline">\(L\)</span> observation processes introduced in Section <a href="#observations">2.1.3</a>, and hyperparameters for the observation model. These hyperparameters are <span class="math inline">\(\{\mu_{l,m}\}\)</span> and <span class="math inline">\(\{\sigma_{\alpha_l}\}\)</span>. The <span class="math inline">\(l\)</span><sup>th</sup> element of <code>obs</code> must itself be a named list containing the following three elements.</p>
<ul>
<li><p><strong>odata</strong>: A three column dataframe representing observations from the <span class="math inline">\(l\)</span><sup>th</sup> observation process. The first column represents group membership and must be coercible to class factor. The second column indicates the observation date and must be coercible to class Date. The third column contain the actual data.</p></li>
<li>
<p><strong>rates</strong>: A named list specifying the prior for the proportion of infected individuals recorded as an observation. For example if recording deaths this would be some estimate of each groups infection fatality ratio (IFR). The priors are assumed normal. Contains:</p>
<ul>
<li><p><strong>means</strong>: A two column dataframe giving the hyperparameters <span class="math inline">\(\mu_{l,m}\)</span>, i.e. the estimated mean proportion of infected individuals recorded as an observation. First column represents the group, while the second the corresponding proportion.</p></li>
<li><p><strong>scale</strong>: The standard deviation <span class="math inline">\(\sigma_{\alpha_l}\)</span> around the mean values. Default is 0.1.</p></li>
</ul>
</li>
<li><p><strong>pvec</strong>: The probability vector <span class="math inline">\(\pi_l\)</span> described in Section <a href="#observations">2.1.3</a>.</p></li>
</ul>
<p>The <code>EuropeCovid</code> data contains an example of the <code>obs</code> argument. It uses only one type of observation, death data, and so <span class="math inline">\(L=1\)</span> in this case, and of course <code>EuropeCovid$obs</code>must has length one.</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="kw">deaths</span> <span class="op">&lt;-</span> <span class="kw">EuropeCovid</span><span class="op">$</span><span class="kw">obs</span><span class="op">$</span><span class="kw">deaths</span>
</pre></div>
<p>We can inspect the observed deaths as follows.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">deaths</span><span class="op">$</span><span class="kw">odata</span>)
</pre></div>
<pre><code>##   country       date deaths
## 1 Austria 2020-02-22      0
## 2 Austria 2020-02-23      0
## 3 Austria 2020-02-24      0
## 4 Austria 2020-02-25      0
## 5 Austria 2020-02-26      0
## 6 Austria 2020-02-27      0</code></pre>
<p>It is also instructive to look at <code>$rates</code> component.</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="kw">deaths</span><span class="op">$</span><span class="kw">rates</span>
</pre></div>
<pre><code>## $means
##           country         ifr
## 1         Denmark 0.010207470
## 2          Norway 0.009149564
## 3          Sweden 0.010311043
## 4  United_Kingdom 0.010350438
## 5           Italy 0.012449626
## 6           Spain 0.010783873
## 7         Austria 0.010388226
## 8         Belgium 0.010959878
## 9          France 0.012556187
## 10        Germany 0.012332443
## 11    Switzerland 0.010213453
## 12         Greece 0.011799229
## 13       Portugal 0.011725868
## 14    Netherlands 0.010289760
## 
## $scale
## [1] 0.1</code></pre>
<p>This shows the assumed values for the hyperparameters <span class="math inline">\(\alpha_{l,m}\)</span> and <span class="math inline">\(\sigma_{\alpha_l}\)</span> described above. Note the differing prior expected value of the IFR between groups. This is partially a result of differing age demographics.</p>
<p>Finally, we visualise the distribution of time from disease onset to death.</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(<span class="kw">deaths</span><span class="op">$</span><span class="kw">pvec</span>, names.arg=<span class="fl">1</span><span class="op">:</span><span class="fl">101</span>)
</pre></div>
<p><img src="introduction_files/figure-html/pvec-1.png" width="672" style="display: block; margin: auto;">
Following <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>, this is a discretization of the distribution of <span class="math inline">\(\text{Gamma}(1.35,3.77) + \text{Gamma}(4.94,3.60)\)</span>, where the notation <span class="math inline">\(\text{Gamma}(\alpha, \theta)\)</span> refers to a Gamma random variable with shape <span class="math inline">\(\alpha\)</span> and scale <span class="math inline">\(\theta\)</span>.</p>
</div>
<div id="prior-arguments" class="section level4">
<h4 class="hasAnchor">
<a href="#prior-arguments" class="anchor"></a><span class="header-section-number">3.1.1.4</span> Prior arguments</h4>
<p>Prior distributions should be specified for the parameters in <a href="#eq:rt">(2.1)</a>, and for additional model parameters.</p>
<p><em>Please note that the current default priors may not be appropriate, and should not be relied upon. In future versions of the package, we hope to set good default priors.</em></p>
<p>The priors for <span class="math inline">\(\beta\)</span> (see <a href="#eq:rt">(2.1)</a>) are set using the <code>prior</code> and <code>prior_intercept</code> arguments. These will only have an effect if the formula specifies covariates and an intercept respectively. These function similarly to the same arguments in<a href="https://mc-stan.org/rstanarm/reference/stan_lm.html"><code>stan_lm</code></a>. To understand which families can be used please refer to <a href="https://mc-stan.org/rstanarm/reference/priors.html">rstanarm’s priors</a>.</p>
<p>There is one caveat: which is that we offer additional priors. Currently there is just one, <code>shifted_gamma</code>, which can only be used for the <code>prior</code> argument. The addition of this prior is motivated by the priors used in <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>. This essentially allows for
<span class="math display">\[\begin{equation}
\beta_i \sim \text{Gamma}(\alpha,\theta) - \eta,
\end{equation}\]</span>
where <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\theta\)</span> are shape and scale parameters, and <span class="math inline">\(\eta\)</span> is a shift to allow for priors with support below zero.</p>
<p>Consider a single ‘random-effects’ term in the formula. A good example would be <code>(1 + lockdown | country)</code>. For each group the intercepts and slopes are treated as zero-mean multivariate normal with unknown covariance matrix <span class="math inline">\(\Sigma\)</span>. For our example term, fix one level implied by the factor <code>country</code>, say <code>"Italy"</code>. For this group, there are two coefficients - a random intercept for Italy, and a random slope. Therefore <span class="math inline">\(\Sigma\)</span> has dimension <span class="math inline">\(2 \times 2\)</span>. Coefficients for different groups are treated as independent.</p>
<p><strong>epidemia</strong> borrows from <strong>rstanarm</strong> and uses the <a href="rstanarm%20priors"><code>decov</code></a> prior for <span class="math inline">\(\Sigma\)</span>. This decomposes <span class="math inline">\(\Sigma\)</span> into a variance vector and a correlation matrix. An LKJ prior is used on the correlation matrix, while the variance is decomposed into the product of a simplex vector and the trace of <span class="math inline">\(\Sigma\)</span>. The simplex vector is given a symmetric Dirichlet prior, which the trace is once again decomposed as <span class="math inline">\(tr(\Sigma) = J \kappa\)</span>, where <span class="math inline">\(J\)</span> is the order of <span class="math inline">\(\Sigma\)</span>. Finally <span class="math inline">\(\kappa\)</span> is assigned a scale-invariant prior - specifically a Gamma distribution with give shape and scale hyperparameters. For more information on this, please see <a href="http://mc-stan.org/rstanarm/reference/priors.html">rstanarm priors</a> and this <a href="http://mc-stan.org/rstanarm/articles/glmer.html">vignette</a>.</p>
<p>When the left hand side of the formula has only one term (for example <code>(1 | country)</code>), this prior on the covariance simplifies considerably. <span class="math inline">\(\Sigma\)</span> simply reduces to <span class="math inline">\(\kappa\)</span>, which has a gamma prior.</p>
</div>
</div>
</div>
</div>
<div id="a-more-complete-example" class="section level1">
<h1 class="hasAnchor">
<a href="#a-more-complete-example" class="anchor"></a><span class="header-section-number">4</span> A More Complete Example</h1>
<p>Here we demonstrate how to specify different prior distributions in practice, using the Europe data restricted to Germany and the United Kingdom as an example. In particular, we demonstrate the utility of the <code>prior_PD</code> flag for sampling from the prior predictive distribution. This allows you to easily visualise the prior assumptions on the reproduction number. Various methods that can be used on fitted models (<code>epimodel</code>) are demonstrated.</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="kw">args</span><span class="op">$</span><span class="kw">group_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Germany"</span>, <span class="st">"United_Kingdom"</span>)
</pre></div>
<p>Similar to <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>, we specify the following model.</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="kw">args</span><span class="op">$</span><span class="kw">formula</span> <span class="op">&lt;-</span> <span class="fu">R</span>(<span class="kw">country</span>,<span class="kw">date</span>) <span class="op">~</span> (<span class="fl">1</span> <span class="op">|</span> <span class="kw">country</span>) <span class="op">+</span> <span class="kw">schools_universities</span> <span class="op">+</span> <span class="kw">self_isolating_if_ill</span> <span class="op">+</span> <span class="kw">public_events</span> <span class="op">+</span> <span class="kw">lockdown</span> <span class="op">+</span> <span class="kw">social_distancing_encouraged</span>
</pre></div>
<p>This model allows a separate initial reproduction number for each country, and includes 6 different non-pharamceutical interventions (NPIs) to explain the changes to the number over time.</p>
<div id="prior-specification" class="section level2">
<h2 class="hasAnchor">
<a href="#prior-specification" class="anchor"></a><span class="header-section-number">4.1</span> Prior Specification</h2>
<p>Here we focus on specifying the <code>prior</code> argument. This controls the prior distribution of the coefficients in the regression. Any of the rstanarm priors can be used. We have also added a <code>shifted_gamma</code> prior to replicate the prior in <span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>.</p>
<p>To quickly visualise the effect of the prior distribution we can used the <code>prior_PD</code> flag to <code>epim</code>. If <code>TRUE</code> epim will sample all parameters from their prior distribution. We specify the prior for the intercept as follows.</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="kw">args</span><span class="op">$</span><span class="kw">prior_intercept</span> <span class="op">&lt;-</span> <span class="kw">rstanarm</span>::<span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(location=<span class="fl">0</span>, scale = <span class="fl">0.5</span>)
</pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="kw">args</span><span class="op">$</span><span class="kw">prior</span> <span class="op">&lt;-</span> <span class="kw">rstanarm</span>::<span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(scale = <span class="fl">0.5</span>)
<span class="kw">args</span><span class="op">$</span><span class="kw">algorithm</span> <span class="op">&lt;-</span> <span class="st">"sampling"</span>
<span class="kw">args</span><span class="op">$</span><span class="kw">sampling_args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(iter=<span class="fl">200</span>,control=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(adapt_delta=<span class="fl">0.95</span>,max_treedepth=<span class="fl">15</span>))
<span class="kw">args</span><span class="op">$</span><span class="kw">prior_PD</span> <span class="op">&lt;-</span> <span class="fl">TRUE</span>
<span class="kw">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>, <span class="kw">args</span>)
<span class="fu">plot_rt</span>(<span class="kw">fit</span>, levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">20</span>,<span class="fl">40</span>,<span class="fl">60</span>,<span class="fl">80</span>,<span class="fl">95</span>))
</pre></div>
<p><img src="introduction_files/figure-html/normalPrior-1.png" width="672" style="display: block; margin: auto;"></p>
<p>And example of using a shifted gamma prior…</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="kw">args</span><span class="op">$</span><span class="kw">prior</span> <span class="op">&lt;-</span> <span class="fu">shifted_gamma</span>(shape=<span class="fl">1</span><span class="op">/</span><span class="fl">6</span>, scale=<span class="fl">1</span>, shift = <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">1.05</span>)<span class="op">/</span><span class="fl">6</span>)
<span class="kw">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>, <span class="kw">args</span>)
<span class="fu">plot_rt</span>(<span class="kw">fit</span>, levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">20</span>,<span class="fl">40</span>,<span class="fl">60</span>,<span class="fl">80</span>,<span class="fl">95</span>))
</pre></div>
<p><img src="introduction_files/figure-html/gammaPrior-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The above plots give a good indication of the implications of different prior families.</p>
</div>
<div id="methods-for-epimodels" class="section level2">
<h2 class="hasAnchor">
<a href="#methods-for-epimodels" class="anchor"></a><span class="header-section-number">4.2</span> Methods for <code>epimodels</code>
</h2>
<p>Fitting the model to the data…</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="kw">args</span><span class="op">$</span><span class="kw">prior_PD</span> <span class="op">=</span> <span class="fl">FALSE</span>
<span class="kw">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>, <span class="kw">args</span>)
</pre></div>
<p>Printing the object gives a brief summary of estimated coefficients and standard errors. This is very similar to the print method for <a href="http://mc-stan.org/rstanarm/reference/stanreg-objects.html"><code>stanreg</code></a> objects.</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw">fit</span>, digits = <span class="fl">2</span>)
</pre></div>
<p>You can retrieve the prior distributions used easily with the following.</p>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="fu">prior_summary</span>(<span class="kw">fit</span>)
</pre></div>
<pre><code>## Priors for model 'fit' 
## ------
## Intercept (after predictors centered)
##  ~ normal(location = 0, scale = 0.5)
## 
## Coefficients
##  ~ gamma(shape = [0.17,0.17,0.17,...], scale = [1,1,1,...], shift = [-0.0081,-0.0081,-0.0081,...])
## 
## Covariance
##  ~ decov(reg. = 1, conc. = 1, shape = 1, scale = 0.1)
## ------
## See help('prior_summary.epimodel') for more details</code></pre>
<p>Often it will be useful to obtain the MCMC draws for the raw parameters. This can be done using <code>as.matrix</code>, <code>as.array</code>, or <code>as.data.frame</code>. Here is an example of using <code>as.matrix</code>.</p>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="kw">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="kw">fit</span>)
<span class="kw">draws</span>[<span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span>]
</pre></div>
<pre><code>##           parameters
## iterations (Intercept) schools_universities self_isolating_if_ill public_events
##       [1,]  -0.7802573            0.1443288            0.37164930      2.212096
##       [2,]  -0.6424173            0.3956533            0.07403738      2.184111
##       [3,]  -0.4671127            0.4843454            0.06993168      2.146082
##       [4,]  -0.6158538            0.1869997            0.12741269      2.580356</code></pre>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-Flaxman2020">
<p>Flaxman, Seth, Swapnil Mishra, Axel Gandy, H Juliette T Unwin, Thomas A Mellan, Helen Coupland, Charles Whittaker, et al. 2020. “Estimating the effects of non-pharmaceutical interventions on COVID-19 in Europe.” <em>Nature</em>. <a href="https://doi.org/10.1038/s41586-020-2405-7">https://doi.org/10.1038/s41586-020-2405-7</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by James Scott, Axel Gandy, Swapnil Mishra, Juliette Unwin, Seth Flaxman, Samir Bhatt.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
