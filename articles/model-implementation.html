<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Implementation • epidemia</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Implementation">
<meta property="og:description" content="epidemia">
<meta property="og:image" content="https://imperialcollegelondon.github.io/epidemia/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS_CHTML.js" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epidemia</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.7.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/install.html">Install</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Model
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/model-description.html">Description</a>
    </li>
    <li>
      <a href="../articles/model-implementation.html">Implementation</a>
    </li>
    <li>
      <a href="../articles/partial-pooling.html">Partial Pooling</a>
    </li>
    <li>
      <a href="../articles/priors.html">Priors</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/flu.html">A Basic Example</a>
    </li>
    <li>
      <a href="../articles/europe-covid.html">A Multilevel Model</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ImperialCollegeLondon/epidemia/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="model-implementation_files/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="model-implementation_files/kePrint-0.0.1/kePrint.js"></script><link href="model-implementation_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Implementation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ImperialCollegeLondon/epidemia/blob/master/vignettes/model-implementation.Rmd"><code>vignettes/model-implementation.Rmd</code></a></small>
      <div class="hidden name"><code>model-implementation.Rmd</code></div>

    </div>

    
    
<style>
.contents .page-header {
    display: none;
} 
</style>
<div class="article_container">

<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a><span class="header-section-number">1</span> Overview</h1>
<hr>
<p>Here we give a high-level overview of the workflow required for defining and fitting a model with
<strong>epidemia</strong>. The primary model fitting function is <code><a href="../reference/epim.html">epim()</a></code>. This takes a model description and
additional arguments relating to the fitting algorithm, and proceeds to fit the model using a
precompiled Stan program. This allows model fitting to begin immediately as opposed to requiring compilation each time
<code><a href="../reference/epim.html">epim()</a></code> is called.</p>
<p>This is similar to the workflow for fitting Bayesian regression models
with <strong>rstanarm</strong>. A key difference, however, is that the models fit by <strong>epidemia</strong> are much more
complex, and are therefore inherently more difficult to specify. <strong>epidemia</strong> aims to simplify this process
by modularising the model definition into three distinct parts: transmission,
infections and observations. These components of the model are defined with the functions <code><a href="../reference/epirt.html">epirt()</a></code>, <code><a href="../reference/epiinf.html">epiinf()</a></code> and
<code><a href="../reference/epiobs.html">epiobs()</a></code> respectively.</p>
<p><strong>epidemia</strong> contains an example dataset <code>EuropeCovid</code> which contains data
on daily death counts from Covid-19 in 11 European Countries from February through May 2020, and a set
of binary indicators of non-pharmaceutical interventions. This is
used as an example throughout.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">epidemia</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rstanarm</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"EuropeCovid"</span>)</pre></body></html></div>
<p>We begin by describing <code><a href="../reference/epim.html">epim()</a></code> in more detail, and then proceed to discuss the three modeling functions.</p>
</div>
<div id="model-fitting" class="section level1">
<h1 class="hasAnchor">
<a href="#model-fitting" class="anchor"></a><span class="header-section-number">2</span> Model Fitting</h1>
<hr>
<p><code><a href="../reference/epim.html">epim()</a></code> is the only model fitting function in <strong>epidemia</strong>. It has arguments <code>rt</code>, <code>inf</code>, and <code>obs</code> which
expect a description of the transmission model, infection model and all observational models respectively.
Together, these fully define the joint distribution of data and parameters. Each of these model components are
described in terms of variables that are expected to live in a single dataframe, <code>data</code>. This dataframe
must be compatible with the model components, in the sense that <em>it holds all variables defined in these
models</em>. For our example, these variables are the following.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">data</span> <span class="kw">&lt;-</span> <span class="no">EuropeCovid</span>$<span class="no">data</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">data</span>)</pre></body></html></div>
<pre><code>## [1] "country"                      "date"                        
## [3] "schools_universities"         "self_isolating_if_ill"       
## [5] "public_events"                "lockdown"                    
## [7] "social_distancing_encouraged" "deaths"                      
## [9] "pop"</code></pre>
<p>The <code>data</code> argument is described in more detail in Section <a href="#sec:data">6</a>.</p>
<p>In addition to taking a model description and a dataframe,
<code><a href="../reference/epim.html">epim()</a></code> has various additional arguments which specify how the model should be
fit. If <code>algorithm = "sampling"</code> then the model
will be fit using <em>Stan</em>’s adaptive Hamiltonian Monte Carlo sampler. This
is done internally by calling <code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html">rstan::sampling</a></code>. If <code>algorithm = "meanfield"</code> or
<code>algorithm = "fullrank"</code>, then <em>Stan</em>’s variational Bayes algorithms are used
instead, by calling <code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-vb.html">rstan::vb</a></code>. Any unnamed
arguments in the call to <code><a href="../reference/epim.html">epim()</a></code> are passed directly onto the <strong>rstan</strong>
sampling function. <code><a href="../reference/epim.html">epim()</a></code> returns a fitted model object of class
<code>"epimodel"</code>, which contains posterior samples from the model along with other
useful objects.</p>
<p>In general, the adaptive Hamiltonian Monte Carlo sampler
should be used for final inference. Nonetheless, fitting these models
using HMC is often computationally demanding, and variational Bayes can often be
fruitful for quickly iterating models. All arguments for <code><a href="../reference/epim.html">epim()</a></code> are described in Table
<a href="#tab:epim-args">2.1</a>.</p>
<div class="table">
<table class="table  lightable-paper lightable-hover">
<caption>
<span id="tab:epim-args">Table 2.1: </span>Formal arguments for <code><a href="../reference/epim.html">epim()</a></code>
</caption>
<thead><tr>
<th style="text-align:left;">
Argument
</th>
<th style="text-align:left;">
Description
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>rt</code>
</td>
<td style="text-align:left;">
An object of class <code>"epirt"</code>, resulting from a call to <code><a href="../reference/epirt.html">epirt()</a></code>. This defines the model for reproduction numbers <span class="math inline">\(R\)</span>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>inf</code>
</td>
<td style="text-align:left;">
An object of class <code>"epiinf"</code>, resulting from a call to <code><a href="../reference/epiinf.html">epiinf()</a></code>. This entirely defines the model for infections <span class="math inline">\(i_t\)</span>.)
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>obs</code>
</td>
<td style="text-align:left;">
Either an object of class <code>"epiobs"</code>, or a list of such objects. Each element of the list defines a model for an observed variable.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>data</code>
</td>
<td style="text-align:left;">
A dataframe with all data required for fitting the model. This includes all observation variables and covariates specified in the models for the reproduction number and ascertainment rates.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>algorithm</code>
</td>
<td style="text-align:left;">
One of <code>"sampling"</code>, <code>"meanfield"</code> or <code>"fullrank"</code>. This determines the rstan sampling function to use for fitting the model. <code>"sampling"</code> corresponds to an adaptive HMC sampler, while <code>"meanfield"</code> and <code>"fullrank"</code> are both variational Bayes algorithms.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>group_subset</code>
</td>
<td style="text-align:left;">
If specified, a character vector naming a subset of regions to include in the model.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior_PD</code>
</td>
<td style="text-align:left;">
Same as in <code>rstan::stan_glm</code>. If <code>TRUE</code>, samples all parameters from their prior distributions. This is useful for prior predictive checks. Defaults to <code>FALSE</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
…
</td>
<td style="text-align:left;">
Additional arguments to pass to the <code>rstan</code> function used to fit the model. If <code>algorithm = "sampling"</code>, then this function is <code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html">rstan::sampling</a></code>. Otherwise <code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-vb.html">rstan::vb</a></code> is used.Please see the documentation for these functions.
</td>
</tr>
</tbody>
</table>
</div>
<p>We now describe the three modeling functions in more detail, starting with <code><a href="../reference/epirt.html">epirt()</a></code>.</p>
</div>
<div id="transmission" class="section level1">
<h1 class="hasAnchor">
<a href="#transmission" class="anchor"></a><span class="header-section-number">3</span> Transmission</h1>
<hr>
<p><code><a href="../reference/epirt.html">epirt()</a></code> defines the model for time-varying reproduction numbers, which
was described in Section 4 of the <a href="model-description.html">model description article</a>.
It has a <code>formula</code> argument which defines the linear predictor <span class="math inline">\(\eta\)</span>, an
argument <code>link</code> defining the link function <code>g</code>, and additional arguments to
specify priors on parameters making up <span class="math inline">\(\eta\)</span>.</p>
<p>A general R formula gives a symbolic description of a model. It takes the form
<code>y ~ model</code>, where <code>y</code> is the response and <code>model</code> is a collection of terms
separated by the <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> operator. <code>model</code> fully defines a linear predictor used to
predict <code>y</code>. In this case, the “response” being modeled are reproduction numbers which are
unobserved. <code>epirt</code> therefore requires that
the left hand side of the formula takes the form <code>R(group, date)</code>, where <code>group</code>
and <code>date</code> refer to variables representing the region and date respectively.
The right hand side can consist of fixed effects, random effects, and
autocorrelation terms. For our example, a viable call to <code><a href="../reference/epirt.html">epirt()</a></code> is the
following.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">rt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epirt.html">epirt</a></span>(
  <span class="fu">R</span>(<span class="no">country</span>, <span class="no">date</span>) ~ <span class="fl">1</span> + <span class="no">lockdown</span> + <span class="no">public_events</span>,
  <span class="kw">link</span> <span class="kw">=</span> <span class="fu"><a href="../reference/scaled_logit.html">scaled_logit</a></span>(<span class="fl">7</span>)
)</pre></body></html></div>
<p>In the above example, two fixed effects are included which represent the
effects of lockdown and public events. These effects are assumed constant across
countries. They could alternatively be partially
pooled by using the term <code>(lockdown + public_events | country)</code>.
For information on how to interpret such terms, please read the <a href="partial-pooling.html">partial-pooling
article</a>. Using <code>link = scaled_logit(7)</code> lets the link function be the
scaled logit link described in the model description article (Equation 4.2),
where <span class="math inline">\(K = 7\)</span> is maximum possible value for reproduction numbers.
For simplicity, we have omitted any prior arguments, however these
should generally be specified explicitly. Please see
<a href="priors.html">here</a> for detailed information on how to use priors. All arguments
for <code><a href="../reference/epirt.html">epirt()</a></code> are listed in Table <a href="#tab:epirt-args">3.1</a>.</p>
<div class="table">
<table class="table  lightable-paper lightable-hover">
<caption>
<span id="tab:epirt-args">Table 3.1: </span>Formal arguments for <code><a href="../reference/epirt.html">epirt()</a></code>
</caption>
<thead><tr>
<th style="text-align:left;">
Argument
</th>
<th style="text-align:left;">
Description
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>formula</code>
</td>
<td style="text-align:left;">
An object of class <code>"formula"</code> which determines the linear predictor <span class="math inline">\(\eta\)</span> for <span class="math inline">\(R\)</span>. The left hand side must take the form <code>R(group, date)</code>, where <code>group</code> and <code>date</code> variables. <code>group</code> must be a factor vector indicating group membership (i.e. country, state, age cohort), and <code>date</code> must be a vector of class <code>"Date"</code>. This is syntactic sugar for the reproduction number in the given group at the give date.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>link</code>
</td>
<td style="text-align:left;">
The link function <span class="math inline">\(g\)</span>. Can be <code>"log"</code>, <code>"identity"</code> or a call to <code><a href="../reference/scaled_logit.html">scaled_logit()</a></code>. Defaults to <code>log</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>center</code>
</td>
<td style="text-align:left;">
If <code>TRUE</code>, covariates in <code>formula</code> are centered to have mean zero. All priors should then be interpreted as priors on the centered covariates.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior</code>
</td>
<td style="text-align:left;">
Same as in <code><a href="https://mc-stan.org/rstanarm/reference/stan_glm.html">rstanarm::stan_glm</a></code>. Defines the prior on <span class="math inline">\(\beta\)</span>. <strong>rstanarm</strong> provided <a href="http://mc-stan.org/rstanarm/reference/priors.html">priors</a>, a <code>shifted_gamma</code> can be used. <strong>Note</strong> if <code>autoscale=TRUE</code> in the call to the prior function, then automatic rescaling takes place.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior_intercept</code>
</td>
<td style="text-align:left;">
Same as in <code><a href="https://mc-stan.org/rstanarm/reference/stan_glm.html">rstanarm::stan_glm</a></code>. Prior for the regression intercept <span class="math inline">\(\beta_0\)</span> (if it exists).
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior_covariance</code>
</td>
<td style="text-align:left;">
Same as in <code><a href="https://mc-stan.org/rstanarm/reference/stan_glmer.html">rstanarm::stan_glmer</a></code>. Defines the prior on the covariance matrix <span class="math inline">\(\Sigma\)</span>. Only use if the <code>formula</code> has one or more terms of the form <code>(x | y)</code>, in which case there are parameters to partially pool, i.e. <span class="math inline">\(b\)</span> has positive length.
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="infections" class="section level1">
<h1 class="hasAnchor">
<a href="#infections" class="anchor"></a><span class="header-section-number">4</span> Infections</h1>
<hr>
<p>The model for infections is represented by <code><a href="../reference/epiinf.html">epiinf()</a></code>. For the
basic version of the model, this defines the generation distribution
of the disease, the number of days for which to seed infections, and the
prior distribution on the parameter <span class="math inline">\(\tau\)</span> (Equation 3.2). Recall that <span class="math inline">\(\tau\)</span> is
the prior mean on daily seeded infections. These three parameters are
controlled by the arguments <code>gen</code>, <code>seed_days</code> and <code>prior_tau</code> respectively.
For our example, a possible model is the following.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">inf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epiinf.html">epiinf</a></span>(
  <span class="kw">gen</span> <span class="kw">=</span> <span class="no">EuropeCovid</span>$<span class="no">si</span>,
  <span class="kw">seed_days</span> <span class="kw">=</span> <span class="fl">6L</span>,
  <span class="kw">prior_tau</span> <span class="kw">=</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">exponential</a></span>(<span class="fl">0.02</span>)
)</pre></body></html></div>
<p><code>EuropeCovid$si</code> is a numeric vector representing the probability mass
function for the serial interval of Covid-19. Here, we are implicitly assuming
that the generation distribution can be approximated well by the serial interval.
In this example, <span class="math inline">\(\tau\)</span>
is given an exponential prior with a mean of 50. These seeds
occur over a period of 6 days.</p>
<p><code><a href="../reference/epiinf.html">epiinf()</a></code> has additional arguments which allow the user to extend the basic
model. Using <code>latent=TRUE</code> replaces the renewal process (Equation 1.3) with
Equation 5.1. Daily infections are then treated as latent parameters that are
sampled along with other parameters. The <code>family</code> argument then gives
the distribution for <span class="math inline">\(p(i'_t, d)\)</span>, while <code>prior_aux</code> defines the prior on the
coefficient of dispersion <span class="math inline">\(d\)</span>.</p>
<p>Recall that one can adjust the infection process to explicitly
model changes in infection rates as the remaining susceptible population is
depleted. In particular, the adjustment ensures that cumulative infections
never breaches the initial susceprible population. The adjustment was described
in Section 5.3 of the model description article. It can be employed by
setting <code>pop_adjust = TRUE</code> and using the
<code>susceptibles</code> argument to point towards a variable in the dataframe which gives
the susceptible population at each point in time. All argument to <code><a href="../reference/epiinf.html">epiinf()</a></code> are
described in Table <a href="#tab:epiinf-args">4.1</a>.</p>
<div class="table">
<table class="table  lightable-paper lightable-hover">
<caption>
<span id="tab:epiinf-args">Table 4.1: </span>Formal arguments for <code><a href="../reference/epiinf.html">epiinf()</a></code>
</caption>
<thead><tr>
<th style="text-align:left;">
Argument
</th>
<th style="text-align:left;">
Description
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>gen</code>
</td>
<td style="text-align:left;">
A numeric vector giving the probability mass function <span class="math inline">\(g_k\)</span> of the generation distribution. Must be a simplex vector, i.e. nonnegative and summing to 1.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>seed_days</code>
</td>
<td style="text-align:left;">
An integer giving the number of seed days <span class="math inline">\(v + 1\)</span>. Defaults to 6L.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>latent</code>
</td>
<td style="text-align:left;">
If <code>TRUE</code>, treat infections as latent parameters using the extensions described in Section 5.2.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>family</code>
</td>
<td style="text-align:left;">
Specifies the family for <span class="math inline">\(p(i'_t, d)\)</span>. Only used if <code>latent = TRUE</code>, and currently restricted to <code>log-normal</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior_aux</code>
</td>
<td style="text-align:left;">
Prior on the coefficient of variation <span class="math inline">\(d\)</span>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior_tau</code>
</td>
<td style="text-align:left;">
Prior distribution for the hyperparameter <span class="math inline">\(\tau\)</span>, which is the mean of the prior distribution for infection seeding. Defaults to <code><a href="https://mc-stan.org/rstanarm/reference/priors.html">rstanarm::exponential(0.03)</a></code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>pop_adjust</code>
</td>
<td style="text-align:left;">
If <code>TRUE</code>, applies a population adjustment to the infection process <span class="math inline">\(i_t\)</span>. Defaults to <code>FALSE</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>susceptibles</code>
</td>
<td style="text-align:left;">
A character vector giving the name of the variable corresponding to the susceptible population over time. Only used if <code>pop_adjust=TRUE</code>.
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="observations" class="section level1">
<h1 class="hasAnchor">
<a href="#observations" class="anchor"></a><span class="header-section-number">5</span> Observations</h1>
<hr>
<p>Each observational model is given by a call to <code><a href="../reference/epiobs.html">epiobs()</a></code>. In particular,
this must define the model for ascertainment rates <span class="math inline">\(\alpha\)</span> and the time distribution
from infection to observation <span class="math inline">\(\pi\)</span>. <code><a href="../reference/epiobs.html">epiobs()</a></code> has a formula argument. The left hand
side must define the observation vector <span class="math inline">\(Y\)</span> which is to be modeled, while the
right hand side defines a linear predictor for the ascertainment rate <span class="math inline">\(\alpha\)</span>.
The argument <code>i2o</code> plays a similar role to the <code>gen</code> argument in <code><a href="../reference/epiinf.html">epiinf()</a></code>,
however it instead defines the vector <span class="math inline">\(\pi\)</span> in Equation (1.2).</p>
<p>Suppose we wish to model daily <code>deaths</code>, which as we saw is a variable in <code>data</code>.
One could use the following.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">deaths</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epiobs.html">epiobs</a></span>(
  <span class="no">deaths</span> ~ <span class="fl">1</span>,
  <span class="kw">i2o</span> <span class="kw">=</span> <span class="no">EuropeCovid</span>$<span class="no">inf2death</span>,
  <span class="kw">link</span> <span class="kw">=</span> <span class="fu"><a href="../reference/scaled_logit.html">scaled_logit</a></span>(<span class="fl">0.02</span>)
)</pre></body></html></div>
<p>The above models the infection fatality rate, <span class="math inline">\(\alpha\)</span>, as an intercept transformed by the scaled logit
link. This implies that it is constant over time, can achieve a maximum value of
2%, and a minimum value of 0%. If <code>prior_intercept</code> is chosen to be symmetric
around zero, then the prior mean of <span class="math inline">\(\alpha\)</span> is 1%. <code>EuropeCovid$inf2death</code> is
a numeric simplex vector that gives the same delay distribution as used in
<span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>, which is a discretised p.d.f. of a mixture of Gamma random variables.</p>
<p>Additional arguments include <code>family</code>, which specifies the sampling distribution
<span class="math inline">\(p(y_t, \phi)\)</span>. There are also arguments allowing the user to control
prior distributions for parameters describing <span class="math inline">\(\alpha\)</span>, and the prior on the
auxiliary variable <span class="math inline">\(\phi\)</span>. All arguments to <code><a href="../reference/epiobs.html">epiobs()</a></code> are shown in Table
<a href="#tab:epiobs-args">5.1</a>.</p>
<div class="table">
<table class="table  lightable-paper lightable-hover">
<caption>
<span id="tab:epiobs-args">Table 5.1: </span>Formal arguments for <code><a href="../reference/epiobs.html">epiobs()</a></code>
</caption>
<thead><tr>
<th style="text-align:left;">
Argument
</th>
<th style="text-align:left;">
Description
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>formula</code>
</td>
<td style="text-align:left;">
An object of class <code>"formula"</code> which determines the linear predictor for the ascertainment rate for a particular observation vector. The left hand side must define the response that is being modeled (i.e. the actual observations, not the latent ascertainments)in a given country on a given date. <code>obs</code> refers to the response variable to be modeled.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>i2o</code>
</td>
<td style="text-align:left;">
A numeric (simplex) vector defining the probability mass function <span class="math inline">\(\pi_k\)</span> of the time distribution from infection to observation.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>family</code>
</td>
<td style="text-align:left;">
A string representing the family of the sampling distribution <span class="math inline">\(p(y_t,\phi)\)</span>. Can be one of <code>"poisson"</code>, <code>"neg_binom"</code>, <code>"quasi_poisson"</code>, <code>"normal"</code> or <code>"log_normal"</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>link</code>
</td>
<td style="text-align:left;">
A string representing the link function used to transform the linear predictor. Can be one of <code>"logit"</code>, <code>"probit"</code>, <code>"cauchit"</code>, <code>"cloglog"</code>, <code>"identity"</code>. Defaults to <code>"logit"</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>center</code>, <code>prior</code>, <code>prior_intercept</code>
</td>
<td style="text-align:left;">
same as in <code><a href="../reference/epirt.html">epirt()</a></code>, described above.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior_aux</code>
</td>
<td style="text-align:left;">
The prior distribution for the auxiliary parameter <span class="math inline">\(\phi\)</span>, if it exists. Only used if family is <code>"neg_binom"</code> (reciprocal dispersion), <code>"quasi_poisson"</code> (dispersion), <code>"normal"</code> (standard deviation) or <code>"log_normal"</code> (sigma parameter).
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>...</code>
</td>
<td style="text-align:left;">
Additional arguments for <code>model.frame</code>.
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="sec:data" class="section level1">
<h1 class="hasAnchor">
<a href="#sec:data" class="anchor"></a><span class="header-section-number">6</span> Data</h1>
<hr>
<p>Recall that the <code>data</code> argument to <code><a href="../reference/epim.html">epim()</a></code> must contain all variables used in the transmission, infection and
observational models. For our example,
this looks like</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">data</span></pre></body></html></div>
<pre><code>## # A tibble: 899 x 9
## # Groups:   country [11]
##    country date       schools_univers… self_isolating_… public_events lockdown
##    &lt;fct&gt;   &lt;date&gt;                &lt;int&gt;            &lt;int&gt;         &lt;int&gt;    &lt;int&gt;
##  1 Austria 2020-02-22                0                0             0        0
##  2 Austria 2020-02-23                0                0             0        0
##  3 Austria 2020-02-24                0                0             0        0
##  4 Austria 2020-02-25                0                0             0        0
##  5 Austria 2020-02-26                0                0             0        0
##  6 Austria 2020-02-27                0                0             0        0
##  7 Austria 2020-02-28                0                0             0        0
##  8 Austria 2020-02-29                0                0             0        0
##  9 Austria 2020-03-01                0                0             0        0
## 10 Austria 2020-03-02                0                0             0        0
## # … with 889 more rows, and 3 more variables:
## #   social_distancing_encouraged &lt;int&gt;, deaths &lt;int&gt;, pop &lt;int&gt;</code></pre>
<p>The <code>columns</code> country and <code>date</code> define the region and time period corresponding to each of the remaining
variables. <code><a href="../reference/epim.html">epim()</a></code> assumes that the first seeding day (i.e. the start of the epidemic) in each region
is the first date found in the dataframe. The last date is the final date at which the epidemic is
simulated for the group. It is up to the user to appropriately choose these dates. For our example,
the first and last dates for each group can be seen as follows.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="no">data</span>, <span class="kw">start</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">date</span>), <span class="kw">end</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">date</span>))</pre></body></html></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>## # A tibble: 11 x 3
##    country        start      end       
##    &lt;fct&gt;          &lt;date&gt;     &lt;date&gt;    
##  1 Austria        2020-02-22 2020-05-05
##  2 Belgium        2020-02-18 2020-05-05
##  3 Denmark        2020-02-21 2020-05-05
##  4 France         2020-02-07 2020-05-05
##  5 Germany        2020-02-15 2020-05-05
##  6 Italy          2020-01-27 2020-05-05
##  7 Norway         2020-02-24 2020-05-05
##  8 Spain          2020-02-09 2020-05-05
##  9 Sweden         2020-02-18 2020-05-05
## 10 Switzerland    2020-02-14 2020-05-05
## 11 United_Kingdom 2020-02-13 2020-05-05</code></pre>
<p>These start dates are 30 days prior to observing 10 cumulative deaths in each country.</p>
</div>
<div id="a-first-fit" class="section level1">
<h1 class="hasAnchor">
<a href="#a-first-fit" class="anchor"></a><span class="header-section-number">7</span> A First Fit</h1>
<p>We are ready to fit out first model. This is done by returning to the model
fitting function <code><a href="../reference/epim.html">epim()</a></code>. Our call is as follows. Note that we use <code>refresh=0</code>
to suppress the algorithm printing output in this article - however this should be disabled
when you run models for yourself as this output is useful.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">fm</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epim.html">epim</a></span>(
  <span class="kw">rt</span> <span class="kw">=</span> <span class="no">rt</span>,
  <span class="kw">inf</span> <span class="kw">=</span> <span class="no">inf</span>,
  <span class="kw">obs</span> <span class="kw">=</span> <span class="no">deaths</span>,
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">data</span>,
  <span class="kw">group_subset</span> <span class="kw">=</span> <span class="st">"France"</span>,
  <span class="kw">algorithm</span> <span class="kw">=</span> <span class="st">"fullrank"</span>,
  <span class="kw">tol_rel_obj</span> <span class="kw">=</span> <span class="fl">1e-3</span>,
  <span class="kw">seed</span> <span class="kw">=</span> <span class="fl">12345</span>
)</pre></body></html></div>
<pre><code>## Chain 1: ------------------------------------------------------------
## Chain 1: EXPERIMENTAL ALGORITHM:
## Chain 1:   This procedure has not been thoroughly tested and may be unstable
## Chain 1:   or buggy. The interface is subject to change.
## Chain 1: ------------------------------------------------------------
## Chain 1: 
## Chain 1: 
## Chain 1: 
## Chain 1: Gradient evaluation took 0.000399 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 3.99 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Begin eta adaptation.
## Chain 1: Iteration:   1 / 250 [  0%]  (Adaptation)
## Chain 1: Iteration:  50 / 250 [ 20%]  (Adaptation)
## Chain 1: Iteration: 100 / 250 [ 40%]  (Adaptation)
## Chain 1: Iteration: 150 / 250 [ 60%]  (Adaptation)
## Chain 1: Iteration: 200 / 250 [ 80%]  (Adaptation)
## Chain 1: Iteration: 250 / 250 [100%]  (Adaptation)
## Chain 1: Success! Found best value [eta = 0.1].
## Chain 1: 
## Chain 1: Begin stochastic gradient ascent.
## Chain 1:   iter             ELBO   delta_ELBO_mean   delta_ELBO_med   notes 
## Chain 1:    100        -1615.837             1.000            1.000
## Chain 1:    200         -885.408             0.912            1.000
## Chain 1:    300         -606.618             0.762            0.825
## Chain 1:    400         -504.308             0.622            0.825
## Chain 1:    500         -462.445             0.516            0.460
## Chain 1:    600         -447.671             0.435            0.460
## Chain 1:    700         -449.618             0.374            0.203
## Chain 1:    800         -435.950             0.331            0.203
## Chain 1:    900         -435.095             0.294            0.091
## Chain 1:   1000         -422.491             0.268            0.091
## Chain 1:   1100         -424.864             0.168            0.033
## Chain 1:   1200         -421.377             0.087            0.031
## Chain 1:   1300         -414.988             0.042            0.030
## Chain 1:   1400         -415.822             0.022            0.015
## Chain 1:   1500         -413.944             0.014            0.008
## Chain 1:   1600         -412.360             0.011            0.006
## Chain 1:   1700         -410.027             0.011            0.006
## Chain 1:   1800         -408.316             0.008            0.006
## Chain 1:   1900         -408.288             0.008            0.006
## Chain 1:   2000         -405.559             0.006            0.006
## Chain 1:   2100         -407.560             0.006            0.005
## Chain 1:   2200         -406.630             0.005            0.005
## Chain 1:   2300         -404.974             0.004            0.004
## Chain 1:   2400         -403.195             0.004            0.004
## Chain 1:   2500         -403.052             0.004            0.004
## Chain 1:   2600         -402.653             0.003            0.004
## Chain 1:   2700         -402.449             0.003            0.004
## Chain 1:   2800         -401.054             0.003            0.003
## Chain 1:   2900         -402.901             0.003            0.004
## Chain 1:   3000         -400.305             0.003            0.004
## Chain 1:   3100         -401.745             0.003            0.004
## Chain 1:   3200         -401.820             0.003            0.004
## Chain 1:   3300         -400.202             0.003            0.004
## Chain 1:   3400         -400.708             0.003            0.003
## Chain 1:   3500         -399.987             0.003            0.003
## Chain 1:   3600         -398.969             0.003            0.003
## Chain 1:   3700         -398.404             0.003            0.003
## Chain 1:   3800         -398.867             0.003            0.003
## Chain 1:   3900         -398.374             0.002            0.002
## Chain 1:   4000         -398.921             0.002            0.001
## Chain 1:   4100         -398.501             0.002            0.001
## Chain 1:   4200         -398.335             0.002            0.001
## Chain 1:   4300         -398.306             0.001            0.001
## Chain 1:   4400         -398.273             0.001            0.001
## Chain 1:   4500         -398.207             0.001            0.001   MEAN ELBO CONVERGED
## Chain 1: 
## Chain 1: Drawing a sample of size 1000 from the approximate posterior... 
## Chain 1: COMPLETED.</code></pre>
<pre><code>## Warning: Pareto k diagnostic value is 0.76. Resampling is unreliable. Increasing
## the number of draws or decreasing tol_rel_obj may help.</code></pre>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_rt.html">plot_rt</a></span>(<span class="no">fm</span>)</pre></body></html></div>
<pre><code>## Registered S3 methods overwritten by 'car':
##   method                          from
##   influence.merMod                lme4
##   cooks.distance.influence.merMod lme4
##   dfbeta.influence.merMod         lme4
##   dfbetas.influence.merMod        lme4</code></pre>
<p><img src="model-implementation_files/figure-html/fit-model-1.png" width="672"></p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_obs.html">plot_obs</a></span>(<span class="no">fm</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"deaths"</span>)</pre></body></html></div>
<p><img src="model-implementation_files/figure-html/fit-model-2.png" width="672"></p>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a><span class="header-section-number">8</span> References</h1>
</div>
<div id="refs" class="references">
<div id="ref-Flaxman2020">
<p>Flaxman, Seth, Swapnil Mishra, Axel Gandy, H Juliette T Unwin, Thomas A Mellan, Helen Coupland, Charles Whittaker, et al. 2020. “Estimating the effects of non-pharmaceutical interventions on COVID-19 in Europe.” <em>Nature</em>. <a href="https://doi.org/10.1038/s41586-020-2405-7">https://doi.org/10.1038/s41586-020-2405-7</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by James Scott, Axel Gandy, Swapnil Mishra, Juliette Unwin, Seth Flaxman, Samir Bhatt.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
