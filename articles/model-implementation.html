<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Implementation • epidemia</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Implementation">
<meta property="og:description" content="epidemia">
<meta property="og:image" content="https://imperialcollegelondon.github.io/epidemia/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS_CHTML.js" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-186908163-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-186908163-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epidemia</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/install.html">Install</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Model
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/model-introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/model-description.html">Description</a>
    </li>
    <li>
      <a href="../articles/model-implementation.html">Implementation</a>
    </li>
    <li>
      <a href="../articles/model-schematic.html">Schematic</a>
    </li>
    <li>
      <a href="../articles/partial-pooling.html">Partial Pooling</a>
    </li>
    <li>
      <a href="../articles/priors.html">Priors</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/flu.html">A Basic Example</a>
    </li>
    <li>
      <a href="../articles/europe-covid.html">A Multilevel Model</a>
    </li>
    <li>
      <a href="../articles/multiple-obs.html">Multiple Observations</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ImperialCollegeLondon/epidemia/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="model-implementation_files/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="model-implementation_files/kePrint-0.0.1/kePrint.js"></script><link href="model-implementation_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Implementation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ImperialCollegeLondon/epidemia/blob/master/vignettes/model-implementation.Rmd"><code>vignettes/model-implementation.Rmd</code></a></small>
      <div class="hidden name"><code>model-implementation.Rmd</code></div>

    </div>

    
    
<style>
.contents .page-header {
    display: none;
} 
</style>
<div class="article_container">

<div id="sec:modelimplementation" class="section level1">
<h1 class="hasAnchor">
<a href="#sec:modelimplementation" class="anchor"></a><span class="header-section-number">1</span> Model Implementation</h1>
<hr>
<p>Here we give a high-level overview of the workflow required for defining and fitting a model with <strong>epidemia</strong>. The primary model fitting function is <code><a href="../reference/epim.html">epim()</a></code>. This takes a model description and additional arguments relating to the fitting algorithm, and proceeds to fit the model using a precompiled <strong>Stan</strong> program. This is similar to the workflow for fitting Bayesian regression models
with <strong>rstanarm</strong>. A key difference, however, is that the models fit by <strong>epidemia</strong> are generally complex, and are therefore inherently more difficult to specify. We simplify this process by taking a modular approach; models are defined through three distinct parts: transmission, infections and observations. These components of the model are defined with the functions <code><a href="../reference/epirt.html">epirt()</a></code>, <code><a href="../reference/epiinf.html">epiinf()</a></code> and
<code><a href="../reference/epiobs.html">epiobs()</a></code> respectively.</p>
<p>The package contains an example data set <code>EuropeCovid</code> which contains data
on daily death counts from Covid-19 in 11 European Countries from February through May 2020, and a set
of binary indicators of non-pharmaceutical interventions. This is
used as an example throughout.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">epidemia</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rstanarm</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"EuropeCovid"</span>)</pre></body></html></div>
<p>We begin by describing <code><a href="../reference/epim.html">epim()</a></code> in more detail, and then proceed to discuss the three modeling functions.</p>
<div id="sec:fitting" class="section level2">
<h2 class="hasAnchor">
<a href="#sec:fitting" class="anchor"></a><span class="header-section-number">1.1</span> Model Fitting</h2>
<hr>
<p><code><a href="../reference/epim.html">epim()</a></code> is the only model fitting function in <strong>epidemia</strong>. It has arguments <code>rt</code>, <code>inf</code>, and <code>obs</code> which
expect a description of the transmission model, infection model and all observational models respectively.
Together, these fully define the joint distribution of data and parameters. Each of these model components are
described in terms of variables that are expected to live in a single data frame, <code>data</code>. This data frame
must be compatible with the model components, in the sense that <em>it holds all variables defined in these
models</em>. For our example, these variables are the following.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">data</span> <span class="kw">&lt;-</span> <span class="no">EuropeCovid</span>$<span class="no">data</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">data</span>)</pre></body></html></div>
<pre><code>## [1] "country"                      "date"                        
## [3] "schools_universities"         "self_isolating_if_ill"       
## [5] "public_events"                "lockdown"                    
## [7] "social_distancing_encouraged" "deaths"                      
## [9] "pop"</code></pre>
<p>The <code>data</code> argument is described in more detail in Section <a href="#sec:data">1.5</a>.</p>
<p>In addition to taking a model description and a data frame,
<code><a href="../reference/epim.html">epim()</a></code> has various additional arguments which specify how the model should be
fit. If <code>algorithm = "sampling"</code> then the model
will be fit using <strong>Stan</strong>’s adaptive Hamiltonian Monte Carlo sampler <span class="citation">(Hoffman and Gelman <a href="#ref-hoffman_2014" role="doc-biblioref">2014</a>)</span>. This
is done internally by calling <code>sampling()</code> from <strong>rstan</strong>. If instead this is <code>"meanfield"</code> or <code>"fullrank"</code>, then <strong>Stan</strong>’s Variational Bayes
algorithms <span class="citation">(Kucukelbir et al. <a href="#ref-Kucukelbir_2015" role="doc-biblioref">2015</a>, <a href="#ref-Kucukelbir_2017" role="doc-biblioref">2017</a>)</span> are employed by calling <code>vb()</code> from <strong>rstan</strong>. Any unnamed
arguments in the call to <code><a href="../reference/epim.html">epim()</a></code> are passed directly onto the <strong>rstan</strong>
sampling function. <code><a href="../reference/epim.html">epim()</a></code> returns a fitted model object of class
<code>epimodel</code>, which contains posterior samples from the model along with other
useful objects.</p>
<p>In general, Hamiltonian Monte Carlo should be used for final inference. Nonetheless, this is often computationally demanding, and Variational Bayes can often be
used fruitful for quickly iterating models. All arguments for <code><a href="../reference/epim.html">epim()</a></code> are described in Table
<a href="#tab:model-imp-epim-args">1.1</a>.</p>
<div class="table">
<table class="table  lightable-paper lightable-hover">
<caption>
<span id="tab:model-imp-epim-args">Table 1.1: </span>Formal arguments for the model fitting function <code><a href="../reference/epim.html">epim()</a></code>. The first three arguments listed below define the model to be fitted.
</caption>
<thead><tr>
<th style="text-align:left;">
Argument
</th>
<th style="text-align:left;">
Description
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>rt</code>
</td>
<td style="text-align:left;">
An object of class <code>epirt</code>, resulting from a call to <code><a href="../reference/epirt.html">epirt()</a></code>. This defines the model for time-varying reproduction numbers <span class="math inline">\(R_t\)</span>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>inf</code>
</td>
<td style="text-align:left;">
An object of class <code>epiinf</code>, resulting from a call to <code><a href="../reference/epiinf.html">epiinf()</a></code>. This entirely defines the model for infections <span class="math inline">\(i_t\)</span>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>obs</code>
</td>
<td style="text-align:left;">
Either an object of class <code>epiobs</code>, or a list of such objects. Each of these define a model for an observation vector in <code>data</code>, and result from a call to <code><a href="../reference/epiobs.html">epiobs()</a></code>. Each element of the list defines a model for an observed variable.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>data</code>
</td>
<td style="text-align:left;">
A dataframe with all data required for fitting the model. This includes all observations and covariates specified in the model.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>algorithm</code>
</td>
<td style="text-align:left;">
One of <code>"sampling"</code>, <code>"meanfield"</code> or <code>"fullrank"</code>. This determines the <strong>rstan</strong> sampling function to use for fitting the model. <code>"sampling"</code> corresponds to HMC, while <code>"meanfield"</code> and <code>"fullrank"</code> are Variational Bayes algorithms.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>group_subset</code>
</td>
<td style="text-align:left;">
If specified, a character vector naming a subset of groups/populations to include in the model.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior_PD</code>
</td>
<td style="text-align:left;">
If <code>TRUE</code>, parameters are sampled from their prior distributions. This is useful for prior predictive checks. Defaults to <code>FALSE</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
…
</td>
<td style="text-align:left;">
Additional arguments to pass to the <strong>rstan</strong> function used to fit the model. If <code>algorithm = "sampling"</code>, then this function is <code>sampling()</code>. Otherwise <code>vb()</code> is used.
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="sec:imp_transmission" class="section level2">
<h2 class="hasAnchor">
<a href="#sec:imp_transmission" class="anchor"></a><span class="header-section-number">1.2</span> Transmission</h2>
<hr>
<p><code><a href="../reference/epirt.html">epirt()</a></code> defines the model for time-varying reproduction numbers, which
was described in Section 1.4 of the model description <a href="model-description.html">article</a>. Recall that these are modeled as a transformed linear predictor. <code><a href="../reference/epirt.html">epirt()</a></code> has a <code>formula</code> argument which defines the linear predictor <span class="math inline">\(\eta\)</span>, an argument <code>link</code> defining the link function <code>g</code>, and additional arguments to specify priors on parameters making up <span class="math inline">\(\eta\)</span>.</p>
<p>A general <strong>R</strong> formula gives a symbolic description of a model. It takes the form
<code>y ~ model</code>, where <code>y</code> is the response and <code>model</code> is a collection of terms
separated by the <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> operator. <code>model</code> fully defines a linear predictor used to
predict <code>y</code>. In this case, the “response” being modeled are reproduction numbers which are
unobserved. <code><a href="../reference/epirt.html">epirt()</a></code> therefore requires that
the left hand side of the formula takes the form <code>R(group, date)</code>, where <code>group</code>
and <code>date</code> refer to variables representing the modeled populations and dates respectively.
The right hand side can consist of fixed effects, random effects, and
autocorrelation terms. For our example, a viable call to <code><a href="../reference/epirt.html">epirt()</a></code> is the
following.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">rt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epirt.html">epirt</a></span>(<span class="kw">formula</span> <span class="kw">=</span> <span class="fu">R</span>(<span class="no">country</span>, <span class="no">date</span>) ~ <span class="fl">1</span> + <span class="no">lockdown</span> + <span class="no">public_events</span>,
            <span class="kw">link</span> <span class="kw">=</span> <span class="fu"><a href="../reference/scaled_logit.html">scaled_logit</a></span>(<span class="fl">7</span>))</pre></body></html></div>
<p>Here, two fixed effects are included which represent the
effects of implementing lockdown and banning public events. These effects are assumed constant across
countries. They could alternatively be partially
pooled by using the term <code>(lockdown + public_events | country)</code>.
For information on how to interpret such terms, please see <a href="partial-pooling.html">partial pooling</a>. Using <code>link = scaled_logit(7)</code> lets the link function be the
scaled logit link described by Equation (1.7) in the model description article,
where <span class="math inline">\(K = 7\)</span> is the maximum possible value for reproduction numbers.
For simplicity, we have omitted any prior arguments, however these
should generally be specified explicitly. Please see
<a href="priors.html">prior</a> for detailed information on how to use priors. All arguments
for <code><a href="../reference/epirt.html">epirt()</a></code> are listed in Table <a href="#tab:model-imp-epim-args">1.1</a>.</p>
<div class="table">
<table class="table  lightable-paper lightable-hover">
<caption>
<span id="tab:model-imp-epirt-args">Table 1.2: </span>Formal arguments for <code><a href="../reference/epirt.html">epirt()</a></code>, which defines the model for <span class="math inline">\(R_t\)</span>.
</caption>
<thead><tr>
<th style="text-align:left;">
Argument
</th>
<th style="text-align:left;">
Description
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>formula</code>
</td>
<td style="text-align:left;">
An object of class <code>formula</code> which determines the linear predictor <span class="math inline">\(\eta\)</span> for <span class="math inline">\(R\)</span>. The left hand side must take the form <code>R(group, date)</code>, where <code>group</code> must be a factor vector indicating group membership (i.e. country, state, age cohort), and <code>date</code> must be a vector of class <code>Date</code>. This is syntactic sugar for the reproduction number in the given group at the give date.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>link</code>
</td>
<td style="text-align:left;">
The link function <span class="math inline">\(g\)</span>. Can be <code>"log"</code>, <code>"identity"</code> or a call to <code><a href="../reference/scaled_logit.html">scaled_logit()</a></code>. Defaults to <code>"log"</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>center</code>
</td>
<td style="text-align:left;">
If <code>TRUE</code>, covariates specified in <code>formula</code> are centered to have mean zero. All priors should then be interpreted as priors on the centered covariates.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior</code>
</td>
<td style="text-align:left;">
Same as in <code><a href="https://mc-stan.org/rstanarm/reference/stan_glm.html">stan_glm()</a></code> from <strong>rstanarm</strong>. Defines the prior on fixed effects <span class="math inline">\(\beta\)</span>. Priors provided by <strong>rstanarm</strong> can be used, and additionally <code>shifted_gamma</code>. <strong>Note</strong>: if <code>autoscale = TRUE</code> in the call to the prior function, then automatic rescaling takes place.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior_intercept</code>
</td>
<td style="text-align:left;">
Same as in <code><a href="https://mc-stan.org/rstanarm/reference/stan_glm.html">stan_glm()</a></code> from <strong>rstanarm</strong>. Prior for the regression intercept <span class="math inline">\(\beta_0\)</span> (if it exists).
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior\_covariance</code>
</td>
<td style="text-align:left;">
Same as in <code><a href="https://mc-stan.org/rstanarm/reference/stan_glmer.html">stan_glmer()</a></code> from <strong>rstanarm</strong>. Defines the prior on the covariance matrix <span class="math inline">\(\Sigma\)</span>. Only use if the <code>formula</code> has one or more terms of the form <code>(x | y)</code>, in which case there are parameters to partially pool, i.e. <span class="math inline">\(b\)</span> has positive length.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>...</code>
</td>
<td style="text-align:left;">
Additional arguments to pass to <code><a href="https://rdrr.io/r/stats/model.frame.html">model.frame()</a></code> from <strong>stats</strong>.
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="sec:imp_infections" class="section level2">
<h2 class="hasAnchor">
<a href="#sec:imp_infections" class="anchor"></a><span class="header-section-number">1.3</span> Infections</h2>
<hr>
<p>The infection model is represented by <code><a href="../reference/epiinf.html">epiinf()</a></code>. In the most basic version, this defines the distribution of the generation time of the disease, the number of days for which to seed infections, and the prior distribution on seeded infections. These three parameters are
controlled by the arguments <code>gen</code>, <code>seed_days</code> and <code>prior_seeds</code> respectively.
A possible model is the following.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">inf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epiinf.html">epiinf</a></span>(<span class="kw">gen</span> <span class="kw">=</span> <span class="no">EuropeCovid</span>$<span class="no">si</span>, <span class="kw">seed_days</span> <span class="kw">=</span> <span class="fl">6L</span>,
              <span class="kw">prior_seeds</span> <span class="kw">=</span> <span class="fu"><a href="../reference/hexp.html">hexp</a></span>(<span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">exponential</a></span>(<span class="fl">0.02</span>)))</pre></body></html></div>
<p><code>EuropeCovid$si</code> is a numeric vector representing the distribution for the serial interval of Covid-19. There is an implicit assumption that the generation time can be approximated well by the serial interval. Seeds are modeled hierarchically, and are described by (1.4) and (1.5) in the model description. <span class="math inline">\(\tau\)</span> has been assigned an exponential prior with a mean of 50. Seeded infections are assumed to occur over a period of 6 days.</p>
<p><code><a href="../reference/epiinf.html">epiinf()</a></code> has additional arguments that allow the user to extend the basic
model. Using <code>latent = TRUE</code> replaces the renewal equation with
Equation (1.8). Daily infections are then treated as latent parameters that are
sampled along with other parameters. The <code>family</code> argument specifies
the distribution <span class="math inline">\(p(i'_t, d)\)</span>, while <code>prior_aux</code> defines the prior on the
coefficient of dispersion <span class="math inline">\(d\)</span>.</p>
<p>Recall from the model description that the infection process may be
modified to explicitly account for changes in infection rates as the remaining
susceptible population is depleted. In particular, the adjustment ensures that cumulative infections
never breaches the population size. It can be employed by
setting <code>pop_adjust = TRUE</code> and using the
<code>pop</code> argument to point towards a static variable in the data frame giving the population size. All argument to <code><a href="../reference/epiinf.html">epiinf()</a></code> are
described in Table <a href="#tab:model-imp-epiinf-args">1.3</a>.</p>
<div class="table">
<table class="table  lightable-paper lightable-hover">
<caption>
<span id="tab:model-imp-epiinf-args">Table 1.3: </span>Formal arguments for <code><a href="../reference/epiinf.html">epiinf()</a></code>, which defines the infection model.
</caption>
<thead><tr>
<th style="text-align:left;">
Argument
</th>
<th style="text-align:left;">
Description
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>gen</code>
</td>
<td style="text-align:left;">
A numeric vector giving the probability mass function <span class="math inline">\(g_k\)</span> for the generation time of the disease (must be a probability vector).
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>seed_days</code>
</td>
<td style="text-align:left;">
An integer giving the number of days <span class="math inline">\(v + 1\)</span> for which to seed infections. Defaults to 6L.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior_seeds</code>
</td>
<td style="text-align:left;">
Prior distribution on the seed parameter <span class="math inline">\(i\)</span>. Defaults to <code><a href="../reference/hexp.html">hexp(prior_aux = rstanarm::exponential(0.03))</a></code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>latent</code>
</td>
<td style="text-align:left;">
If <code>TRUE</code>, treat infections as latent parameters.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>family</code>
</td>
<td style="text-align:left;">
Specifies the family for the infection distribution <span class="math inline">\(p(i'_t, d)\)</span>. Only used if <code>latent = TRUE</code>, and defaults to <code>"normal"</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior_aux</code>
</td>
<td style="text-align:left;">
Prior on the auxiliary variable <span class="math inline">\(d\)</span> of <span class="math inline">\(p(i'_t,d)\)</span>. This is either the variance-to-mean ratio or the coefficient of variation, depending on the value of <code>fixed_vtm</code>. Only used if <code>latent = TRUE</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>fixed_vtm</code>
</td>
<td style="text-align:left;">
If <code>TRUE</code>, then <span class="math inline">\(p(i'_t, d)\)</span> has a fixed variance-to-mean ratio, i.e. variance is <span class="math inline">\(\sigma^2 = d i'_t\)</span>; In this case, <span class="math inline">\(d\)</span> refers to the <em>variance-to-mean ratio</em>. Id <code>FALSE</code> then instead standard deviation is assumed proportional to the mean, in which case <span class="math inline">\(d\)</span> is the <em>coefficient of variation</em>. Only used if <code>latent = TRUE</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>pop_adjust</code>
</td>
<td style="text-align:left;">
If <code>TRUE</code>, applies the population adjustment to the infection process.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>pops</code>
</td>
<td style="text-align:left;">
A character vector giving the population variable. Only used if <code>pop_adjust = TRUE</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior_susc</code>
</td>
<td style="text-align:left;">
Prior on <span class="math inline">\(S_{v-1} / P\)</span>, the initial susceptible population as a proportion of the population size. If <code>NULL</code>, this is assumed to be equal to 1 (i.e. everyone is initially susceptible). Otherwise, can be a call to <code><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal()</a></code> from <strong>rstanarm</strong>, which assigns a normal prior truncated to <span class="math inline">\([0,1]\)</span>. Only used if <code>pop_adjust = TRUE</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>rm</code>
</td>
<td style="text-align:left;">
A character vector giving the variable corresponding to <span class="math inline">\(v_t\)</span>, i.e. the proportion of <span class="math inline">\(S_t\)</span> to remove at time <span class="math inline">\(t\)</span>. Only used if <code>pop_adjust = TRUE</code>.
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
<code>prior_rm_noise</code>
</td>
<td style="text-align:left;">
Prior on the parameter <span class="math inline">\(\xi\)</span>, which controls noise around <span class="math inline">\(v_t\)</span>. If <code>NULL</code>, no noise is added. Only used if <code>pop_adjust = TRUE</code>.
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="sec:imp_observations" class="section level2">
<h2 class="hasAnchor">
<a href="#sec:imp_observations" class="anchor"></a><span class="header-section-number">1.4</span> Observations</h2>
<hr>
<p>An observational model is defined by a call to <code><a href="../reference/epiobs.html">epiobs()</a></code>. In particular,
this must also make explicit the model for the multipliers <span class="math inline">\(\alpha_t\)</span>, and must
also specify the coefficients <span class="math inline">\(\pi_k\)</span>. <code><a href="../reference/epiobs.html">epiobs()</a></code> has a <code>formula</code> argument. The left hand
side must indicate the observation vector to be modeled, while the
right hand side defines a linear predictor for <span class="math inline">\(\alpha_t\)</span>. The argument <code>i2o</code> plays a similar role to the <code>gen</code> argument in <code><a href="../reference/epiinf.html">epiinf()</a></code>,
however it instead corresponds the vector <span class="math inline">\(\pi\)</span> in Equation (1.2).</p>
<p>Take for example the task of modeling daily <code>deaths</code>, which as we saw is
a variable in <code>data</code>. A possible model is the following.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">deaths</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epiobs.html">epiobs</a></span>(<span class="kw">formula</span> <span class="kw">=</span> <span class="no">deaths</span> ~ <span class="fl">1</span>, <span class="kw">i2o</span> <span class="kw">=</span> <span class="no">EuropeCovid</span>$<span class="no">inf2death</span>,
                 <span class="kw">link</span> <span class="kw">=</span> <span class="fu"><a href="../reference/scaled_logit.html">scaled_logit</a></span>(<span class="fl">0.02</span>))</pre></body></html></div>
<p>Here <span class="math inline">\(\alpha_t\)</span> corresponds to the infection fatality rate (IFR), and is modeled as an
intercept transformed by the scaled-logit link. This implies that the IFR is constant over time and its value lies somewhere between 0% and 2%. If the prior on
the intercept (specified by the <code>prior_intercept</code> argument) is chosen to be
symmetric around zero, then the prior mean for the IFR is 1%. <code>EuropeCovid$inf2death</code> is a numeric simplex vector that gives the same delay distribution as used in
<span class="citation">Flaxman et al. (<a href="#ref-Flaxman2020" role="doc-biblioref">2020</a>)</span>. This is a density function for a discretized mixture of Gamma
random variables.</p>
<p>Additional arguments include <code>family</code>, which specifies the sampling distribution
<span class="math inline">\(p(y_t, \phi)\)</span>. There are also arguments allowing the user to control
prior distributions for effects in the linear predictor for <span class="math inline">\(\alpha_t\)</span>, and the prior on the
auxiliary variable <span class="math inline">\(\phi\)</span>. All arguments to <code><a href="../reference/epiobs.html">epiobs()</a></code> are shown in Table
<a href="#tab:model-imp-epiobs-args">1.4</a>.</p>
<div class="table">
<table class="table  lightable-paper lightable-hover">
<caption>
<span id="tab:model-imp-epiobs-args">Table 1.4: </span>Formal arguments for <code><a href="../reference/epiobs.html">epiobs()</a></code>. This defines a single observation model. Multiple such models can be used and passed to <code><a href="../reference/epim.html">epim()</a></code> in a list.
</caption>
<thead><tr>
<th style="text-align:left;">
Argument
</th>
<th style="text-align:left;">
Description
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;width: 7em; font-weight: bold;">
<code>formula</code>
</td>
<td style="text-align:left;">
An object of class <code>formula</code> which determines the linear predictor for the ascertainment rate. The left hand side must define the response that is being modeled (i.e. the actual observations, not the latent ascertainments)
</td>
</tr>
<tr>
<td style="text-align:left;width: 7em; font-weight: bold;">
<code>i2o</code>
</td>
<td style="text-align:left;">
A numeric (probability) vector defining the probability mass function <span class="math inline">\(\pi_k\)</span> of the time from an infection to an observation.
</td>
</tr>
<tr>
<td style="text-align:left;width: 7em; font-weight: bold;">
<code>family</code>
</td>
<td style="text-align:left;">
A string representing the family of the sampling distribution <span class="math inline">\(p(y_t,\phi)\)</span>. Can be one of <code>"poisson"</code>, <code>"neg_binom"</code>, <code>"quasi_poisson"</code>, <code>"normal"</code> or <code>"log_normal"</code>.
</td>
</tr>
<tr>
<td style="text-align:left;width: 7em; font-weight: bold;">
<code>link</code>
</td>
<td style="text-align:left;">
A string representing the link function used to transform the linear predictor. Can be one of <code>"logit"</code>, <code>"probit"</code>, <code>"cauchit"</code>, <code>"cloglog"</code>, <code>"identity"</code>. Defaults to <code>"logit"</code>.
</td>
</tr>
<tr>
<td style="text-align:left;width: 7em; font-weight: bold;">
<code>center</code>,
<code>prior</code>,
<code>prior_intercept</code>
</td>
<td style="text-align:left;">
same as in <code><a href="../reference/epirt.html">epirt()</a></code>, described above.
</td>
</tr>
<tr>
<td style="text-align:left;width: 7em; font-weight: bold;">
<code>prior_aux</code>
</td>
<td style="text-align:left;">
The prior distribution for the auxiliary parameter <span class="math inline">\(\phi\)</span>, if it exists. Only used if family is <code>"neg_binom"</code> (reciprocal dispersion), <code>"quasi_poisson"</code> (dispersion), <code>"normal"</code> (standard deviation) or <code>"log_normal"</code> (sigma parameter).
</td>
</tr>
<tr>
<td style="text-align:left;width: 7em; font-weight: bold;">
<code>...</code>
</td>
<td style="text-align:left;">
Additional arguments for <code><a href="https://rdrr.io/r/stats/model.frame.html">model.frame()</a></code> from <strong>stats</strong>.
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="sec:data" class="section level2">
<h2 class="hasAnchor">
<a href="#sec:data" class="anchor"></a><span class="header-section-number">1.5</span> Data</h2>
<hr>
<p>Before fitting our first model in Section <a href="#sec:first-fit">1.6</a>, we elaborate on
the <code>data</code> argument to <code><a href="../reference/epim.html">epim()</a></code>. Recall that this must contain all variables used in the transmission and infection models, and in all observational models. For our example,
<code>data</code> looks like</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">data</span>)</pre></body></html></div>
<pre><code>## # A tibble: 6 x 9
## # Groups:   country [1]
##   country date       schools_universit… self_isolating_i… public_events lockdown
##   &lt;fct&gt;   &lt;date&gt;                  &lt;int&gt;             &lt;int&gt;         &lt;int&gt;    &lt;int&gt;
## 1 Austria 2020-02-22                  0                 0             0        0
## 2 Austria 2020-02-23                  0                 0             0        0
## 3 Austria 2020-02-24                  0                 0             0        0
## 4 Austria 2020-02-25                  0                 0             0        0
## 5 Austria 2020-02-26                  0                 0             0        0
## 6 Austria 2020-02-27                  0                 0             0        0
## # … with 3 more variables: social_distancing_encouraged &lt;int&gt;, deaths &lt;int&gt;,
## #   pop &lt;int&gt;</code></pre>
<p>The columns <code>country</code> and <code>date</code> define the region and time period corresponding to each of the remaining
variables. <code><a href="../reference/epim.html">epim()</a></code> assumes that the first seeding day (i.e. the start of the epidemic) in each region is the first date found in the data frame. The last data found for each region is the final data at which the epidemic is simulated. It is up to the user to appropriately choose these dates. For our example,
the first and last dates for each group can be seen as follows.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">dates</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="no">data</span>, <span class="kw">start</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">date</span>), <span class="kw">end</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">date</span>))
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">dates</span>)</pre></body></html></div>
<pre><code>## # A tibble: 6 x 3
##   country start      end       
##   &lt;fct&gt;   &lt;date&gt;     &lt;date&gt;    
## 1 Austria 2020-02-22 2020-05-05
## 2 Belgium 2020-02-18 2020-05-05
## 3 Denmark 2020-02-21 2020-05-05
## 4 France  2020-02-07 2020-05-05
## 5 Germany 2020-02-15 2020-05-05
## 6 Italy   2020-01-27 2020-05-05</code></pre>
<p>Here, the start dates have been heuristically chosen to be 30 days prior to
observing 10 cumulative deaths in each country.</p>
</div>
<div id="sec:first-fit" class="section level2">
<h2 class="hasAnchor">
<a href="#sec:first-fit" class="anchor"></a><span class="header-section-number">1.6</span> A First Fit</h2>
<hr>
<p>We are now ready to fit our first model. For this we return to the model
fitting function <code><a href="../reference/epim.html">epim()</a></code>. The following command is used to instruct
<strong>epidemia</strong> to run Markov chains in parallel, rather than sequentially, if
multiple cores are detected.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="kw">mc.cores</span> <span class="kw">=</span> <span class="kw pkg">parallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>())</pre></body></html></div>
<p>Our call to <code><a href="../reference/epim.html">epim()</a></code> is as follows. We use <code>refresh = 0</code>
to suppress printing output in this article, however, this should
not generally be used as such output is useful.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">fm</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epim.html">epim</a></span>(<span class="kw">rt</span> <span class="kw">=</span> <span class="no">rt</span>, <span class="kw">inf</span> <span class="kw">=</span> <span class="no">inf</span>, <span class="kw">obs</span> <span class="kw">=</span> <span class="no">deaths</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">data</span>,
           <span class="kw">group_subset</span> <span class="kw">=</span> <span class="st">"France"</span>, <span class="kw">algorithm</span> <span class="kw">=</span> <span class="st">"sampling"</span>, <span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1e3</span>,
           <span class="kw">seed</span> <span class="kw">=</span> <span class="fl">12345</span>, <span class="kw">refresh</span> <span class="kw">=</span> <span class="fl">0</span>)</pre></body></html></div>
<p>The print method for <code>epimodel</code> objects prints summary statistics for
model parameters. These are obtained from the sampled posterior distribution.
Parameter are displayed
according to which part of the model they belong to (transmission, observations,
infections). An estimate of the standard deviation, labeled <code>MAD_SD</code> is
displayed. This is the median absolute deviation from the median, and is more
robust than naive estimates of the standard deviation for long-tailed
distributions.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">fm</span>)</pre></body></html></div>
<pre><code>## 
## Rt regression parameters:
## ==========
## coefficients:
##                 Median MAD_SD
## R|(Intercept)    0.7    0.2  
## R|lockdown      -2.4    0.3  
## R|public_events -0.4    0.3  
## 
##  deaths  regression parameters:
## ==========
## coefficients:
##                              Median MAD_SD
## deaths|(Intercept)            0.0    0.2  
## deaths|reciprocal dispersion 10.4    0.4  
## 
## Infection model parameters:
## ==========
##               Median MAD_SD
## seeds[France] 15.1    5.2  
## seeds_aux     27.2   22.0</code></pre>
<p>Alternatively, the summary method can be used. This gives quantiles of the
posterior draws, and also displays some MCMC diagnostics.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">fm</span>)</pre></body></html></div>
<pre><code>## 
## 
## Estimates:
##                                mean   sd   10%   50%   90%
## R|(Intercept)                 0.7    0.2  0.5   0.7   0.9 
## R|lockdown                   -2.4    0.3 -2.8  -2.4  -2.1 
## R|public_events              -0.4    0.3 -0.8  -0.4   0.0 
## deaths|(Intercept)            0.0    0.2 -0.3   0.0   0.2 
## seeds[France]                16.0    5.8  9.4  15.1  24.1 
## seeds_aux                    38.2   35.3  8.5  27.2  80.7 
## deaths|reciprocal dispersion 10.5    0.5 10.1  10.4  11.1 
## 
## MCMC diagnostics
##                              mcse Rhat n_eff
## R|(Intercept)                0.0  1.0  1221 
## R|lockdown                   0.0  1.0  1168 
## R|public_events              0.0  1.0   967 
## deaths|(Intercept)           0.0  1.0  1649 
## seeds[France]                0.2  1.0  1362 
## seeds_aux                    1.1  1.0  1113 
## deaths|reciprocal dispersion 0.0  1.0  2210 
## log-posterior                0.1  1.0   708</code></pre>
</div>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a><span class="header-section-number">2</span> References</h1>
<hr>
</div>
<div id="refs" class="references">
<div id="ref-Flaxman2020">
<p>Flaxman, Seth, Swapnil Mishra, Axel Gandy, H Juliette T Unwin, Thomas A Mellan, Helen Coupland, Charles Whittaker, et al. 2020. “Estimating the effects of non-pharmaceutical interventions on COVID-19 in Europe.” <em>Nature</em>. <a href="https://doi.org/10.1038/s41586-020-2405-7">https://doi.org/10.1038/s41586-020-2405-7</a>.</p>
</div>
<div id="ref-hoffman_2014">
<p>Hoffman, Matthew D., and Andrew Gelman. 2014. “The no-U-turn sampler: Adaptively setting path lengths in Hamiltonian Monte Carlo.” <em>Journal of Machine Learning Research</em> 15.</p>
</div>
<div id="ref-Kucukelbir_2017">
<p>Kucukelbir, Alp, David M. Blei, Andrew Gelman, Rajesh Ranganath, and Dustin Tran. 2017. “Automatic Differentiation Variational Inference.” <em>Journal of Machine Learning Research</em> 18.</p>
</div>
<div id="ref-Kucukelbir_2015">
<p>Kucukelbir, Alp, Rajesh Ranganath, Andrew Gelman, and David M. Blei. 2015. “Automatic variational inference in Stan.” In <em>Advances in Neural Information Processing Systems</em>. Vols. 2015-January.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by James Scott, Axel Gandy, Swapnil Mishra, Juliette Unwin, Seth Flaxman, Samir Bhatt.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
