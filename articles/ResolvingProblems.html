<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resolving Problems â€¢ epidemia</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Resolving Problems">
<meta property="og:description" content="epidemia">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epidemia</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/IncidenceOnly.html">Modelling of R  with only Incidence data</a>
    </li>
    <li>
      <a href="../articles/ResolvingProblems.html">Resolving Problems</a>
    </li>
    <li>
      <a href="../articles/TimeDependentR.html">Time-dependent Modelling of R</a>
    </li>
    <li>
      <a href="../articles/introduction.html">Flexible Epidemic Modeling with epidemia</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ImperialCollegeLondon/epidemia/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="ResolvingProblems_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Resolving Problems</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ImperialCollegeLondon/epidemia/blob/master/vignettes/ResolvingProblems.Rmd"><code>vignettes/ResolvingProblems.Rmd</code></a></small>
      <div class="hidden name"><code>ResolvingProblems.Rmd</code></div>

    </div>

    
    
<div id="sars-2003---using-cumulatives-to-obtain-starting-values-for-mcmc" class="section level2">
<h2 class="hasAnchor">
<a href="#sars-2003---using-cumulatives-to-obtain-starting-values-for-mcmc" class="anchor"></a>SARS 2003 - using cumulatives to obtain starting values for MCMC</h2>
<p>We use the SARS data from 2003 as an example.</p>
<p>In the example below, the sampler would have difficulties converging with the default random starting values of rstan. It usually stays in a part of the parameter space where all of the population gets infected.</p>
<p>Below is one approach how to resolve this. This is at the moment hard-coded. Future versions of epidemia may provide a more convenient way of doing this.</p>
<p>We first fit the model to cumulative counts to get starting values for the main run (the fit to cumulative counts will not be correct itself due an assumed independence of the cumulative counts).</p>
<p>First we load the data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/ImperialCollegeLondon/epidemia">epidemia</a></span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"SARS2003"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span>(mc.cores = <span class="kw">parallel</span>::<span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>())
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw">SARS2003</span>)
</pre></div>
<pre><code>## $incidence
##   [1]   1   0   0   1   0   0   2   0   2   2   1   1   1   0   0   0   4   1
##  [19]   2   4  13  23  35  26  12  17  19  17  28  23  27  27  11  21  21  25
##  [37]  31 103  96  69  58  48  33  25  43  37  30  29  28  34  34  32  24  17
##  [55]  16  23  18  15  11  19  16   9  17  14   6   4   8   9  11  11  11   6
##  [73]  13   3   8   2   4   4   6   4   5   4   8   2   3   2   5   3   3   4
##  [91]   3   1   2   0   1   3   3   1   1   1   1   1   1   1   0   2   0
## 
## $si_distr
##  [1] 0.000 0.001 0.012 0.043 0.078 0.104 0.117 0.116 0.108 0.094 0.078 0.063
## [13] 0.049 0.038 0.028 0.021 0.015 0.011 0.008 0.005 0.004 0.003 0.002 0.001
## [25] 0.001</code></pre>
<p>Then we set up and run the model for cumulative observed cases.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw">sars</span> <span class="op">&lt;-</span> <span class="kw">SARS2003</span>
<span class="kw">sars</span><span class="op">$</span><span class="kw">incidence</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>,<span class="fl">20</span>),<span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span>(<span class="kw">sars</span><span class="op">$</span><span class="kw">incidence</span>)) <span class="co">## pad before initialisation</span>
<span class="kw">sars</span><span class="op">$</span><span class="kw">sarsdate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2003-01-01"</span>)<span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>,along.with=<span class="kw">sars</span><span class="op">$</span><span class="kw">incidence</span>)
<span class="kw">obs</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">sars</span><span class="op">$</span><span class="kw">incidence</span>)

<span class="kw">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(formula=<span class="fu">Rt</span>(<span class="kw">country</span>,<span class="kw">date</span>)<span class="op">~</span><span class="fu">rw</span>(<span class="kw">date</span>,<span class="fl">3</span>),
     data=<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(country=<span class="st">"A"</span>,date=<span class="kw">sars</span><span class="op">$</span><span class="kw">sarsdate</span>),
             obs=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
                 incidence=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
                     odata=<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(country=<span class="st">"A"</span>,
                                      date=<span class="kw">sars</span><span class="op">$</span><span class="kw">sarsdate</span>[<span class="kw">obs</span>],incidence=<span class="kw">sars</span><span class="op">$</span><span class="kw">incidence</span>[<span class="kw">obs</span>]),
                     rates=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(means=<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="st">"A"</span>),<span class="fl">1</span>),
                                scale=<span class="fl">.01</span>),
                     pvec=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.25</span>,<span class="fl">.5</span>,<span class="fl">.75</span>,<span class="fl">1</span>),
                     ptype=<span class="st">"distribution"</span>
                 )
             ),
             seed_days=<span class="fl">7</span>,
             algorithm=<span class="st">"sampling"</span>,
             r0=<span class="fl">3</span>,
             pops=<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(country=<span class="st">"A"</span>,pop=<span class="fl">1e6</span>),
             si=<span class="kw">sars</span><span class="op">$</span><span class="kw">si</span>,
             prior = <span class="kw">rstanarm</span>::<span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(location=<span class="fl">0</span>,scale=<span class="fl">.2</span>),
             prior_intercept = <span class="kw">rstanarm</span>::<span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(location=<span class="fl">0</span>,scale=<span class="fl">.5</span>),
             prior_tau = <span class="kw">rstanarm</span>::<span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">exponential</a></span>(rate=<span class="fl">4</span>)             
     )
</pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">args</span><span class="op">$</span><span class="kw">debug</span><span class="op">=</span><span class="fl">TRUE</span> <span class="co">## to get original parameter values</span>
<span class="kw">args</span><span class="op">$</span><span class="kw">sampling_args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(iter=<span class="fl">100</span>,control=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(adapt_delta=<span class="fl">0.95</span>,max_treedepth=<span class="fl">15</span>),seed=<span class="fl">77239</span>,chains=<span class="fl">1</span>)
<span class="kw">fitpre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>,<span class="kw">args</span>)
</pre></div>
<pre><code>## Warning: The largest R-hat is 1.66, indicating chains have not mixed.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#r-hat</code></pre>
<pre><code>## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
<pre><code>## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
<p>The above run may give some error messages, but they can be ignored as this run is only used to get starting values for the chains of the main run.</p>
<p>Now update the model to work with individually reported cases.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw">sars</span> <span class="op">&lt;-</span> <span class="kw">SARS2003</span>
<span class="kw">sars</span><span class="op">$</span><span class="kw">incidence</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>,<span class="fl">20</span>),<span class="kw">sars</span><span class="op">$</span><span class="kw">incidence</span>) <span class="co">## pad before initialisation</span>
<span class="kw">sars</span><span class="op">$</span><span class="kw">sarsdate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2003-01-01"</span>)<span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>,along.with=<span class="kw">sars</span><span class="op">$</span><span class="kw">incidence</span>)
<span class="kw">obs</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">sars</span><span class="op">$</span><span class="kw">incidence</span>)
<span class="kw">args</span><span class="op">$</span><span class="kw">obs</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    incidence=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
        odata=<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(country=<span class="st">"A"</span>,
                         date=<span class="kw">sars</span><span class="op">$</span><span class="kw">sarsdate</span>[<span class="kw">obs</span>],incidence=<span class="kw">sars</span><span class="op">$</span><span class="kw">incidence</span>[<span class="kw">obs</span>]),
        rates=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(means=<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="st">"A"</span>),<span class="fl">1</span>),
                   scale=<span class="fl">.01</span>),
        pvec=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.25</span>,<span class="fl">.25</span>,<span class="fl">.25</span>,<span class="fl">.25</span>),
        ptype=<span class="st">"density"</span>
    )
)
</pre></div>
<p>Next we prepare the initialisation values. This is very crude at the moment and better ways probably do exist.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="kw">initf</span> <span class="op">&lt;-</span> <span class="fu">function</span>(){
    <span class="kw">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,<span class="fl">1</span>)
    <span class="kw">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="kw">rstan</span>::<span class="fu"><a href="https://rdrr.io/pkg/rstan/man/stanfit-method-extract.html">extract</a></span>(<span class="kw">fitpre</span><span class="op">$</span><span class="kw">stanfit</span>),
                  <span class="fu">function</span>(<span class="kw">x</span>) {
                      <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="kw">x</span>))<span class="op">==</span><span class="fl">1</span>){
                          <span class="fu"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(<span class="kw">x</span>[<span class="kw">i</span>])
                      }
                      <span class="co">else</span> <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="kw">x</span>))<span class="op">==</span><span class="fl">2</span>)
                          <span class="kw">x</span>[<span class="kw">i</span>,]
                      <span class="co">else</span> <span class="kw">x</span>[<span class="kw">i</span>,,]
                  }
                  )
    <span class="co">for</span> (<span class="kw">j</span> <span class="co">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">res</span>)){
        <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">res</span>[<span class="kw">j</span>])<span class="op">==</span><span class="fl">1</span>)
            <span class="kw">res</span>[[<span class="kw">j</span>]] <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(<span class="kw">res</span>[[<span class="kw">j</span>]])
    }
    <span class="kw">res</span><span class="op">$</span><span class="kw">tau_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">res</span><span class="op">$</span><span class="kw">tau_raw</span>)
    <span class="kw">res</span><span class="op">$</span><span class="kw">noise</span><span class="op">&lt;-</span> <span class="kw">NULL</span>
    <span class="kw">res</span>
}
<span class="kw">args</span><span class="op">$</span><span class="kw">sampling_args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(iter=<span class="fl">1000</span>,control=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(adapt_delta=<span class="fl">0.95</span>,max_treedepth=<span class="fl">15</span>),seed=<span class="fl">713</span>,init=<span class="kw">initf</span>)
</pre></div>
<p>Now we starte the main sampling run.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="kw">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>,<span class="kw">args</span>)
</pre></div>
<p>And here are the resulting fits.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">gridExtra</span>)
<span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="fu">plot_rt</span>(<span class="kw">fit</span>),
             <span class="fu">plot_obs</span>(<span class="kw">fit</span>,<span class="st">"incidence"</span>),
             nrow=<span class="fl">2</span>)
</pre></div>
<p><img src="ResolvingProblems_files/figure-html/SARScumulativeplot-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by James Scott, Axel Gandy, Swapnil Mishra, Juliette Unwin, Seth Flaxman, Samir Bhatt.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
