<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resolving Problems â€¢ epidemia</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Resolving Problems">
<meta property="og:description" content="epidemia">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epidemia</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/IncidenceOnly.html">Modelling of R  with only Incidence data</a>
    </li>
    <li>
      <a href="../articles/ResolvingProblems.html">Resolving Problems</a>
    </li>
    <li>
      <a href="../articles/TimeDependentR.html">Time-dependent Modelling of R</a>
    </li>
    <li>
      <a href="../articles/introduction.html">Flexible Epidemic Modeling with epidemia</a>
    </li>
    <li>
      <a href="../articles/plotting.html">Plotting with epidemia</a>
    </li>
    <li>
      <a href="../articles/priors.html">Using Prior Distributions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ImperialCollegeLondon/epidemia/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="ResolvingProblems_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Resolving Problems</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ImperialCollegeLondon/epidemia/blob/master/vignettes/ResolvingProblems.Rmd"><code>vignettes/ResolvingProblems.Rmd</code></a></small>
      <div class="hidden name"><code>ResolvingProblems.Rmd</code></div>

    </div>

    
    
<div id="sars-2003---using-cumulatives-to-obtain-starting-values-for-mcmc" class="section level2">
<h2 class="hasAnchor">
<a href="#sars-2003---using-cumulatives-to-obtain-starting-values-for-mcmc" class="anchor"></a>SARS 2003 - using cumulatives to obtain starting values for MCMC</h2>
<p>We use the SARS data from 2003 as an example. This is provided in <span class="citation">@EpiEstim</span>.</p>
<p>In the example below, the sampler would have difficulties converging with the default random starting values of rstan. It usually stays in a part of the parameter space where all of the population gets infected.</p>
<p>Below is one approach how to resolve this. This is at the moment hard-coded. Future versions of epidemia may provide a more convenient way of doing this.</p>
<p>We first fit the model to cumulative counts to get starting values for the main run (the fit to cumulative counts will not be correct itself due an assumed independence of the cumulative counts).</p>
<p>First we load the data.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">epidemia</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">EpiEstim</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"SARS2003"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="kw">mc.cores</span> <span class="kw">=</span> <span class="kw pkg">parallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>())
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">SARS2003</span>)</pre></body></html></div>
<pre><code>## $incidence
##   [1]   1   0   0   1   0   0   2   0   2   2   1   1   1   0   0   0   4   1
##  [19]   2   4  13  23  35  26  12  17  19  17  28  23  27  27  11  21  21  25
##  [37]  31 103  96  69  58  48  33  25  43  37  30  29  28  34  34  32  24  17
##  [55]  16  23  18  15  11  19  16   9  17  14   6   4   8   9  11  11  11   6
##  [73]  13   3   8   2   4   4   6   4   5   4   8   2   3   2   5   3   3   4
##  [91]   3   1   2   0   1   3   3   1   1   1   1   1   1   1   0   2   0
## 
## $si_distr
##  [1] 0.000 0.001 0.012 0.043 0.078 0.104 0.117 0.116 0.108 0.094 0.078 0.063
## [13] 0.049 0.038 0.028 0.021 0.015 0.011 0.008 0.005 0.004 0.003 0.002 0.001
## [25] 0.001</code></pre>
<p>Then we set up and run the model for cumulative observed cases.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">sars</span> <span class="kw">&lt;-</span> <span class="no">SARS2003</span>
<span class="no">sars</span>$<span class="no">incidence</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>,<span class="fl">20</span>),<span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span>(<span class="no">sars</span>$<span class="no">incidence</span>)) <span class="co">## pad before initialisation</span>
<span class="no">sars</span>$<span class="no">sarsdate</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2003-01-01"</span>)+<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>,<span class="kw">along.with</span><span class="kw">=</span><span class="no">sars</span>$<span class="no">incidence</span>)
<span class="no">obs</span> <span class="kw">&lt;-</span> !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">sars</span>$<span class="no">incidence</span>)

<span class="no">args</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">formula</span><span class="kw">=</span><span class="fu">Rt</span>(<span class="no">country</span>,<span class="no">date</span>)~ <span class="fu"><a href="../reference/rw.html">rw</a></span>(<span class="kw">time</span><span class="kw">=</span><span class="no">week</span>,<span class="kw">prior_scale</span><span class="kw">=</span><span class="fl">0.1</span>),
     <span class="kw">data</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">country</span><span class="kw">=</span><span class="st">"A"</span>,
                     <span class="kw">date</span><span class="kw">=</span><span class="no">sars</span>$<span class="no">sarsdate</span>,
                     <span class="kw">week</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="no">sars</span>$<span class="no">sarsdate</span>, <span class="st">"%V"</span>)),
             <span class="kw">obs</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
                 <span class="kw">incidence</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
                     <span class="kw">odata</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">country</span><span class="kw">=</span><span class="st">"A"</span>,
                                      <span class="kw">date</span><span class="kw">=</span><span class="no">sars</span>$<span class="no">sarsdate</span>[<span class="no">obs</span>],<span class="kw">incidence</span><span class="kw">=</span><span class="no">sars</span>$<span class="no">incidence</span>[<span class="no">obs</span>]),
                     <span class="kw">rates</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">means</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="st">"A"</span>),<span class="fl">1</span>),
                                <span class="kw">scale</span><span class="kw">=</span><span class="fl">.01</span>),
                     <span class="kw">pvec</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.25</span>,<span class="fl">.5</span>,<span class="fl">.75</span>,<span class="fl">1</span>),
                     <span class="kw">ptype</span><span class="kw">=</span><span class="st">"distribution"</span>
                 )
             ),
             <span class="kw">seed_days</span><span class="kw">=</span><span class="fl">7</span>,
             <span class="kw">algorithm</span><span class="kw">=</span><span class="st">"sampling"</span>,
             <span class="kw">r0</span><span class="kw">=</span><span class="fl">3</span>,
             <span class="kw">pops</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">country</span><span class="kw">=</span><span class="st">"A"</span>,<span class="kw">pop</span><span class="kw">=</span><span class="fl">1e6</span>),
             <span class="kw">si</span><span class="kw">=</span><span class="no">sars</span>$<span class="no">si</span>,
             <span class="kw">prior</span> <span class="kw">=</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">location</span><span class="kw">=</span><span class="fl">0</span>,<span class="kw">scale</span><span class="kw">=</span><span class="fl">.2</span>),
             <span class="kw">prior_intercept</span> <span class="kw">=</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">location</span><span class="kw">=</span><span class="fl">0</span>,<span class="kw">scale</span><span class="kw">=</span><span class="fl">.5</span>),
             <span class="kw">prior_tau</span> <span class="kw">=</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">exponential</a></span>(<span class="kw">rate</span><span class="kw">=</span><span class="fl">4</span>)
     )</pre></body></html></div>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">args</span>$<span class="no">debug</span><span class="kw">=</span><span class="fl">TRUE</span> <span class="co">## to get original parameter values</span>
<span class="no">args</span>$<span class="no">sampling_args</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">iter</span><span class="kw">=</span><span class="fl">100</span>,<span class="kw">control</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">adapt_delta</span><span class="kw">=</span><span class="fl">0.95</span>,<span class="kw">max_treedepth</span><span class="kw">=</span><span class="fl">15</span>),<span class="kw">seed</span><span class="kw">=</span><span class="fl">77239</span>,<span class="kw">chains</span><span class="kw">=</span><span class="fl">1</span>)
<span class="no">fitpre</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>,<span class="no">args</span>)</pre></body></html></div>
<pre><code>## Warning: The largest R-hat is 1.22, indicating chains have not mixed.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#r-hat</code></pre>
<pre><code>## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
<pre><code>## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
<pre><code>## Warning: Markov chains did not converge! Do not analyze results!</code></pre>
<p>The above run may give some error messages, but they can be ignored as this run is only used to get starting values for the chains of the main run.</p>
<p>Now update the model to work with individually reported cases.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">sars</span> <span class="kw">&lt;-</span> <span class="no">SARS2003</span>
<span class="no">sars</span>$<span class="no">incidence</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>,<span class="fl">20</span>),<span class="no">sars</span>$<span class="no">incidence</span>) <span class="co">## pad before initialisation</span>
<span class="no">sars</span>$<span class="no">sarsdate</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2003-01-01"</span>)+<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>,<span class="kw">along.with</span><span class="kw">=</span><span class="no">sars</span>$<span class="no">incidence</span>)
<span class="no">obs</span> <span class="kw">&lt;-</span> !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">sars</span>$<span class="no">incidence</span>)
<span class="no">args</span>$<span class="no">obs</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">incidence</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
        <span class="kw">odata</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">country</span><span class="kw">=</span><span class="st">"A"</span>,
                         <span class="kw">date</span><span class="kw">=</span><span class="no">sars</span>$<span class="no">sarsdate</span>[<span class="no">obs</span>],<span class="kw">incidence</span><span class="kw">=</span><span class="no">sars</span>$<span class="no">incidence</span>[<span class="no">obs</span>]),
        <span class="kw">rates</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">means</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="st">"A"</span>),<span class="fl">1</span>),
                   <span class="kw">scale</span><span class="kw">=</span><span class="fl">.01</span>),
        <span class="kw">pvec</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.25</span>,<span class="fl">.25</span>,<span class="fl">.25</span>,<span class="fl">.25</span>),
        <span class="kw">ptype</span><span class="kw">=</span><span class="st">"density"</span>
    )
)</pre></body></html></div>
<p>Next we prepare the initialisation values. This is very crude at the moment and better ways probably do exist.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">initf</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(){
    <span class="no">i</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">1</span>:<span class="fl">50</span>,<span class="fl">1</span>)
    <span class="no">res</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="kw pkg">rstan</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html">extract</a></span>(<span class="no">fitpre</span>$<span class="no">stanfit</span>),
                  <span class="kw">function</span>(<span class="no">x</span>) {
                      <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="no">x</span>))<span class="kw">==</span><span class="fl">1</span>){
                          <span class="fu"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(<span class="no">x</span>[<span class="no">i</span>])
                      }
                      <span class="kw">else</span> <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="no">x</span>))<span class="kw">==</span><span class="fl">2</span>)
                          <span class="no">x</span>[<span class="no">i</span>,]
                      <span class="kw">else</span> <span class="no">x</span>[<span class="no">i</span>,,]
                  }
                  )
    <span class="kw">for</span> (<span class="no">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">res</span>)){
        <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">res</span>[<span class="no">j</span>])<span class="kw">==</span><span class="fl">1</span>)
            <span class="no">res</span><span class="kw">[[</span><span class="no">j</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(<span class="no">res</span><span class="kw">[[</span><span class="no">j</span>]])
    }
    <span class="no">res</span>$<span class="no">tau_raw</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">res</span>$<span class="no">tau_raw</span>)
    <span class="no">res</span>$<span class="no">noise</span><span class="kw">&lt;-</span> <span class="kw">NULL</span>
    <span class="no">res</span>
}
<span class="no">args</span>$<span class="no">debug</span> <span class="kw">&lt;-</span> <span class="no">F</span>
<span class="no">args</span>$<span class="no">sampling_args</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">iter</span><span class="kw">=</span><span class="fl">1000</span>,<span class="kw">control</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">adapt_delta</span><span class="kw">=</span><span class="fl">0.95</span>,<span class="kw">max_treedepth</span><span class="kw">=</span><span class="fl">15</span>),<span class="kw">seed</span><span class="kw">=</span><span class="fl">713</span>,<span class="kw">init</span><span class="kw">=</span><span class="no">initf</span>)</pre></body></html></div>
<p>Now we starte the main sampling run.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>,<span class="no">args</span>)</pre></body></html></div>
<p>And here are the resulting fits.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">gridExtra</span>)
<span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="fu"><a href="../reference/plot_rt.html">plot_rt</a></span>(<span class="no">fit</span>),
             <span class="fu"><a href="../reference/plot_obs.html">plot_obs</a></span>(<span class="no">fit</span>,<span class="st">"incidence"</span>),
             <span class="kw">nrow</span><span class="kw">=</span><span class="fl">2</span>)</pre></body></html></div>
<p><img src="ResolvingProblems_files/figure-html/SARScumulativeplot-1.png" width="700"></p>
</div>
<div id="collinearity" class="section level2">
<h2 class="hasAnchor">
<a href="#collinearity" class="anchor"></a>Collinearity</h2>
<p>In our experience, a leading cause of pathologies in the model fitting stage is collinearity between the predictors explaining the time-varying reproduction number. This can lead to divergent transitions and long sampling times.</p>
<p>Take the example of modeling the effect of several non-pharmaceutical interventions (NPIs). There are two primary reasons why these effects can be highly confounded. Most obviously, the interventions will often take place in quick succession, and so they will be highly collinear. The second cause is the time distribution from infection to an event - for example a death. This is often such that conditional on observing a death at a particular time, there is a wide range of plausible dates at which the individual was infected. Any effects on the reproduction number from interventions occuring close to one-another will be smoothed over in the death data, and the signal as to which intervention actually had an effect becomes weaker.</p>
<p>One possible remedy for this is to pool the effects over different groups. This incorporates more data to delineate each effect. Another approach is to regularize the problem by using more informative priors. Of course this should be done in a principled manner; for example by using results from previous studies.</p>
<p>In this section, we illustrate this phenomenon with a simulated dataset. The code below simulates death data using an assumed initial reproduction number, and assumed effect sizes for the <code>schools_universities</code> and <code>lockdown</code> NPIs. The aim will be to recover the parameters under which the data was simulated.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"EuropeCovid"</span>)
<span class="no">EuropeCovid</span>$<span class="no">data</span>[<span class="no">EuropeCovid</span>$<span class="no">data</span>$<span class="no">country</span> <span class="kw">==</span> <span class="st">"France"</span> <span class="kw">&amp;</span> <span class="no">EuropeCovid</span>$<span class="no">data</span>$<span class="no">date</span> <span class="kw">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2020-03-01"</span>), <span class="st">"schools_universities"</span>] <span class="kw">=</span> <span class="fl">1</span>
<span class="no">args</span> <span class="kw">&lt;-</span> <span class="no">EuropeCovid</span>
<span class="no">args</span>$<span class="no">group_subset</span> <span class="kw">&lt;-</span> <span class="st">"France"</span>
<span class="no">args</span>$<span class="no">algorithm</span> <span class="kw">&lt;-</span> <span class="st">"sampling"</span>
<span class="no">args</span>$<span class="no">sampling_args</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1e3</span>, <span class="kw">seed</span><span class="kw">=</span><span class="fl">12345</span>)
<span class="no">args</span>$<span class="no">formula</span> <span class="kw">&lt;-</span> <span class="fu">R</span>(<span class="no">country</span>, <span class="no">date</span>) ~ <span class="no">schools_universities</span> + <span class="no">lockdown</span>
<span class="no">args</span>$<span class="no">prior_PD</span> <span class="kw">&lt;-</span> <span class="fl">TRUE</span>

<span class="co"># set some reasonable prior values</span>
<span class="no">args</span>$<span class="no">r0</span> <span class="kw">&lt;-</span> <span class="fl">3</span>
<span class="no">args</span>$<span class="no">prior_intercept</span> <span class="kw">&lt;-</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">location</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">scale</span> <span class="kw">=</span> <span class="fl">0.01</span>)
<span class="no">args</span>$<span class="no">prior</span> <span class="kw">&lt;-</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">location</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>,<span class="fl">1.5</span>), <span class="kw">scale</span><span class="kw">=</span><span class="fl">0.01</span>)

<span class="no">fm</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>, <span class="no">args</span>)
<span class="co"># look at prior predictive distribution</span>
<span class="fu"><a href="../reference/plot_rt.html">plot_rt</a></span>(<span class="no">fm</span>)</pre></body></html></div>
<p><img src="ResolvingProblems_files/figure-html/priorSampling-1.png" width="700"> In the above code, we have assumed that the initial reproduction number is close to 3, and have assumed regression parameters for the schools/universities and lockdown NPIs of around 0.5 and 1.5 respectively. Now we simulate daily death counts under this model, which will be used in place of the true death data.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="co"># use posterior data from prior run</span>
<span class="no">obs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstantools/reference/posterior_predict.html">posterior_predict</a></span>(<span class="no">fm</span>, <span class="kw">type</span><span class="kw">=</span><span class="st">"deaths"</span>)$<span class="no">France</span>
<span class="no">dates</span> <span class="kw">&lt;-</span> <span class="no">obs</span>[,<span class="fl">1</span>]
<span class="no">obs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span>(<span class="no">obs</span>[,-<span class="fl">1</span>]))

<span class="co"># replace France deaths data with simulated data</span>
<span class="no">deaths</span> <span class="kw">&lt;-</span> <span class="no">args</span>$<span class="no">obs</span>$<span class="no">deaths</span>
<span class="no">w</span> <span class="kw">&lt;-</span> <span class="no">deaths</span>$<span class="no">odata</span>$<span class="no">country</span> <span class="kw">==</span> <span class="st">"France"</span>
<span class="no">deaths</span>$<span class="no">odata</span> <span class="kw">&lt;-</span> <span class="no">deaths</span>$<span class="no">odata</span>[<span class="no">w</span>,]
<span class="no">deaths</span>$<span class="no">odata</span>$<span class="no">deaths</span> <span class="kw">&lt;-</span> <span class="no">obs</span>
<span class="no">args</span>$<span class="no">obs</span>$<span class="no">deaths</span> <span class="kw">&lt;-</span> <span class="no">deaths</span></pre></body></html></div>
<p>Fitting the model to the simulared data with uninformative priors for the initial reproduction number and effects.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="co"># fit the model with uninformative priors</span>
<span class="no">args</span>$<span class="no">prior_PD</span> <span class="kw">&lt;-</span> <span class="fl">FALSE</span>
<span class="no">args</span>$<span class="no">prior_intercept</span> <span class="kw">&lt;-</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">scale</span><span class="kw">=</span><span class="fl">10</span>)
<span class="no">args</span>$<span class="no">prior</span> <span class="kw">&lt;-</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">scale</span><span class="kw">=</span><span class="fl">10</span>)
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="no">fm2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>, <span class="no">args</span>))</pre></body></html></div>
<pre><code>## Warning: There were 1672 transitions after warmup that exceeded the maximum treedepth. Increase max_treedepth above 10. See
## http://mc-stan.org/misc/warnings.html#maximum-treedepth-exceeded</code></pre>
<pre><code>## Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
<pre><code>## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
<pre><code>##    user  system elapsed 
## 625.683   3.305 194.164</code></pre>
<p>Notice the warnings over exceeding the maximum-tree depath and the long run time. The reason for this will become clear soon. But first we attempt to regularize the problem by assuming more information on the initial reproduction number.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="co"># more informative prior intercept</span>
<span class="no">args</span>$<span class="no">prior_intercept</span> <span class="kw">&lt;-</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">scale</span><span class="kw">=</span><span class="fl">0.5</span>)
<span class="no">args</span>$<span class="no">prior</span> <span class="kw">&lt;-</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">scale</span><span class="kw">=</span><span class="fl">0.5</span>)
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="no">fm3</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"epim"</span>, <span class="no">args</span>))</pre></body></html></div>
<pre><code>##    user  system elapsed 
## 127.408   1.263  41.522</code></pre>
<p>This seems to more computationally stable. As shown below, the problem is caused by posterior correlation between the initial reproduction rate and the effect size of the schools/universities NPI. This NPI occurs before there is much informative data on deaths, and when the number of infections is likely to be quite low. Therefore it is difficult to distinguish whether early on in the disease there was a high reproduction rate and a large effect from the NPI, or a lower initial reproduction rate and a less substantial effect.</p>
<p>We now plot the posterior correlations between these two parameters.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="kw">mfrow</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>))
<span class="no">mat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(<span class="no">fm2</span>)
<span class="no">r0</span> <span class="kw">&lt;-</span> <span class="no">mat</span>[,<span class="fl">1</span>,<span class="st">"(Intercept)"</span>]
<span class="no">schools_universities</span> <span class="kw">&lt;-</span> <span class="no">mat</span>[,<span class="fl">1</span>,<span class="st">"schools_universities"</span>]
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">r0</span>, <span class="no">schools_universities</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"o"</span>)

<span class="no">mat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(<span class="no">fm3</span>)
<span class="no">r0</span> <span class="kw">&lt;-</span> <span class="no">mat</span>[,<span class="fl">1</span>,<span class="st">"(Intercept)"</span>]
<span class="no">schools_universities</span> <span class="kw">&lt;-</span> <span class="no">mat</span>[,<span class="fl">1</span>,<span class="st">"schools_universities"</span>]
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">r0</span>, <span class="no">schools_universities</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"o"</span>)</pre></body></html></div>
<p><img src="ResolvingProblems_files/figure-html/unnamed-chunk-3-1.png" width="700"> The left hand plot shows the posterior distribution from <code>fm2</code>, where less informative priors were used. The divergent transitions appear to be caused by the small step-size required to traverse the distribution horizontally/vertically, and the large step size desired for traversing the diagonal; there is a <em>ridge</em> in the posterior. For more information on why this can pose a problem for Hamiltonian Monte Carlo, please refer to <a href="https://mc-stan.org/docs/2_20/stan-users-guide/collinearity-section.html">the stan user guide</a>. Using stronger prior information reduces the posterior correlation and the sampler explores the space better, as shown in the right hand plot.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">fm2</span>, <span class="kw">digits</span><span class="kw">=</span><span class="fl">2</span>)</pre></body></html></div>
<pre><code>## 
## Rt regression parameters:
## -----
## coefficients:
##                      Median MAD_SD
## (Intercept)          -5.15   4.12 
## schools_universities  5.66   4.12 
## lockdown              1.51   0.16 
## 
## Other model parameters:
## -----
##                      Median MAD_SD
## seeds[France]         2.65   0.80 
## tau                  10.48  10.04 
## phi[deaths]          19.26   3.38 
## noise[France,deaths]  0.99   0.10</code></pre>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">fm3</span>, <span class="kw">digits</span><span class="kw">=</span><span class="fl">2</span>)</pre></body></html></div>
<pre><code>## 
## Rt regression parameters:
## -----
## coefficients:
##                      Median MAD_SD
## (Intercept)          -0.24   0.25 
## schools_universities  0.69   0.29 
## lockdown              1.56   0.15 
## 
## Other model parameters:
## -----
##                      Median MAD_SD
## seeds[France]        20.18   8.14 
## tau                  26.32  19.02 
## phi[deaths]          19.23   3.06 
## noise[France,deaths]  1.00   0.10</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by James Scott, Axel Gandy, Swapnil Mishra, Juliette Unwin, Seth Flaxman, Samir Bhatt.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
